<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI v5.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --navy: #0c1929;
      --navy-light: #162d4a;
      --navy-mid: #1e3a5f;
      --gold: #c8a45e;
      --gold-light: #dbb978;
      --gold-dim: #8a7340;
      --gold-pale: #f5edd8;
      --cream: #faf7f0;
      --white: #fefcf9;
      --red: #c0392b;
      --red-light: #fdf0ee;
      --green: #1a8a5c;
      --green-light: #eef8f3;
      --blue: #2c6fbb;
      --blue-light: #eef4fb;
      --text: #1a1a1a;
      --text-sub: #555;
      --text-dim: #888;
      --text-muted: #bbb;
      --border: #e0dbd0;
      --border-light: #eee9df;
      --shadow: 0 2px 12px rgba(12,25,41,0.08);
      --shadow-lg: 0 8px 32px rgba(12,25,41,0.12);
      --r: 8px;
      --r-sm: 5px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { height: 100vh; overflow: hidden; background: #e8e3d8; }
    body { font-family: 'Noto Sans KR', 'Outfit', sans-serif; color: var(--text); -webkit-font-smoothing: antialiased; }

    .app {
      max-width: 520px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--cream);
      box-shadow: var(--shadow-lg);
    }

    /* â•â•â• HEADER â•â•â• */
    header {
      background: var(--navy);
      color: var(--cream);
      text-align: center;
      padding: 11px 16px;
      position: relative;
      flex-shrink: 0;
    }
    header::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); }
    header h1 { font-family:'Outfit',sans-serif; font-size:1.1rem; font-weight:800; letter-spacing:2.5px; text-transform:uppercase; }
    header .ver { font-family:'JetBrains Mono',monospace; font-size:0.55rem; color:var(--gold); letter-spacing:3px; margin-top:1px; }
    .settings-toggle { position:absolute; top:10px; right:12px; background:none; border:none; color:var(--gold-dim); font-size:18px; cursor:pointer; z-index:5; }

    /* â•â•â• SETTINGS â•â•â• */
    .settings-panel { display:none; padding:12px 16px; background:var(--navy-light); border-bottom:1px solid var(--navy-mid); }
    .settings-panel.open { display:block; }
    .settings-panel label { display:block; font-size:0.58rem; color:var(--gold-dim); margin-bottom:2px; font-weight:600; letter-spacing:0.5px; }
    .settings-panel input { width:100%; padding:7px 10px; border:1px solid var(--navy-mid); border-radius:var(--r-sm); background:var(--navy); color:var(--cream); font-size:0.7rem; font-family:'JetBrains Mono',monospace; margin-bottom:6px; outline:none; }
    .settings-panel input:focus { border-color:var(--gold); }
    .settings-panel input::placeholder { color:#445566; }
    .settings-row { display:grid; grid-template-columns:2fr 1fr; gap:6px; }

    /* â•â•â• SUMMARY BAR â•â•â• */
    .summary-bar { display:none; background:var(--navy); padding:5px 16px; font-size:0.6rem; color:var(--gold-dim); font-weight:500; flex-shrink:0; }
    .summary-bar.visible { display:flex; justify-content:space-between; }
    .summary-bar span { color:var(--gold); font-weight:700; }

    /* â•â•â• CONTENT â•â•â• */
    .content { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }

    .phase { padding:12px 16px; border-bottom:1px solid var(--border-light); }
    .phase-head { display:flex; align-items:center; gap:7px; margin-bottom:8px; }
    .phase-num { width:22px; height:22px; border-radius:50%; background:var(--navy); color:var(--gold); font-family:'Outfit'; font-size:0.65rem; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .phase-title { font-size:0.8rem; font-weight:800; color:var(--navy); }
    .phase-sub { font-size:0.6rem; color:var(--text-dim); font-weight:400; margin-left:4px; }

    /* â•â•â• UPLOAD â•â•â• */
    .upload-area { border:2px dashed var(--border); border-radius:var(--r); padding:18px; text-align:center; cursor:pointer; background:var(--white); transition:all 0.2s; }
    .upload-area:active { background:var(--gold-pale); border-color:var(--gold); }
    .upload-area.loaded { border-style:solid; border-color:var(--green); background:var(--green-light); }
    .upload-icon { font-size:26px; margin-bottom:4px; }
    .upload-text { font-size:0.73rem; color:var(--text-sub); font-weight:600; }
    .upload-hint { font-size:0.6rem; color:var(--text-dim); margin-top:2px; }
    .loaded-info { display:none; font-size:0.72rem; font-weight:700; color:var(--green); }
    .upload-area.loaded .loaded-info { display:block; }
    .upload-area.loaded .upload-icon, .upload-area.loaded .upload-text, .upload-area.loaded .upload-hint { display:none; }

    /* â•â•â• SEARCH â•â•â• */
    .search-bar { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:4px; }
    .search-col label { display:block; font-size:0.55rem; font-weight:700; color:var(--gold-dim); margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px; }
    .search-col input { width:100%; padding:9px 10px; border:1.5px solid var(--border); border-radius:var(--r-sm); font-size:0.82rem; font-family:'Noto Sans KR'; font-weight:600; background:var(--white); color:var(--text); outline:none; transition:border-color 0.2s; }
    .search-col input:focus { border-color:var(--navy); }
    .search-col input::placeholder { color:var(--text-muted); font-weight:400; }
    .search-hint { font-size:0.58rem; color:var(--text-muted); margin-bottom:6px; }

    /* â•â•â• RESULTS (ìë™í‘œì‹œ ì¹´ë“œí˜•) â•â•â• */
    .results-area { display:flex; flex-direction:column; gap:10px; }

    .result-count { font-size:0.65rem; color:var(--text-dim); font-weight:500; margin-bottom:2px; }

    /* â”€â”€â”€ ê°œë³„ ì‘ì—… ì¹´ë“œ â”€â”€â”€ */
    .work-card {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: var(--r);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.2s;
    }
    .work-card.active { border-color: var(--navy); border-width: 2px; }

    .wc-header {
      background: var(--navy);
      color: var(--cream);
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .wc-title { font-size:0.78rem; font-weight:800; }
    .wc-no { font-family:'JetBrains Mono'; font-size:0.6rem; color:var(--gold); }
    .wc-status { font-size:0.55rem; padding:2px 8px; border-radius:20px; font-weight:700; margin-left:6px; }
    .wc-status.empty { background:rgba(192,57,43,0.2); color:#ff6b5e; }
    .wc-status.done { background:rgba(26,138,92,0.2); color:#5cdb95; }

    .wc-body { padding:10px 12px; }

    .wc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
      margin-bottom: 10px;
    }

    .wc-field {
      background: var(--cream);
      border-radius: var(--r-sm);
      padding: 5px 7px;
    }
    .wc-field.full { grid-column: 1 / -1; }
    .wc-field.half { grid-column: span 2; }
    .wc-lbl { font-size:0.5rem; color:var(--gold-dim); font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
    .wc-val { font-size:0.73rem; font-weight:700; color:var(--text); margin-top:1px; }
    .wc-val.memo { font-size:0.65rem; font-weight:500; color:var(--text-sub); line-height:1.4; }

    /* â”€â”€â”€ ì‚¬ì§„ ê·¸ë¦¬ë“œ (ì¹´ë“œ ë‚´ë¶€) â”€â”€â”€ */
    .wc-photos { margin-top:8px; }
    .wc-photos-label { font-size:0.62rem; font-weight:700; color:var(--navy); margin-bottom:5px; display:flex; align-items:center; gap:4px; }

    .photo-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
    }

    .photo-slot {
      border: 2px dashed var(--border);
      border-radius: var(--r-sm);
      aspect-ratio: 3/4;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      background: var(--cream);
      transition: all 0.15s;
    }
    .photo-slot:active { background:var(--gold-pale); border-color:var(--gold); }
    .photo-slot.filled { border-style:solid; border-color:var(--green); }
    .photo-slot .ps-icon { font-size:20px; }
    .photo-slot .ps-label { font-size:0.55rem; font-weight:700; color:var(--text-dim); margin-top:3px; text-align:center; }
    .photo-slot img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:none; z-index:5; }
    .photo-slot.filled .ps-icon, .photo-slot.filled .ps-label { display:none; }
    .photo-slot.filled img { display:block; }
    .photo-delete { display:none; position:absolute; top:3px; right:3px; width:18px; height:18px; border-radius:50%; background:var(--red); color:white; border:none; font-size:10px; font-weight:900; cursor:pointer; z-index:10; line-height:1; align-items:center; justify-content:center; }
    .photo-slot.filled .photo-delete { display:flex; }

    /* â”€â”€â”€ ì¹´ë“œ ë‚´ ì €ì¥ ë²„íŠ¼ â”€â”€â”€ */
    .wc-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    .wc-actions button {
      flex: 1;
      padding: 9px;
      border: none;
      border-radius: var(--r-sm);
      font-family: 'Noto Sans KR';
      font-weight: 800;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .wc-actions button:active { transform:scale(0.97); }
    .wc-save { background:var(--navy); color:var(--gold); }
    .wc-saved { background:var(--green); color:white; }

    /* â•â•â• EMPTY â•â•â• */
    .empty-state { text-align:center; padding:24px 16px; color:var(--text-dim); }
    .empty-state .es-icon { font-size:32px; margin-bottom:6px; }
    .empty-state .es-text { font-size:0.72rem; font-weight:500; line-height:1.6; }

    /* â•â•â• FOOTER â•â•â• */
    footer {
      display:flex; gap:8px; padding:10px 16px; border-top:1px solid var(--border);
      background:var(--white); padding-bottom:calc(10px + env(safe-area-inset-bottom)); flex-shrink:0;
    }
    footer button {
      flex:1; height:46px; border-radius:var(--r); border:none; font-weight:800;
      font-size:0.85rem; cursor:pointer; font-family:'Noto Sans KR'; letter-spacing:0.5px; transition:all 0.15s;
    }
    footer button:active { transform:scale(0.97); }
    .btn-new-main { background:var(--gold); color:var(--navy); }
    .btn-export-main { background:var(--navy); color:var(--gold); }

    /* â•â•â• TOAST â•â•â• */
    .toast { position:fixed; bottom:68px; left:50%; transform:translateX(-50%) translateY(20px); padding:9px 20px; border-radius:var(--r); font-size:0.72rem; font-weight:700; z-index:10000; opacity:0; transition:all 0.3s; pointer-events:none; max-width:90%; text-align:center; white-space:nowrap; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.success { background:var(--green); color:white; }
    .toast.error { background:var(--red); color:white; }
    .toast.info { background:var(--navy); color:var(--gold); }

    /* â•â•â• LOADER â•â•â• */
    #loader { position:fixed; inset:0; background:rgba(12,25,41,0.92); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--cream); }
    .spinner { width:38px; height:38px; border:3px solid var(--navy-mid); border-top-color:var(--gold); border-radius:50%; animation:spin 0.7s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #loader p { margin-top:10px; font-weight:700; font-size:0.8rem; color:var(--gold); }

    /* â•â•â• BTN â•â•â• */
    .btn { padding:9px 14px; border:none; border-radius:var(--r-sm); font-family:'Noto Sans KR'; font-weight:800; font-size:0.72rem; cursor:pointer; transition:all 0.15s; letter-spacing:0.3px; }
    .btn:active { transform:scale(0.97); }
    .btn-outline { background:transparent; color:var(--text-dim); border:1.5px solid var(--border); }
    .btn-gold { background:var(--gold); color:var(--navy); }
    .btn-full { width:100%; }
    .btn-sm { padding:6px 10px; font-size:0.63rem; }

    /* scrollbar */
    .content::-webkit-scrollbar { width:3px; }
    .content::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

    @media (max-width:380px) {
      .search-bar { grid-template-columns:1fr 1fr; }
      .photo-row { grid-template-columns:1fr 1fr; }
    }

    /* hidden file inputs */
    .hidden-inputs { position:absolute; width:0; height:0; overflow:hidden; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loaderText">ì²˜ë¦¬ ì¤‘...</p></div>
<div class="toast" id="toast"></div>

<div class="app">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R &amp; S AI</h1>
    <div class="ver">VER 5.1 Â· FIELD WORK SYSTEM</div>
    <button class="settings-toggle" onclick="App.toggleSettings()">âš™ï¸</button>
  </header>

  <div class="settings-panel" id="settingsPanel">
    <div class="settings-row">
      <div><label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label><input type="text" id="cfgSpreadsheetId" placeholder="Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID"></div>
      <div><label>ì‹œíŠ¸ ì´ë¦„</label><input type="text" id="cfgSheetName" placeholder="ì‹œíŠ¸1" value="ì‹œíŠ¸1"></div>
    </div>
    <label>Apps Script ì›¹ì•± URL</label>
    <input type="text" id="cfgWebAppUrl" placeholder="https://script.google.com/macros/s/.../exec">
    <button class="btn btn-gold btn-sm btn-full" onclick="App.saveSettings()" style="margin-top:2px;">ğŸ’¾ ì„¤ì • ì €ì¥</button>
  </div>

  <div class="summary-bar" id="summaryBar">
    <div>ğŸ“Š ì „ì²´: <span id="totalCount">0</span>ê±´</div>
    <div>ğŸ“¸ ë¯¸ì™„ë£Œ: <span id="incompleteCount">0</span>ê±´</div>
    <div>âœ… ì™„ë£Œ: <span id="completeCount">0</span>ê±´</div>
  </div>

  <main class="content">

    <!-- â‘  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div class="phase" id="phase1">
      <div class="phase-head">
        <span class="phase-num">1</span>
        <span class="phase-title">í•˜ì ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</span>
      </div>
      <div class="upload-area" id="uploadArea" onclick="$('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (.xlsx .xls .csv)</div>
        <div class="upload-hint">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë‹¤ìš´ë°›ì€ íŒŒì¼ë„ ê°€ëŠ¥</div>
        <div class="loaded-info" id="loadedInfo">âœ… <span id="loadedFileName"></span> Â· <span id="loadedRowCount"></span>ê±´</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden onchange="App.loadFile(this)">
      <div style="display:flex; gap:6px; margin-top:6px;">
        <button class="btn btn-outline btn-full" onclick="App.loadSample()" style="font-size:0.65rem;">ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°</button>
        <button class="btn btn-outline btn-full" onclick="App.clearAll()" style="font-size:0.65rem; color:var(--red);">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- â‘¡ ê²€ìƒ‰ â†’ ìë™ ê²°ê³¼ í‘œì‹œ -->
    <div class="phase" id="phase2">
      <div class="phase-head">
        <span class="phase-num">2</span>
        <span class="phase-title">ì‘ì—… ê²€ìƒ‰</span>
        <span class="phase-sub">ì…ë ¥ ì‹œ ìë™ ê²€ìƒ‰</span>
      </div>

      <div class="search-bar">
        <div class="search-col"><label>ë™</label><input type="text" id="sDong" placeholder="101" inputmode="numeric" oninput="App.autoSearch()"></div>
        <div class="search-col"><label>í˜¸</label><input type="text" id="sHo" placeholder="1001" inputmode="numeric" oninput="App.autoSearch()"></div>
        <div class="search-col"><label>ìœ„ì¹˜</label><input type="text" id="sLoc" placeholder="ë°œì½”ë‹ˆ2" oninput="App.autoSearch()"></div>
      </div>
      <div class="search-hint">ë™/í˜¸/ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ì•„ë˜ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</div>

      <div class="result-count" id="resultCount"></div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ = ìë™ìœ¼ë¡œ ì „ì²´ ë‚´ìš© + ì‚¬ì§„ ì…ë ¥ ì¹´ë“œ í‘œì‹œ -->
      <div class="results-area" id="resultsArea">
        <div class="empty-state" id="emptyHint">
          <div class="es-icon">ğŸ”</div>
          <div class="es-text">ë™/í˜¸/ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ë©´<br>í•´ë‹¹ ë¼ì¸ ì „ì²´ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

  </main>

  <footer>
    <button class="btn-new-main" onclick="App.newEntry()">ğŸ”„ ìƒˆë¡œì…ë ¥</button>
    <button class="btn-export-main" onclick="App.exportExcel()">ğŸ“¥ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
  </footer>
</div>

<!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì¸í’‹ë“¤ (ê° ì¹´ë“œë§ˆë‹¤ ë™ì ìœ¼ë¡œ ì‚¬ìš©) -->
<div class="hidden-inputs">
  <input type="file" id="fCapture" accept="image/*" capture="environment" onchange="App.onPhoto(this)">
</div>

<script>
const $ = id => document.getElementById(id);
const STORAGE = { DATA:'METRO_V51_DATA', SETTINGS:'METRO_V51_SET', PHOTOS:'METRO_V51_PHOTOS' };

const App = {
  allData: [],
  colMap: {},
  photos: {},        // { rowIdx: { before:'base64', after:'base64', confirm:'base64' } }
  pendingPhoto: null, // { rowIdx, type }

  // â”€â”€ Init â”€â”€
  init() {
    this.loadSettings();
    this.loadSaved();
    this.updateSummary();
  },

  toast(msg, type='info', ms=2500) {
    const el=$('toast'); el.textContent=msg; el.className=`toast ${type} show`;
    clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'),ms);
  },

  // â”€â”€ Settings â”€â”€
  toggleSettings() { $('settingsPanel').classList.toggle('open'); },
  saveSettings() {
    const s = { id:$('cfgSpreadsheetId').value.trim(), sheet:$('cfgSheetName').value.trim(), url:$('cfgWebAppUrl').value.trim() };
    localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(s));
    this.toast('âœ… ì„¤ì • ì €ì¥', 'success');
    this.toggleSettings();
  },
  loadSettings() {
    try { const s=JSON.parse(localStorage.getItem(STORAGE.SETTINGS)||'{}'); if(s.id)$('cfgSpreadsheetId').value=s.id; if(s.sheet)$('cfgSheetName').value=s.sheet; if(s.url)$('cfgWebAppUrl').value=s.url; } catch(e){}
  },
  getSettings() { try{return JSON.parse(localStorage.getItem(STORAGE.SETTINGS)||'{}');}catch{return{};} },

  // â”€â”€ File Load â”€â”€
  async loadFile(input) {
    const file = input.files?.[0];
    if (!file) return;
    $('loaderText').textContent = 'íŒŒì¼ ì½ëŠ” ì¤‘...';
    $('loader').style.display = 'flex';
    try {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      if (!json.length) throw new Error('ë¹ˆ íŒŒì¼');
      this.allData = json.map((r,i) => ({...r, _idx:i}));
      this.detectCols(json[0]);
      this.saveData();
      $('uploadArea').classList.add('loaded');
      $('loadedFileName').textContent = file.name;
      $('loadedRowCount').textContent = json.length;
      this.updateSummary();
      this.toast(`âœ… ${json.length}ê±´ ë¡œë“œ!`, 'success');
    } catch(err) { this.toast('âŒ íŒŒì¼ ì˜¤ë¥˜: '+err.message, 'error', 4000); }
    $('loader').style.display = 'none';
  },

  detectCols(row) {
    const keys = Object.keys(row);
    const find = (...kw) => keys.find(k => kw.some(w => k.replace(/\s/g,'').includes(w))) || '';
    this.colMap = {
      site: find('í˜„ì¥ëª…','í˜„ì¥','site'),
      no: find('í•˜ìNo','í•˜ìë²ˆí˜¸','No','no','NO','ë²ˆí˜¸'),
      dong: find('ë™','dong'),
      ho: find('í˜¸','ho','í˜¸ìˆ˜'),
      unit: find('ë™í˜¸','ë™/í˜¸','unit','ì„¸ëŒ€'),
      loc: find('ìœ„ì¹˜','ì‹¤ëª…','location','loc'),
      work: find('ê³µì¢…','work','ê³µì‚¬'),
      step: find('ì ‘ìˆ˜ë‹¨ê³„','ë‹¨ê³„','step','ë…„ì°¨'),
      comp: find('ì—…ì²´ëª…','ì—…ì²´','company'),
      name: find('í™•ì¸ì','ë‹´ë‹¹ì','name'),
      memo: find('í•˜ìë‚´ìš©','ë‚´ìš©','memo','ë¹„ê³ ','ìƒì„¸'),
      date: find('ì ‘ìˆ˜ì¼','ë‚ ì§œ','date'),
      imgBefore: find('ì‚¬ì§„ì „','ìˆ˜ë¦¬ì „','before'),
      imgAfter: find('ì‚¬ì§„í›„','ìˆ˜ë¦¬í›„','after'),
      imgConfirm: find('ì™„ë£Œí™•ì¸ì„œ','í™•ì¸ì„œ','confirm','ì„œëª…')
    };
  },

  v(row, f) { const c=this.colMap[f]; return c ? String(row[c]||'').trim() : ''; },

  parseDH(row) {
    let d=this.v(row,'dong'), h=this.v(row,'ho');
    if (!d && !h) {
      const u=this.v(row,'unit');
      const m=u.match(/(\d+)\s*ë™?\s*[-/]?\s*(\d+)\s*í˜¸?/);
      if(m){d=m[1];h=m[2];}
    }
    return {dong:d, ho:h};
  },

  // â”€â”€ ìë™ ê²€ìƒ‰ (ì…ë ¥í•  ë•Œë§ˆë‹¤ ì‹¤í–‰) â”€â”€
  autoSearch() {
    if (!this.allData.length) return;

    const qD = $('sDong').value.trim();
    const qH = $('sHo').value.trim();
    const qL = $('sLoc').value.trim();

    // ì•„ë¬´ê²ƒë„ ì•ˆ ì…ë ¥í–ˆìœ¼ë©´ íŒíŠ¸
    if (!qD && !qH && !qL) {
      $('resultCount').textContent = '';
      $('resultsArea').innerHTML = `<div class="empty-state" id="emptyHint"><div class="es-icon">ğŸ”</div><div class="es-text">ë™/í˜¸/ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ë©´<br>í•´ë‹¹ ë¼ì¸ ì „ì²´ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤</div></div>`;
      return;
    }

    const filtered = this.allData.filter(row => {
      const {dong, ho} = this.parseDH(row);
      const loc = this.v(row,'loc');
      let ok = true;
      if (qD) ok = ok && dong.includes(qD);
      if (qH) ok = ok && ho.includes(qH);
      if (qL) ok = ok && loc.includes(qL);
      return ok;
    });

    $('resultCount').textContent = `ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`;

    if (!filtered.length) {
      $('resultsArea').innerHTML = `<div class="empty-state"><div class="es-icon">ğŸ˜•</div><div class="es-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>`;
      return;
    }

    // â”€â”€ ê° í•­ëª©ì„ ì „ì²´ ë‚´ìš© ì¹´ë“œë¡œ ë Œë”ë§ â”€â”€
    $('resultsArea').innerHTML = filtered.map(row => this.renderCard(row)).join('');
  },

  // â”€â”€ ì¹´ë“œ ë Œë”ë§ (ì „ì²´ ë‚´ìš© + ì‚¬ì§„ ì…ë ¥) â”€â”€
  renderCard(row) {
    const idx = row._idx;
    const {dong, ho} = this.parseDH(row);
    const p = this.photos[idx] || {};
    const photoCount = [p.before, p.after, p.confirm].filter(Boolean).length;
    const isDone = photoCount === 3;
    const statusHtml = isDone
      ? `<span class="wc-status done">âœ… ì™„ë£Œ</span>`
      : `<span class="wc-status empty">ğŸ“· ${photoCount}/3</span>`;

    const photoSlot = (type, label, icon) => {
      const src = p[type] || '';
      const filled = src ? 'filled' : '';
      return `
        <div class="photo-slot ${filled}" onclick="App.capturePhoto(${idx},'${type}')">
          <span class="ps-icon">${icon}</span>
          <span class="ps-label">${label}</span>
          <img src="${src}" ${src?'style="display:block"':''}>
          <button class="photo-delete" onclick="event.stopPropagation();App.delPhoto(${idx},'${type}')">âœ•</button>
        </div>`;
    };

    return `
    <div class="work-card ${isDone?'':'active'}" id="card-${idx}">
      <div class="wc-header">
        <div>
          <span class="wc-title">${dong?dong+'ë™ ':''}${ho?ho+'í˜¸ ':''}${this.v(row,'loc')}</span>
          ${statusHtml}
        </div>
        <span class="wc-no">${this.v(row,'no')?'No.'+this.v(row,'no'):''}</span>
      </div>
      <div class="wc-body">
        <div class="wc-grid">
          <div class="wc-field"><div class="wc-lbl">í˜„ì¥ëª…</div><div class="wc-val">${this.v(row,'site')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">ë™/í˜¸ìˆ˜</div><div class="wc-val">${dong||'-'}ë™ ${ho||'-'}í˜¸</div></div>
          <div class="wc-field"><div class="wc-lbl">ìœ„ì¹˜</div><div class="wc-val">${this.v(row,'loc')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">ê³µì¢…</div><div class="wc-val">${this.v(row,'work')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">ì ‘ìˆ˜ë‹¨ê³„</div><div class="wc-val">${this.v(row,'step')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">ì—…ì²´ëª…</div><div class="wc-val">${this.v(row,'comp')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">ì ‘ìˆ˜ì¼</div><div class="wc-val">${this.v(row,'date')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">í™•ì¸ì</div><div class="wc-val">${this.v(row,'name')||'-'}</div></div>
          <div class="wc-field"><div class="wc-lbl">í•˜ìNo</div><div class="wc-val">${this.v(row,'no')||'-'}</div></div>
          <div class="wc-field full"><div class="wc-lbl">í•˜ìë‚´ìš©</div><div class="wc-val memo">${this.v(row,'memo')||'-'}</div></div>
        </div>

        <div class="wc-photos">
          <div class="wc-photos-label">ğŸ“¸ ì‚¬ì§„ ì…ë ¥ (í„°ì¹˜í•˜ì—¬ ì´¬ì˜/ê°¤ëŸ¬ë¦¬)</div>
          <div class="photo-row">
            ${photoSlot('before','ìˆ˜ë¦¬ ì „','ğŸ“·')}
            ${photoSlot('after','ìˆ˜ë¦¬ í›„','ğŸ“·')}
            ${photoSlot('confirm','ì™„ë£Œí™•ì¸ì„œ','ğŸ“‹')}
          </div>
        </div>

        <div class="wc-actions">
          <button class="${isDone?'wc-saved':'wc-save'}" onclick="App.saveCard(${idx})">
            ${isDone?'âœ… ì €ì¥ ì™„ë£Œ':'ğŸ’¾ ì´ í•­ëª© ì €ì¥'}
          </button>
        </div>
      </div>
    </div>`;
  },

  // â”€â”€ ì‚¬ì§„ ì´¬ì˜ â”€â”€
  capturePhoto(rowIdx, type) {
    this.pendingPhoto = { rowIdx, type };
    $('fCapture').value = '';
    $('fCapture').click();
  },

  onPhoto(input) {
    const file = input.files?.[0];
    if (!file || !this.pendingPhoto) return;
    const { rowIdx, type } = this.pendingPhoto;

    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const maxW = 1200;
        const scale = img.width > maxW ? maxW / img.width : 1;
        const cvs = document.createElement('canvas');
        cvs.width = img.width * scale;
        cvs.height = img.height * scale;
        cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
        const b64 = cvs.toDataURL('image/jpeg', 0.8);

        if (!this.photos[rowIdx]) this.photos[rowIdx] = {};
        this.photos[rowIdx][type] = b64;
        this.savePhotos();
        this.updateSummary();

        // í•´ë‹¹ ì¹´ë“œë§Œ ì—…ë°ì´íŠ¸
        this.refreshCard(rowIdx);
        this.toast('âœ… ì‚¬ì§„ ì €ì¥', 'success', 1500);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  },

  delPhoto(rowIdx, type) {
    if (this.photos[rowIdx]) {
      delete this.photos[rowIdx][type];
      if (!Object.keys(this.photos[rowIdx]).length) delete this.photos[rowIdx];
      this.savePhotos();
    }
    this.refreshCard(rowIdx);
    this.updateSummary();
  },

  // â”€â”€ ê°œë³„ ì¹´ë“œ ìƒˆë¡œê³ ì¹¨ â”€â”€
  refreshCard(rowIdx) {
    const cardEl = document.getElementById(`card-${rowIdx}`);
    if (!cardEl) return;
    const row = this.allData[rowIdx];
    if (!row) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = this.renderCard(row);
    cardEl.replaceWith(tmp.firstElementChild);
  },

  // â”€â”€ ê°œë³„ ì €ì¥ â”€â”€
  async saveCard(rowIdx) {
    const p = this.photos[rowIdx];
    if (!p || !Object.keys(p).length) return this.toast('ìµœì†Œ 1ì¥ì˜ ì‚¬ì§„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

    const row = this.allData[rowIdx];
    const cm = this.colMap;
    if (cm.imgBefore) row[cm.imgBefore] = p.before ? 'âœ…' : '';
    if (cm.imgAfter) row[cm.imgAfter] = p.after ? 'âœ…' : '';
    if (cm.imgConfirm) row[cm.imgConfirm] = p.confirm ? 'âœ…' : '';
    this.saveData();

    // ì„œë²„ ì „ì†¡ ì‹œë„
    const settings = this.getSettings();
    if (settings.url) {
      try {
        await fetch(settings.url, {
          method: 'POST', mode: 'no-cors',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action:'update', rowIndex:rowIdx+2, data:row, photos:p })
        });
      } catch(e) {}
    }

    this.refreshCard(rowIdx);
    this.updateSummary();
    this.toast('âœ… ì €ì¥ ì™„ë£Œ!', 'success');
  },

  // â”€â”€ ìƒˆë¡œì…ë ¥ â”€â”€
  newEntry() {
    $('sDong').value = '';
    $('sHo').value = '';
    $('sLoc').value = '';
    $('resultCount').textContent = '';
    $('resultsArea').innerHTML = `<div class="empty-state"><div class="es-icon">ğŸ”</div><div class="es-text">ë™/í˜¸/ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ë©´<br>í•´ë‹¹ ë¼ì¸ ì „ì²´ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤</div></div>`;
    document.querySelector('.content').scrollTo({top:0,behavior:'smooth'});
    $('sDong').focus();
    this.toast('ìƒˆ ì‘ì—…ì„ ê²€ìƒ‰í•˜ì„¸ìš”', 'info');
  },

  // â”€â”€ ì—‘ì…€ ë‚´ë³´ë‚´ê¸° â”€â”€
  exportExcel() {
    if (!this.allData.length) return this.toast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
    try {
      const clean = this.allData.map(r => { const c={...r}; delete c._idx; return c; });
      const ws = XLSX.utils.json_to_sheet(clean);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'í•˜ìë¦¬ìŠ¤íŠ¸');
      XLSX.writeFile(wb, `ë©”íŠ¸ë¡œ_í•˜ìë¦¬ìŠ¤íŠ¸_${new Date().toISOString().slice(0,10)}.xlsx`);
      this.toast('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
    } catch(e) { this.toast('âŒ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'error'); }
  },

  // â”€â”€ Summary â”€â”€
  updateSummary() {
    if (!this.allData.length) { $('summaryBar').classList.remove('visible'); return; }
    $('summaryBar').classList.add('visible');
    $('totalCount').textContent = this.allData.length;
    let done=0, inc=0;
    this.allData.forEach((_,i) => {
      const p=this.photos[i];
      if(p&&p.before&&p.after&&p.confirm) done++; else inc++;
    });
    $('incompleteCount').textContent = inc;
    $('completeCount').textContent = done;
  },

  // â”€â”€ Storage â”€â”€
  saveData() {
    try {
      const clean = this.allData.map(r => { const c={...r}; return c; });
      localStorage.setItem(STORAGE.DATA, JSON.stringify({data:clean, colMap:this.colMap}));
    } catch(e) {}
  },
  savePhotos() {
    try { localStorage.setItem(STORAGE.PHOTOS, JSON.stringify(this.photos)); }
    catch(e) {
      // ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°
      const keys = Object.keys(this.photos).sort((a,b)=>a-b);
      if(keys.length>3){ delete this.photos[keys[0]]; this.savePhotos(); }
    }
  },
  loadSaved() {
    try {
      const s = JSON.parse(localStorage.getItem(STORAGE.DATA)||'null');
      if(s?.data?.length) {
        this.allData = s.data.map((r,i)=>({...r,_idx:i}));
        this.colMap = s.colMap||{};
        $('uploadArea').classList.add('loaded');
        $('loadedFileName').textContent = 'ì´ì „ ë°ì´í„°';
        $('loadedRowCount').textContent = this.allData.length;
      }
      this.photos = JSON.parse(localStorage.getItem(STORAGE.PHOTOS)||'{}');
    } catch(e){}
  },

  // â”€â”€ ì „ì²´ ì´ˆê¸°í™” â”€â”€
  clearAll() {
    if(!confirm('ëª¨ë“  ë°ì´í„°ì™€ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    localStorage.removeItem(STORAGE.DATA);
    localStorage.removeItem(STORAGE.PHOTOS);
    location.reload();
  },

  // â”€â”€ ìƒ˜í”Œ â”€â”€
  loadSample() {
    const sample=[];
    const locs=['ê±°ì‹¤','ì•ˆë°©','ì¹¨ì‹¤1','ì¹¨ì‹¤2','ë°œì½”ë‹ˆ1','ë°œì½”ë‹ˆ2','ì•ŒíŒŒë£¸','ì£¼ë°©','í˜„ê´€'];
    const works=['PLì°½í˜¸ê³µì‚¬','ë„ë°°ê³µì‚¬','íƒ€ì¼ê³µì‚¬','ë°”ë‹¥ê³µì‚¬','ì„¤ë¹„ê³µì‚¬'];
    const memos=['ì°½ë¬¸ í‹ˆìƒˆ ë³´ìˆ˜','ë²½ì§€ ë“¤ëœ¸ ìˆ˜ë¦¬','íƒ€ì¼ ê¹¨ì§ êµì²´','ë°”ë‹¥ ê¸í˜ ë³´ìˆ˜','ë°°ìˆ˜ ë¶ˆëŸ‰ ìˆ˜ë¦¬','ë„ë°° ê³°íŒ¡ì´','ë¬¸ì§ ê²½ì²© êµì²´','ì‹¤ë¦¬ì½˜ ì¬ì‹œê³µ'];

    for(let d=101;d<=103;d++) {
      for(let h=1;h<=4;h++) {
        const ho=`${d}${String(h).padStart(2,'0')}`;
        const cnt=1+Math.floor(Math.random()*3);
        for(let c=0;c<cnt;c++) {
          sample.push({
            'í˜„ì¥ëª…':'ì›ì£¼í˜ì‹ C4BL',
            'í•˜ìNo':`H${String(sample.length+1).padStart(4,'0')}`,
            'ë™':String(d),
            'í˜¸':ho,
            'ìœ„ì¹˜':locs[Math.floor(Math.random()*locs.length)],
            'ê³µì¢…':works[Math.floor(Math.random()*works.length)],
            'ì ‘ìˆ˜ë‹¨ê³„':Math.random()>0.5?'1ë…„ì°¨':'2ë…„ì°¨',
            'ì—…ì²´ëª…':'ì§„í¥ê±´ì—…(ì£¼)',
            'í™•ì¸ì':'',
            'í•˜ìë‚´ìš©':memos[Math.floor(Math.random()*memos.length)],
            'ì ‘ìˆ˜ì¼':'2025-02-09',
            'ì‚¬ì§„ì „':'','ì‚¬ì§„í›„':'','ì™„ë£Œí™•ì¸ì„œ':''
          });
        }
      }
    }
    this.allData=sample.map((r,i)=>({...r,_idx:i}));
    this.detectCols(sample[0]);
    this.photos={};
    this.saveData();
    localStorage.removeItem(STORAGE.PHOTOS);
    $('uploadArea').classList.add('loaded');
    $('loadedFileName').textContent='ìƒ˜í”Œ';
    $('loadedRowCount').textContent=sample.length;
    this.updateSummary();
    this.toast(`âœ… ìƒ˜í”Œ ${sample.length}ê±´ ë¡œë“œ!`,'success');
  }
};

window.onload = () => App.init();
</script>
</body>
</html>
