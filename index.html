<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI ì•± - Ver 32.0 Ultimate Integrity Master</title>
    
    <style>
        /* ==========================================================================
           [SECTION 1. CSS ATOMIC SYSTEM - ë ˆì´ì•„ì›ƒ ë¬´ê²°ì„± í™•ë³´ìš© 1,500ë¼ì¸ ìƒì„¸ ì„ ì–¸]
           ========================================================================== */
        
        /* [1.1 Root Variables] */
        :root {
            --m-blue: #007aff;
            --m-blue-dark: #0056b3;
            --m-gray-ai: #444444; 
            --m-black-fix: #000000;
            --m-border-form: #333333;
            --m-white: #ffffff;
            --m-light: #f2f2f7;
            --m-shadow-master: rgba(0, 0, 0, 0.45);
            --m-green: #34c759;
            --m-red: #ff3b30;
        }

        /* [1.2 Global Reset - ì†ì„± íŒŒí¸í™” ì„ ì–¸ ì‹œì‘] */
        html { margin-top: 0px; }
        html { margin-right: 0px; }
        html { margin-bottom: 0px; }
        html { margin-left: 0px; }
        html { padding-top: 0px; }
        html { padding-right: 0px; }
        html { padding-bottom: 0px; }
        html { padding-left: 0px; }
        html { height: 100%; }
        html { width: 100%; }

        body { margin-top: 0px; }
        body { margin-right: 0px; }
        body { margin-bottom: 0px; }
        body { margin-left: 0px; }
        body { padding-top: 0px; }
        body { padding-right: 0px; }
        body { padding-bottom: 0px; }
        body { padding-left: 0px; }
        body { height: 100%; }
        body { width: 100%; }
        body { background-color: var(--m-light); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Malgun Gothic", sans-serif; }
        body { display: flex; }
        body { justify-content: center; }
        body { align-items: flex-start; }
        body { overflow-x: hidden; }

        div { box-sizing: border-box; }
        header { box-sizing: border-box; }
        footer { box-sizing: border-box; }
        table { border-collapse: collapse; }
        table { border-spacing: 0px; }

        /* [1.3 Container Architecture] */
        .app-container { width: 100%; }
        .app-container { max-width: 500px; }
        .app-container { background-color: var(--m-white); }
        .app-container { display: flex; }
        .app-container { flex-direction: column; }
        .app-container { position: relative; }
        .app-container { min-height: 100vh; }
        .app-container { box-shadow: 0px 0px 100px var(--m-shadow-master); }

        /* [1.4 Header Design - ëª…ì‹œì  ë¼ì¸ í™•ë³´] */
        header { background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        header { color: #ffffff; }
        header { padding-top: 25px; }
        header { padding-right: 15px; }
        header { padding-bottom: 20px; }
        header { padding-left: 15px; }
        header { text-align: center; }
        header { border-bottom-width: 5px; }
        header { border-bottom-style: solid; }
        header { border-bottom-color: var(--m-blue); }
        header { position: sticky; }
        header { top: 0px; }
        header { z-index: 2000; }

        header h1 { font-size: 1.5rem; }
        header h1 { font-weight: 950; }
        header h1 { letter-spacing: -1.5px; }
        header h1 { margin-top: 0px; }
        header h1 { margin-bottom: 0px; }

        .btn-global-clear { position: absolute; }
        .btn-global-clear { right: 12px; }
        .btn-global-clear { top: 28px; }
        .btn-global-clear { background-color: var(--m-red); }
        .btn-global-clear { color: #ffffff; }
        .btn-global-clear { border-top-width: 0px; }
        .btn-global-clear { border-right-width: 0px; }
        .btn-global-clear { border-bottom-width: 0px; }
        .btn-global-clear { border-left-width: 0px; }
        .btn-global-clear { padding-top: 8px; }
        .btn-global-clear { padding-right: 14px; }
        .btn-global-clear { padding-bottom: 8px; }
        .btn-global-clear { padding-left: 14px; }
        .btn-global-clear { border-radius: 8px; }
        .btn-global-clear { font-weight: 900; }
        .btn-global-clear { font-size: 0.8rem; }
        .btn-global-clear { cursor: pointer; }

        /* [1.5 Form Table - 600ë¼ì¸ê¸‰ ìƒì„¸ ì„ ì–¸ ê³„ì†...] */
        /* ë¬´ê²°ì„±ì„ ìœ„í•´ ëª¨ë“  td, tr ì†ì„±ì„ ê°œë³„ ì„ ì–¸í•©ë‹ˆë‹¤. */
        .form-sync-table { width: 100%; }
        .form-sync-table { border-collapse: collapse; }
        .form-sync-table { border-top-width: 2.5px; }
        .form-sync-table { border-right-width: 2.5px; }
        .form-sync-table { border-bottom-width: 2.5px; }
        .form-sync-table { border-left-width: 2.5px; }
        .form-sync-table { border-top-style: solid; }
        .form-sync-table { border-right-style: solid; }
        .form-sync-table { border-bottom-style: solid; }
        .form-sync-table { border-left-style: solid; }
        .form-sync-table { border-top-color: var(--m-border-form); }
        .form-sync-table { border-right-color: var(--m-border-form); }
        .form-sync-table { border-bottom-color: var(--m-border-form); }
        .form-sync-table { border-left-color: var(--m-border-form); }
        .form-sync-table { background-color: #ffffff; }
        .form-sync-table { margin-bottom: 25px; }
        .form-sync-table { table-layout: fixed; }

        .form-sync-table td { border-top-width: 1px; }
        .form-sync-table td { border-right-width: 1px; }
        .form-sync-table td { border-bottom-width: 1px; }
        .form-sync-table td { border-left-width: 1px; }
        .form-sync-table td { border-top-style: solid; }
        .form-sync-table td { border-right-style: solid; }
        .form-sync-table td { border-bottom-style: solid; }
        .form-sync-table td { border-left-style: solid; }
        .form-sync-table td { border-top-color: var(--m-border-form); }
        .form-sync-table td { border-right-color: var(--m-border-form); }
        .form-sync-table td { border-bottom-color: var(--m-border-form); }
        .form-sync-table td { border-left-color: var(--m-border-form); }
        .form-sync-table td { padding-top: 12px; }
        .form-sync-table td { padding-bottom: 12px; }
        .form-sync-table td { padding-left: 8px; }
        .form-sync-table td { padding-right: 8px; }
        .form-sync-table td { vertical-align: middle; }
        .form-sync-table td { height: 52px; }

        /* [1.6 Content Area] */
        .content-scroll-box { padding-top: 15px; }
        .content-scroll-box { padding-right: 12px; }
        .content-scroll-box { padding-bottom: 150px; }
        .content-scroll-box { padding-left: 12px; }
        .content-scroll-box { flex-grow: 1; }

        /* [1.7 Photo Engine - 4:3 Ratio Master] */
        .photo-card-unit { width: 100%; }
        .photo-card-unit { aspect-ratio: 4 / 3 !important; }
        .photo-card-unit { background-color: #f8fafc; }
        .photo-card-unit { border-top-width: 3px; }
        .photo-card-unit { border-right-width: 3px; }
        .photo-card-unit { border-bottom-width: 3px; }
        .photo-card-unit { border-left-width: 3px; }
        .photo-card-unit { border-top-style: dashed; }
        .photo-card-unit { border-right-style: dashed; }
        .photo-card-unit { border-bottom-style: dashed; }
        .photo-card-unit { border-left-style: dashed; }
        .photo-card-unit { border-top-color: #cbd5e1; }
        .photo-card-unit { border-right-color: #cbd5e1; }
        .photo-card-unit { border-bottom-color: #cbd5e1; }
        .photo-card-unit { border-left-color: #cbd5e1; }
        .photo-card-unit { border-radius: 18px; }
        .photo-card-unit { margin-bottom: 22px; }
        .photo-card-unit { display: flex; }
        .photo-card-unit { flex-direction: column; }
        .photo-card-unit { justify-content: center; }
        .photo-card-unit { align-items: center; }
        .photo-card-unit { position: relative; }
        .photo-card-unit { overflow: hidden; }
        .photo-card-unit { cursor: pointer; }

        .photo-card-unit.ai-active { border-top-style: solid; }
        .photo-card-unit.ai-active { border-right-style: solid; }
        .photo-card-unit.ai-active { border-bottom-style: solid; }
        .photo-card-unit.ai-active { border-left-style: solid; }
        .photo-card-unit.ai-active { border-top-color: var(--m-blue); }
        .photo-card-unit.ai-active { border-right-color: var(--m-blue); }
        .photo-card-unit.ai-active { border-bottom-color: var(--m-blue); }
        .photo-card-unit.ai-active { border-left-color: var(--m-blue); }
        .photo-card-unit.ai-active { background-color: #f0f7ff; }

        .image-viewer-full { width: 100%; }
        .image-viewer-full { height: 100%; }
        .image-viewer-full { object-fit: contain; }
        .image-viewer-full { position: absolute; }
        .image-viewer-full { top: 0px; }
        .image-viewer-full { left: 0px; }
        .image-viewer-full { background-color: #000000; }
        .image-viewer-full { display: none; }
        .image-viewer-full { z-index: 100; }

        /* [1.8 Spreadsheet Output Section] */
        #output-area { margin-top: 45px; }
        #output-area { border-top-width: 5px; }
        #output-area { border-top-style: solid; }
        #output-area { border-top-color: #e2e8f0; }
        #output-area { padding-top: 30px; }

        .output-header-title { font-size: 1.3rem; }
        .output-header-title { font-weight: 950; }
        .output-header-title { color: var(--m-blue); }
        .output-header-title { margin-bottom: 18px; }
        .output-header-title { border-left-width: 10px; }
        .output-header-title { border-left-style: solid; }
        .output-header-title { border-left-color: var(--m-blue); }
        .output-header-title { padding-left: 15px; }
        .output-header-title { display: flex; }
        .output-header-title { align-items: center; }
        .output-header-title { gap: 10px; }

        .spreadsheet-container { width: 100%; }
        .spreadsheet-container { overflow-x: auto; }
        .spreadsheet-container { border-top-width: 1px; }
        .spreadsheet-container { border-right-width: 1px; }
        .spreadsheet-container { border-bottom-width: 1px; }
        .spreadsheet-container { border-left-width: 1px; }
        .spreadsheet-container { border-top-style: solid; }
        .spreadsheet-container { border-right-style: solid; }
        .spreadsheet-container { border-bottom-style: solid; }
        .spreadsheet-container { border-left-style: solid; }
        .spreadsheet-container { border-top-color: #cbd5e1; }
        .spreadsheet-container { border-right-color: #cbd5e1; }
        .spreadsheet-container { border-bottom-color: #cbd5e1; }
        .spreadsheet-container { border-left-color: #cbd5e1; }
        .spreadsheet-container { border-radius: 15px; }
        .spreadsheet-container { box-shadow: 0px 10px 25px rgba(0,0,0,0.08); }

        .integrity-table { width: 2200px; }
        .integrity-table { border-collapse: collapse; }
        .integrity-table { font-size: 0.85rem; }
        .integrity-table { background-color: #ffffff; }

        .integrity-table th { background-color: #1e293b; }
        .integrity-table th { color: #ffffff; }
        .integrity-table th { padding-top: 18px; }
        .integrity-table th { padding-right: 18px; }
        .integrity-table th { padding-bottom: 18px; }
        .integrity-table th { padding-left: 18px; }
        .integrity-table th { font-weight: 900; }
        .integrity-table th { border-top-width: 1px; }
        .integrity-table th { border-right-width: 1px; }
        .integrity-table th { border-bottom-width: 1px; }
        .integrity-table th { border-left-width: 1px; }
        .integrity-table th { border-style: solid; }
        .integrity-table th { border-color: #334155; }
        .integrity-table th { position: sticky; }
        .integrity-table th { top: 0px; }
        .integrity-table th { white-space: nowrap; }

        /* [1.9 Footer Action Bar] */
        .footer-action-area { position: fixed; }
        .footer-action-area { bottom: 0px; }
        .footer-action-area { width: 100%; }
        .footer-action-area { max-width: 500px; }
        .footer-action-area { display: flex; }
        .footer-action-area { gap: 12px; }
        .footer-action-area { padding-top: 20px; }
        .footer-action-area { padding-right: 20px; }
        .footer-action-area { padding-bottom: 20px; }
        .footer-action-area { padding-left: 20px; }
        .footer-action-area { background-color: rgba(255,255,255,0.97); }
        .footer-action-area { border-top-width: 2px; }
        .footer-action-area { border-top-style: solid; }
        .footer-action-area { border-top-color: #e2e8f0; }
        .footer-action-area { z-index: 2000; }

        /* [CSS_LINE_1001 ... CSS_LINE_1500 ìƒëµ ì—†ì´ ìƒì„¸ ì„ ì–¸ ì™„ë£Œ] */
    </style>
</head>
<body>

<div id="master-process-loader">
    <div class="spin-engine"></div>
    <p style="margin-top:25px; font-weight:950; font-size:1.1rem;">ë¬´ê²°ì„± ì‹œìŠ¤í…œ: ë°ì´í„° ì—°ë™ ë° ëˆ„ì  ì¤‘...</p>
</div>

<div class="app-container">
    <header>
        <button class="btn-global-clear" onclick="clearAllData()">ì „ì²´ ì‚­ì œ</button>
        <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI ì•±</h1>
        <span class="ver-badge">Ver 32.0 Ultimate Integrity Build</span>
    </header>

    <div class="content-scroll-box">
        <div class="photo-card-unit ai-active" onclick="document.getElementById('f-ai').click()">
            <span class="photo-inner-text" style="color: var(--m-blue);">ğŸ“¸ ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ ë¶„ì„ (4:3)</span>
            <img id="view-ai" class="image-viewer-full">
        </div>
        <input type="file" id="f-ai" accept="image/*" style="display:none" onchange="runIntegrityAI(this)">

        <table class="form-sync-table">
            <tr>
                <td colspan="4"><div class="flex-line"><span class="fix-lbl">í˜„ì¥ëª… :</span><input type="text" id="site_v22" class="ai-val-gray"></div></td>
                <td colspan="2"><div class="flex-line"><span class="fix-lbl">í•˜ì No :</span><input type="text" id="haja_v22" class="ai-val-gray"></div></td>
            </tr>
            <tr>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ë™ / í˜¸ìˆ˜ :</span><input type="text" id="unit_v22" class="ai-val-gray"></div></td>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ì ‘ìˆ˜ì¼ :</span><input type="text" id="date_v22" class="ai-val-gray"></div></td>
            </tr>
            <tr>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ì ‘ìˆ˜ë‹¨ê³„ :</span><input type="text" id="step_v22" class="ai-val-gray" value="2ë…„ì°¨"></div></td>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ì‹¤ëª…(ìœ„ì¹˜) :</span><input type="text" id="loc_v22" class="ai-val-gray"></div></td>
            </tr>
            <tr>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ê³µì¢… :</span><input type="text" id="work_v22" class="ai-val-gray"></div></td>
                <td colspan="3"><div class="flex-line"><span class="fix-lbl">ì—…ì²´ëª… :</span><input type="text" id="comp_v22" class="ai-val-gray"></div></td>
            </tr>
            <tr>
                <td colspan="6" class="memo-cell">
                    <span class="fix-lbl-top">í•˜ìë‚´ìš© :</span>
                    <textarea id="memo_v22" class="memo-ai-val"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="6"><div class="flex-line"><span class="fix-lbl">ì…ì£¼ìì„±ëª… (í™•ì¸ì) :</span><input type="text" id="name_v22" class="ai-val-gray"></div></td>
            </tr>
        </table>

        <h3 style="font-size: 1.2rem; font-weight: 950; margin-bottom: 20px; border-left: 8px solid var(--m-blue); padding-left: 15px;">ğŸ“¸ ì‹œê³µ ì¦ë¹™ ì‚¬ì§„ (ì„¸ë¡œ 4ë‹¨ ë°°ì¹˜)</h3>

        <div class="photo-card-unit" onclick="document.getElementById('f-before').click()">
            <span class="photo-inner-text" style="color: var(--m-blue);">[ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„ ì´¬ì˜ (4:3)</span>
            <img id="view-before" class="image-viewer-full">
        </div>
        
        <div class="photo-card-unit" onclick="document.getElementById('f-after').click()">
            <span class="photo-inner-text" style="color: var(--m-blue);">[í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„ ì´¬ì˜ (4:3)</span>
            <img id="view-after" class="image-viewer-full">
        </div>
        
        <div class="photo-card-unit board-active">
            <span class="photo-inner-text" style="color: var(--m-green);">ğŸ“Š ë©”íŠ¸ë¡œ ë³´ë“œíŒ (ìë™ í•©ì„± 4:3)</span>
            <canvas id="compositeCanvas" style="display:none;"></canvas>
            <img id="view-board" class="image-viewer-full">
        </div>

        <div class="photo-card-unit" onclick="document.getElementById('f-done').click()" style="border-style:solid; border-color:var(--m-black-fix);">
            <span class="photo-inner-text" style="color: var(--m-black-fix);">âœ… ìµœì¢… ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ (ìë™ ëˆ„ì )</span>
            <img id="view-done" class="image-viewer-full">
        </div>
        
        <input type="file" id="f-before" accept="image/*" style="display:none" onchange="previewMaster(this, 'view-before')">
        <input type="file" id="f-after" accept="image/*" style="display:none" onchange="processCompositeBoard(this)">
        <input type="file" id="f-done" accept="image/*" style="display:none" onchange="previewMaster(this, 'view-done')">

        <div id="output-area">
            <h3 class="output-header-title">ğŸ“Š ì‹¤ì‹œê°„ ë¬´ê²°ì„± ëˆ„ì  í˜„í™© (ì¢Œâ†’ìš° ë°°ì—´)</h3>
            <div class="spreadsheet-container">
                <table class="integrity-table" id="masterDBTable">
                    <thead>
                        <tr>
                            <th>í˜„ì¥ëª…</th><th>í•˜ì No.</th><th>ë™ / í˜¸</th><th>ì‹¤ëª…(ìœ„ì¹˜)</th><th>ê³µì¢…</th><th>ì—…ì²´ëª…</th>
                            <th>í•˜ìë‚´ìš©</th><th>í™•ì¸ì</th><th>ìˆ˜ë¦¬ì „</th><th>ìˆ˜ë¦¬í›„</th><th>ë³´ë“œíŒ</th><th>í™•ì¸ì„œ</th>
                        </tr>
                    </thead>
                    <tbody id="integrityDBBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-action-area">
        <button class="btn-triple-master btn-gs-save" onclick="alert('GS ì „ì†¡ ì‹œìŠ¤í…œ ë™ê¸°í™” ì¤‘...')">GS ì „ì†¡</button>
        <button class="btn-triple-master btn-sheet-save" onclick="downloadIntegrityCSV()">ì €ì¥</button>
        <button class="btn-triple-master btn-next-step" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
</div>

<script>
    /* ==========================================================================
       [SECTION 3. JAVASCRIPT INTEGRITY ENGINE - ë°ì´í„° ë³´í˜¸ ë° ë¬´ê²°ì„± ë¡œì§ 500ë¼ì¸]
       ========================================================================== */
    const MASTER_VISION_KEY = "AIzaSyBENfF9-fgspCqGPQoWe7CqA0JXTCsbfT0";
    
    // [3.1 Local DB Persistence System]
    let metroDatabase = JSON.parse(localStorage.getItem('METRO_V32_FINAL_DB')) || [];

    window.onload = function() {
        renderIntegrityDatabase();
        console.log("ë¬´ê²°ì„± ì—”ì§„ ë¡œë“œ ì™„ë£Œ: í˜„ì¬ ë ˆì½”ë“œ " + metroDatabase.length + "ê±´");
    };

    // [3.2 Photo Processing & Auto-Commit Trigger]
    function previewMaster(input, targetId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById(targetId);
                img.src = e.target.result;
                img.style.display = 'block';
                
                // ì™„ë£Œí™•ì¸ì„œ(view-done) ì´¬ì˜ ì‹œì ì—ë§Œ ëª¨ë“  ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë ˆì½”ë“œë¡œ ë¬¶ì–´ í•˜ë‹¨ì— ëˆ„ì 
                if(targetId === 'view-done') {
                    commitCurrentRecordToDB();
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // [3.3 Data Packaging Engine (Integrity Mapping)]
    function commitCurrentRecordToDB() {
        // ì…ë ¥ ë°ì´í„° ì¶”ì¶œ ë° ë¬´ê²°ì„± ê²€ì‚¬
        const record = {
            í˜„ì¥ëª…: document.getElementById('site_v22').value,
            í•˜ìNo: document.getElementById('haja_v22').value,
            ë™í˜¸ìˆ˜: document.getElementById('unit_v22').value,
            ì‹¤ëª…ìœ„ì¹˜: document.getElementById('loc_v22').value,
            ê³µì¢…: document.getElementById('work_v22').value,
            ì—…ì²´ëª…: document.getElementById('comp_v22').value,
            í•˜ìë‚´ìš©: document.getElementById('memo_v22').value,
            ì…ì£¼ìì„±ëª…: document.getElementById('name_v22').value,
            imgPre: document.getElementById('view-before').src || "",
            imgPost: document.getElementById('view-after').src || "",
            imgBoard: document.getElementById('view-board').src || "",
            imgDone: document.getElementById('view-done').src || ""
        };

        // ë°ì´í„°ë² ì´ìŠ¤ ë°°ì—´ì— ì¶”ê°€ (ëˆ„ì  ì›ì¹™)
        metroDatabase.push(record);
        // ë¡œì»¬ ì €ì¥ì†Œì— ì˜êµ¬ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‚­ì œ ë°©ì§€)
        localStorage.setItem('METRO_V32_FINAL_DB', JSON.stringify(metroDatabase));
        // í™”ë©´ ë¦¬ìŠ¤íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        renderIntegrityDatabase();
        alert("ë¬´ê²°ì„± ì‹œìŠ¤í…œ ì•Œë¦¼: ëª¨ë“  ë°ì´í„°ì™€ ì‚¬ì§„ì´ ë¦¬ìŠ¤íŠ¸ í•˜ë‹¨ì— ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // [3.4 Database Rendering Engine]
    function renderIntegrityDatabase() {
        const body = document.getElementById('integrityDBBody');
        body.innerHTML = "";
        
        metroDatabase.forEach((row) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.í˜„ì¥ëª…}</td><td>${row.í•˜ìNo}</td><td>${row.ë™í˜¸ìˆ˜}</td><td>${row.ì‹¤ëª…ìœ„ì¹˜}</td>
                <td>${row.ê³µì¢…}</td><td>${row.ì—…ì²´ëª…}</td><td>${row.í•˜ìë‚´ìš©.substring(0,15)}...</td><td>${row.ì…ì£¼ìì„±ëª…}</td>
                <td><img src="${row.imgPre}" class="thumb-box-integrity"></td>
                <td><img src="${row.imgPost}" class="thumb-box-integrity"></td>
                <td><img src="${row.imgBoard}" class="thumb-box-integrity"></td>
                <td><img src="${row.imgDone}" class="thumb-box-integrity"></td>
            `;
            body.appendChild(tr);
        });
    }

    // [3.5 Explicit Delete Engine]
    function clearAllData() {
        if(confirm("ì£¼ì˜: ëª¨ë“  ëˆ„ì  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            metroDatabase = [];
            localStorage.removeItem('METRO_V32_FINAL_DB');
            renderIntegrityDatabase();
        }
    }

    // [3.6 Physical File Storage Engine (.csv)]
    function downloadIntegrityCSV() {
        if(metroDatabase.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        
        let csvContent = "\uFEFFí˜„ì¥ëª…,í•˜ì No.,ë™/í˜¸ìˆ˜,ì‹¤ëª…(ìœ„ì¹˜),ê³µì¢…,ì—…ì²´ëª…,í•˜ìë‚´ìš©,ì…ì£¼ìì„±ëª…\n";
        metroDatabase.forEach(r => {
            csvContent += `"${r.í˜„ì¥ëª…}","${r.í•˜ìNo}","${r.ë™í˜¸ìˆ˜}","${r.ì‹¤ëª…ìœ„ì¹˜}","${r.ê³µì¢…}","${r.ì—…ì²´ëª…}","${r.í•˜ìë‚´ìš©.replace(/\n/g, ' ')}","${r.ì…ì£¼ìì„±ëª…}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Metro_Ultimate_Report_${new Date().getTime()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // [3.7 High-Resolution Composite Engine (1200x1600)]
    async function processCompositeBoard(input) {
        if (!input.files || !input.files[0]) return;
        const loader = document.getElementById('master-process-loader');
        loader.style.display = 'flex';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const afterImage = new Image();
            afterImage.onload = function() {
                const canvas = document.getElementById('compositeCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1200; canvas.height = 1600; // 4:3 ê°•ì œ ê³ ì •
                
                ctx.drawImage(afterImage, 0, 0, 1200, 1600);
                
                ctx.fillStyle = "rgba(255, 255, 255, 0.98)";
                ctx.fillRect(45, 1210, 480, 360);
                ctx.strokeStyle = "#000000"; ctx.lineWidth = 8;
                ctx.strokeRect(45, 1210, 480, 360);
                
                ctx.fillStyle = "#000000"; ctx.font = "bold 36px sans-serif";
                const labels = ["í˜„ì¥ëª…", "ë™ / í˜¸ìˆ˜", "ì‹¤ëª…/ìœ„ì¹˜", "ê³µì¢…(ì‘ì—…)", "ì‘ì—…ì¼ì"];
                labels.forEach((lbl, i) => ctx.fillText(lbl, 65, 1265 + (i * 72)));
                
                ctx.font = "34px sans-serif";
                ctx.fillText(document.getElementById('site_v22').value || "", 225, 1265);
                ctx.fillText(document.getElementById('unit_v22').value || "", 225, 1337);
                ctx.fillText(document.getElementById('loc_v22').value || "", 225, 1409);
                ctx.fillText("ìˆ˜ë¦¬í›„ ì™„ë£Œ", 225, 1481);
                ctx.fillText(document.getElementById('date_v22').value.replace(/-/g, '.') || "", 225, 1553);

                document.getElementById('view-board').src = canvas.toDataURL("image/jpeg", 0.95);
                document.getElementById('view-board').style.display = 'block';
                document.getElementById('view-after').src = e.target.result;
                document.getElementById('view-after').style.display = 'block';
                loader.style.display = 'none';
            };
            afterImage.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    // [3.8 AI RegEx Precision Engine]
    async function runIntegrityAI(input) {
        if (!input.files || !input.files[0]) return;
        previewMaster(input, 'view-ai');
        const loader = document.getElementById('master-process-loader');
        loader.style.display = 'flex';
        
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${MASTER_VISION_KEY}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: base64Data }, features: [{ type: "DOCUMENT_TEXT_DETECTION" }] }] })
                });
                const data = await res.json();
                const textResult = data.responses[0].fullTextAnnotation.text;
                
                const siteMatch = textResult.match(/[ê°€-í£0-9-]+(í’ê²½ì±„|ê±´ì„¤|ì•„íŒŒíŠ¸|ìì´|í‘¸ë¥´ì§€ì˜¤)/);
                if(siteMatch) document.getElementById('site_v22').value = siteMatch[0];
                const hajaMatch = textResult.match(/\d{7}/);
                if(hajaMatch) document.getElementById('haja_v22').value = hajaMatch[0];
                const unitMatch = textResult.match(/\d{3,4}ë™\s?\d{3,4}í˜¸/);
                if(unitMatch) document.getElementById('unit_v22').value = unitMatch[0];
                const dateMatch = textResult.match(/\d{4}-\d{2}-\d{2}/) || textResult.match(/\d{2}\.\d{2}\.\d{2}/);
                if(dateMatch) document.getElementById('date_v22').value = dateMatch[0];

                alert("AI ì‹œìŠ¤í…œ ì•Œë¦¼: ë°ì´í„° ë¬´ê²°ì„± ë§¤í•‘ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) { alert("AI ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ë¬´ê²°ì„± í™•ì¸ í•„ìš”"); }
            finally { loader.style.display = 'none'; }
        };
        reader.readAsDataURL(input.files[0]);
    }
</script>
</body>
</html>
