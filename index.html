<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - ì‘ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    :root {
      --primary: #007aff;
      --success: #34c759;
      --danger: #ff3b30;
      --warning: #ff9500;
      --dark: #1c1c1e;
      --light: #f2f2f7;
      --border: #c6c6c8;
      --ai-gray: #444444;
      --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --gradient-orange: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0;
      padding: 0;
    }

    body, html { 
      background: var(--light); 
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif; 
      height: 100vh; 
      overflow: hidden; 
    }

    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: #fff; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 0 50px rgba(0,0,0,0.2); 
    }

    header { 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff; 
      text-align: center; 
      padding: 15px 0; 
      border-bottom: 3px solid var(--primary); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    header h1 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 900; 
      letter-spacing: 0.5px;
    }

    .badge { 
      font-size: 0.65rem; 
      color: #64ffda; 
      font-weight: 700; 
      margin-top: 3px; 
      display: block; 
      opacity: 0.9;
    }

    .content { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      -webkit-overflow-scrolling: touch; 
      background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    }

    .config-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 2px solid var(--success); /* ì—°ë™ ì„±ê³µ ê°•ì¡°ë¥¼ ìœ„í•´ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .config-section h3 {
      margin: 0 0 8px 0;
      font-size: 0.85rem;
      color: var(--success);
      font-weight: 800;
    }

    .btn-3d {
      width: 100%;
      padding: 10px;
      background: var(--gradient-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 900;
      font-size: 0.8rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }

    .status-message {
      padding: 8px 10px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.7rem;
      display: none;
      font-weight: 600;
    }
    
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .drop-zone { 
      width: 100%; 
      aspect-ratio: 4/3; 
      border: 2.5px dashed var(--border); 
      border-radius: 12px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      cursor: pointer; 
      position: relative; 
      margin-bottom: 12px; 
      background: #f8f9fa;
    }

    .preview-img { 
      width: 100%; height: 100%; object-fit: contain; 
      position: absolute; background: #000; display: none; z-index: 10; 
    }

    .data-table { 
      width: 100%; border-collapse: collapse; border: 2px solid #222; 
      margin-bottom: 12px; background: #fff; 
    }

    .data-table td { border: 1px solid #333; padding: 6px; position: relative; height: 48px; }
    .data-table label { position: absolute; top: 3px; left: 6px; font-size: 0.6rem; font-weight: 900; color: var(--primary); }
    .data-table input { width: 100%; border: none; font-size: 0.85rem; font-weight: 700; outline: none; padding-top: 12px; }

    .btn-clear { width: 100%; height: 38px; border-radius: 8px; border: none; background: #ff6b6b; color: #fff; font-weight: 900; margin-bottom: 15px; }

    .sheet-section { margin-top: 20px; margin-bottom: 30px; }
    .table-scroll { width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 10px; max-height: 400px; }
    #spreadsheet { width: 100%; border-collapse: collapse; font-size: 0.65rem; min-width: 1000px; }
    #spreadsheet th { background: #34c759; color: white; padding: 8px; position: sticky; top: 0; }
    #spreadsheet td { padding: 5px; border: 1px solid #eee; text-align: center; }

    #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    footer { display: flex; gap: 8px; padding: 12px; background: #fff; border-top: 1px solid #eee; }
    footer button { flex: 1; height: 50px; border-radius: 10px; border: none; color: #fff; font-weight: 900; }
    .btn-save { background: var(--gradient-green); }
    .btn-refresh { background: var(--gradient-blue); }
    
    .thumb { width: 50px; height: 40px; object-fit: cover; border-radius: 3px; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:10px;">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
</div>

<div class="app-container">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1>
    <span class="badge" id="versionBadge">VER 3.0 GAS SYNC ACTIVE</span>
  </header>

  <main class="content">
    <div class="config-section">
      <h3>âœ… êµ¬ê¸€ ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ì—°ë™ ê°€ë™ ì¤‘</h3>
      <p style="font-size:0.7rem; color:#666; margin-bottom:8px;">ì‘ì„±í•˜ì‹  Apps Scriptë¥¼ í†µí•´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì¦‰ì‹œ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
      <button class="btn-3d" onclick="CORE.testGAS()">ğŸ“¡ ì„œë²„ í†µì‹  í…ŒìŠ¤íŠ¸</button>
      <div id="statusMessage" class="status-message"></div>
    </div>

    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p class="zone-txt">ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p>
      <img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" style="display:none" onchange="CORE.analyze(this)">

    <table class="data-table">
      <tr>
        <td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td>
        <td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td>
        <td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></td>
      </tr>
      <tr>
        <td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td>
        <td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td>
        <td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td>
        <td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td>
      </tr>
      <tr>
        <td colspan="6" class="memo-td" style="height:80px;"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo" style="width:100%; border:none; outline:none; padding-top:20px;"></textarea></td>
      </tr>
    </table>

    <button class="btn-clear" onclick="CORE.clearForm()">ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì´ˆê¸°í™”</button>

    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p class="zone-txt">ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p>
      <img id="view-before" class="preview-img">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-before')">

    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p class="zone-txt">ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p>
      <img id="view-after" class="preview-img">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" style="display:none" onchange="CORE.processAfter(this)">

    <div class="drop-zone" style="border-style:solid; border-color:var(--success);">
      <p class="zone-txt" style="color:var(--success);">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„±</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>

    <div class="drop-zone" onclick="document.getElementById('f-final').click()">
      <p class="zone-txt">ğŸ“¸ 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ (ì„œëª…ë³¸)</p>
      <img id="view-final" class="preview-img">
    </div>
    <input type="file" id="f-final" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-final')">

    <section class="sheet-section">
      <div class="sheet-title" style="font-weight:900; margin-bottom:10px;">ğŸ“Š ì‘ì—… ë°ì´í„° íˆìŠ¤í† ë¦¬ <span id="dataCount" style="font-size:0.7rem;">(0ê±´)</span></div>
      <div class="table-scroll">
        <table id="spreadsheet">
          <thead>
            <tr>
              <th>í˜„ì¥</th><th>í•˜ìNo</th><th>ë™/í˜¸</th><th>ë‚ ì§œ</th><th>í™•ì¸ì</th><th>ì‚¬ì§„(ì „)</th><th>ì‚¬ì§„(í›„)</th>
            </tr>
          </thead>
          <tbody id="data-body">
            <tr><td colspan="7" style="padding:20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <button class="btn-save" onclick="CORE.save()">ğŸ’¾ ì„œë²„ ì „ì†¡ ë° ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ğŸ”„ ì•± ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  const CORE = {
    // ì‚¬ìš©ìê°€ ì œê³µí•œ êµ¬ê¸€ ì›¹ ì•± URL ì ìš©
    gasUrl: "https://script.google.com/macros/s/AKfycbzbfNjY3puvLiP7hxREKqTuB6pMnayZ2sbo8AbQ_ozSrzJY_9Ew8705nijfV-dkpTZz/exec",
    db: "METRO_DB_SYNC",

    // [í•µì‹¬] êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ë°ì´í„° ì „ì†¡
    appendToSheet: async function(data) {
      try {
        // GASëŠ” ë³´ì•ˆ ì •ì±…ìƒ 'no-cors' ëª¨ë“œë¡œ ë³´ë‚´ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì •ì ì…ë‹ˆë‹¤.
        const response = await fetch(this.gasUrl, {
          method: 'POST',
          mode: 'no-cors', 
          cache: 'no-cache',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return true; // no-corsëŠ” ì‘ë‹µ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
      } catch (error) {
        console.error('GAS ì „ì†¡ ì‹¤íŒ¨:', error);
        return false;
      }
    },

    // ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
    testGAS: async function() {
      this.showStatus('ğŸ“¡ ì„œë²„ì— ì‹ í˜¸ë¥¼ ë³´ë‚´ëŠ” ì¤‘...', 'success');
      const testResult = await this.appendToSheet({ site: "ì—°ê²°í…ŒìŠ¤íŠ¸", no: "TEST", timestamp: new Date().toLocaleString() });
      if(testResult) alert("âœ… ì„œë²„ í†µì‹  ì‹ í˜¸ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!\nìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.");
    },

    save: async function() {
      const site = document.getElementById('site').value;
      if (!site) { alert('í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

      document.getElementById('loader').style.display = 'flex';

      const data = {
        site: site,
        no: document.getElementById('haja').value,
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        timestamp: new Date().toLocaleString('ko-KR')
      };

      // 1. êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡
      const isSuccess = await this.appendToSheet(data);

      // 2. ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë„ ì €ì¥
      let list = JSON.parse(localStorage.getItem(this.db) || "[]");
      list.push(data);
      localStorage.setItem(this.db, JSON.stringify(list));

      this.render();
      document.getElementById('loader').style.display = 'none';
      
      alert('âœ… ì €ì¥ ë° ì„œë²„ ì „ì†¡ ì™„ë£Œ!');
    },

    // ì´ë¯¸ì§€ í”„ë¦¬ë·° ë° OCR ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    p: function(input, id) {
      if (!input.files || !input.files[0]) return;
      const targetImg = document.getElementById(id);
      const r = new FileReader();
      r.onload = (e) => { targetImg.src = e.target.result; targetImg.style.display = 'block'; };
      r.readAsDataURL(input.files[0]);
    },

    analyze: async function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      try {
        const { data: { text } } = await Tesseract.recognize(input.files[0], 'kor+eng');
        this.map(text);
        alert('AI ë¶„ì„ ì™„ë£Œ!');
      } catch(e) { alert('OCR ë¶„ì„ ì‹¤íŒ¨, ìˆ˜ë™ ì…ë ¥ ë°”ëë‹ˆë‹¤.'); }
      document.getElementById('loader').style.display = 'none';
    },

    map: function(t) {
      // ê°„ë‹¨ ë§¤í•‘ ë¡œì§
      if(t.includes("ì›ì£¼")) document.getElementById('site').value = "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
    },

    processAfter: function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-after');
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const cvs = document.getElementById('boardCanvas');
          const ctx = cvs.getContext('2d');
          cvs.width = 800; cvs.height = 1000;
          ctx.drawImage(img, 0, 0, 800, 1000);
          ctx.fillStyle = "rgba(255,255,255,0.8)";
          ctx.fillRect(20, 800, 300, 180);
          ctx.fillStyle = "#000"; ctx.font = "bold 20px Arial";
          ctx.fillText("í˜„ì¥: " + document.getElementById('site').value, 30, 830);
          ctx.fillText("í˜¸ìˆ˜: " + document.getElementById('unit').value, 30, 860);
          ctx.fillText("ì¼ì: " + document.getElementById('date').value, 30, 890);
          const vb = document.getElementById('view-board');
          vb.src = cvs.toDataURL("image/jpeg");
          vb.style.display = 'block';
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    },

    render: function() {
      const list = JSON.parse(localStorage.getItem(this.db) || "[]");
      document.getElementById('dataCount').textContent = `(${list.length}ê±´)`;
      const body = document.getElementById('data-body');
      if (list.length === 0) return;
      body.innerHTML = list.reverse().map(r => `
        <tr>
          <td>${r.site}</td><td>${r.no}</td><td>${r.unit}</td>
          <td>${r.date}</td><td>${r.name}</td>
          <td>-</td><td>-</td>
        </tr>
      `).join('');
    },

    showStatus: function(m, type) {
      const s = document.getElementById('statusMessage');
      s.textContent = m; s.className = 'status-message status-' + type;
      s.style.display = 'block';
      setTimeout(() => s.style.display='none', 3000);
    },

    clearForm: function() {
      if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) location.reload();
    }
  };

  window.onload = () => { CORE.render(); };
</script>
</body>
</html>
