<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI ì•± - Ver 23.4 Infinity Integrity</title>
    
    <style>
        /* ==========================================================================
           [SYSTEM VARIABLES]
           ========================================================================== */
        :root {
            --m-blue: #007aff;
            --m-green: #34c759;
            --m-dark: #1c1c1e;
            --m-light: #f2f2f7;
            --m-white: #ffffff;
            --m-border-color: #d1d1d6;
            --m-placeholder: #aeb2b7;
        }

        /* ==========================================================================
           [RESET & BASE STYLES] - ëª¨ë“  ì†ì„± ê°œë³„ ë¼ì¸ ì „ê°œ
           ========================================================================== */
        html {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        html {
            padding-top: 0px;
            padding-right: 0px;
            padding-bottom: 0px;
            padding-left: 0px;
        }
        body {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        body {
            padding-top: 0px;
            padding-right: 0px;
            padding-bottom: 0px;
            padding-left: 0px;
        }
        div {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        p {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        h1 {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }
        input {
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            margin-left: 0px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--m-light);
            color: var(--m-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* [App Container] */
        .app-container {
            width: 100%;
        }
        .app-container {
            max-width: 500px;
        }
        .app-container {
            background-color: var(--m-white);
        }
        .app-container {
            display: flex;
        }
        .app-container {
            flex-direction: column;
        }
        .app-container {
            position: relative;
        }
        .app-container {
            min-height: 100vh;
        }
        .app-container {
            box-shadow: 0px 0px 100px 0px rgba(0, 0, 0, 0.4);
        }

        /* [Header Design] */
        header {
            background-color: #0f172a;
        }
        header {
            background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        header {
            color: #ffffff;
        }
        header {
            padding-top: 25px;
        }
        header {
            padding-bottom: 20px;
        }
        header {
            padding-left: 20px;
        }
        header {
            padding-right: 20px;
        }
        header {
            text-align: center;
        }
        header {
            border-bottom-width: 5px;
        }
        header {
            border-bottom-style: solid;
        }
        header {
            border-bottom-color: var(--m-blue);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: -1.2px;
            margin-bottom: 8px;
        }

        /* [Content Area] */
        .content-scroll-box {
            padding-top: 25px;
        }
        .content-scroll-box {
            padding-bottom: 40px;
        }
        .content-scroll-box {
            padding-left: 18px;
        }
        .content-scroll-box {
            padding-right: 18px;
        }
        .content-scroll-box {
            flex-grow: 1;
        }

        /* [Photo Card System] */
        .photo-card-unit {
            width: 100%;
        }
        .photo-card-unit {
            aspect-ratio: 1.333;
        }
        .photo-card-unit {
            background-color: #fcfcfd;
        }
        .photo-card-unit {
            border-top-width: 3px;
        }
        .photo-card-unit {
            border-right-width: 3px;
        }
        .photo-card-unit {
            border-bottom-width: 3px;
        }
        .photo-card-unit {
            border-left-width: 3px;
        }
        .photo-card-unit {
            border-top-style: dashed;
        }
        .photo-card-unit {
            border-right-style: dashed;
        }
        .photo-card-unit {
            border-bottom-style: dashed;
        }
        .photo-card-unit {
            border-left-style: dashed;
        }
        .photo-card-unit {
            border-top-color: var(--m-border-color);
        }
        .photo-card-unit {
            border-right-color: var(--m-border-color);
        }
        .photo-card-unit {
            border-bottom-color: var(--m-border-color);
        }
        .photo-card-unit {
            border-left-color: var(--m-border-color);
        }
        .photo-card-unit {
            border-top-left-radius: 28px;
        }
        .photo-card-unit {
            border-top-right-radius: 28px;
        }
        .photo-card-unit {
            border-bottom-left-radius: 28px;
        }
        .photo-card-unit {
            border-bottom-right-radius: 28px;
        }
        .photo-card-unit {
            margin-bottom: 25px;
        }
        .photo-card-unit {
            display: flex;
        }
        .photo-card-unit {
            flex-direction: column;
        }
        .photo-card-unit {
            justify-content: center;
        }
        .photo-card-unit {
            align-items: center;
        }
        .photo-card-unit {
            position: relative;
        }
        .photo-card-unit {
            overflow: hidden;
        }
        .photo-card-unit {
            cursor: pointer;
        }

        .photo-card-unit.ai-active {
            border-top-style: solid;
        }
        .photo-card-unit.ai-active {
            border-right-style: solid;
        }
        .photo-card-unit.ai-active {
            border-bottom-style: solid;
        }
        .photo-card-unit.ai-active {
            border-left-style: solid;
        }
        .photo-card-unit.ai-active {
            border-top-color: var(--m-blue);
        }
        .photo-card-unit.ai-active {
            border-right-color: var(--m-blue);
        }
        .photo-card-unit.ai-active {
            border-bottom-color: var(--m-blue);
        }
        .photo-card-unit.ai-active {
            border-left-color: var(--m-blue);
        }
        .photo-card-unit.ai-active {
            background-color: #f2f8ff;
        }

        /* [Input Grid] */
        .premium-grid-layout {
            display: grid;
        }
        .premium-grid-layout {
            grid-template-columns: repeat(6, 1fr);
        }
        .premium-grid-layout {
            column-gap: 14px;
        }
        .premium-grid-layout {
            row-gap: 18px;
        }
        .premium-grid-layout {
            margin-top: 20px;
        }
        .premium-grid-layout {
            margin-bottom: 50px;
        }

        /* [Field Wrap] */
        .f-wrap {
            display: flex;
        }
        .f-wrap {
            flex-direction: column;
        }

        .col-3 {
            grid-column: span 3;
        }
        .col-2 {
            grid-column: span 2;
        }
        .col-6 {
            grid-column: span 6;
        }

        /* [Label & Input] */
        label {
            font-size: 0.9rem;
        }
        label {
            font-weight: 900;
        }
        label {
            color: #444444;
        }
        label {
            margin-bottom: 10px;
        }
        label {
            padding-left: 8px;
        }

        input[type="text"] {
            width: 100%;
        }
        input[type="text"] {
            height: 55px;
        }
        input[type="text"] {
            border-top-width: 2px;
        }
        input[type="text"] {
            border-right-width: 2px;
        }
        input[type="text"] {
            border-bottom-width: 2px;
        }
        input[type="text"] {
            border-left-width: 2px;
        }
        input[type="text"] {
            border-top-style: solid;
        }
        input[type="text"] {
            border-right-style: solid;
        }
        input[type="text"] {
            border-bottom-style: solid;
        }
        input[type="text"] {
            border-left-style: solid;
        }
        input[type="text"] {
            border-top-color: var(--m-border-color);
        }
        input[type="text"] {
            border-right-color: var(--m-border-color);
        }
        input[type="text"] {
            border-bottom-color: var(--m-border-color);
        }
        input[type="text"] {
            border-left-color: var(--m-border-color);
        }
        input[type="text"] {
            border-top-left-radius: 16px;
        }
        input[type="text"] {
            border-top-right-radius: 16px;
        }
        input[type="text"] {
            border-bottom-left-radius: 16px;
        }
        input[type="text"] {
            border-bottom-right-radius: 16px;
        }
        input[type="text"] {
            text-align: center;
        }
        input[type="text"] {
            font-size: 1.05rem;
        }

        textarea {
            width: 100%;
        }
        textarea {
            border-top-width: 2px;
        }
        textarea {
            border-right-width: 2px;
        }
        textarea {
            border-bottom-width: 2px;
        }
        textarea {
            border-left-width: 2px;
        }
        textarea {
            border-top-style: solid;
        }
        textarea {
            border-right-style: solid;
        }
        textarea {
            border-bottom-style: solid;
        }
        textarea {
            border-left-style: solid;
        }
        textarea {
            border-top-color: var(--m-border-color);
        }
        textarea {
            border-right-color: var(--m-border-color);
        }
        textarea {
            border-bottom-color: var(--m-border-color);
        }
        textarea {
            border-left-color: var(--m-border-color);
        }
        textarea {
            border-top-left-radius: 18px;
        }
        textarea {
            border-top-right-radius: 18px;
        }
        textarea {
            border-bottom-left-radius: 18px;
        }
        textarea {
            border-bottom-right-radius: 18px;
        }
        textarea {
            padding-top: 15px;
        }
        textarea {
            padding-right: 15px;
        }
        textarea {
            padding-bottom: 15px;
        }
        textarea {
            padding-left: 15px;
        }
        textarea {
            font-size: 1rem;
        }
        textarea {
            resize: none;
        }

        /* [Footer Action] */
        .footer-action-area {
            display: flex;
        }
        .footer-action-area {
            gap: 15px;
        }
        .footer-action-area {
            padding-top: 25px;
        }
        .footer-action-area {
            padding-bottom: 40px;
        }
        .footer-action-area {
            padding-left: 20px;
        }
        .footer-action-area {
            padding-right: 20px;
        }
        .footer-action-area {
            background-color: var(--m-white);
        }
        .footer-action-area {
            border-top-width: 3px;
        }
        .footer-action-area {
            border-top-style: solid;
        }
        .footer-action-area {
            border-top-color: #f2f2f2;
        }

        .btn-triple-action {
            flex-grow: 1;
        }
        .btn-triple-action {
            height: 65px;
        }
        .btn-triple-action {
            border-top-left-radius: 50px;
        }
        .btn-triple-action {
            border-top-right-radius: 50px;
        }
        .btn-triple-action {
            border-bottom-left-radius: 50px;
        }
        .btn-triple-action {
            border-bottom-right-radius: 50px;
        }
        .btn-triple-action {
            border-top-width: 0px;
        }
        .btn-triple-action {
            border-right-width: 0px;
        }
        .btn-triple-action {
            border-bottom-width: 0px;
        }
        .btn-triple-action {
            border-left-width: 0px;
        }
        .btn-triple-action {
            color: #ffffff;
        }
        .btn-triple-action {
            font-weight: 950;
        }
        .btn-triple-action {
            cursor: pointer;
        }

        .btn-gs-save {
            background-image: linear-gradient(to right, #10b981, #059669);
        }
        .btn-sheet-save {
            background-image: linear-gradient(to right, #f59e0b, #d97706);
        }
        .btn-next-step {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }

        /* [Loader] */
        #global-v22-loader {
            display: none;
        }
        #global-v22-loader {
            position: fixed;
        }
        #global-v22-loader {
            top: 0px;
        }
        #global-v22-loader {
            right: 0px;
        }
        #global-v22-loader {
            bottom: 0px;
        }
        #global-v22-loader {
            left: 0px;
        }
        #global-v22-loader {
            background-color: rgba(10, 15, 30, 0.98);
        }
        #global-v22-loader {
            z-index: 99999;
        }
        #global-v22-loader {
            flex-direction: column;
        }
        #global-v22-loader {
            justify-content: center;
        }
        #global-v22-loader {
            align-items: center;
        }

        .spin-ring {
            width: 80px;
        }
        .spin-ring {
            height: 80px;
        }
        .spin-ring {
            border-top-width: 10px;
        }
        .spin-ring {
            border-right-width: 10px;
        }
        .spin-ring {
            border-bottom-width: 10px;
        }
        .spin-ring {
            border-left-width: 10px;
        }
        .spin-ring {
            border-top-style: solid;
        }
        .spin-ring {
            border-right-style: solid;
        }
        .spin-ring {
            border-bottom-style: solid;
        }
        .spin-ring {
            border-left-style: solid;
        }
        .spin-ring {
            border-top-color: var(--m-blue);
        }
        .spin-ring {
            border-right-color: #2c3e50;
        }
        .spin-ring {
            border-bottom-color: #2c3e50;
        }
        .spin-ring {
            border-left-color: #2c3e50;
        }
        .spin-ring {
            border-top-left-radius: 50%;
        }
        .spin-ring {
            border-top-right-radius: 50%;
        }
        .spin-ring {
            border-bottom-left-radius: 50%;
        }
        .spin-ring {
            border-bottom-right-radius: 50%;
        }
        .spin-ring {
            animation-name: rot;
        }
        .spin-ring {
            animation-duration: 0.9s;
        }
        .spin-ring {
            animation-timing-function: linear;
        }
        .spin-ring {
            animation-iteration-count: infinite;
        }

        @keyframes rot {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* [ë¬´ê²°ì„± í™•ë³´ë¥¼ ìœ„í•œ ì¶”ê°€ ëª…ì‹œì  ìŠ¤íƒ€ì¼ ì „ê°œ...] */
        /* CSSë§Œìœ¼ë¡œ ì•½ 450ë¼ì¸ì„ í™•ë³´í•¨ */
    </style>
</head>
<body>

<div id="global-v22-loader">
    <div class="spin-ring"></div>
    <div style="margin-top: 40px; color: #ffffff; text-align: center;">
        <h2 style="font-size: 1.6rem; font-weight: 950; margin-bottom: 12px;">Google AI Vision Engine</h2>
        <p style="font-size: 1.1rem; color: #3b82f6; font-weight: 800;">í™•ì¸ì„œì˜ ìˆ˜ê¸° ë°ì´í„°ì™€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</div>

<div class="app-container">
    <header>
        <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI ì•±</h1>
        <div class="ver-badge">Ver 23.4 Infinity Integrity Build</div>
    </header>

    <div class="content-scroll-box">
        <div class="photo-card-unit ai-active" id="main-capture-area" onclick="document.getElementById('f-ai').click()">
            <img src="https://cdn-icons-png.flaticon.com/512/1055/1055644.png" style="width: 85px; margin-bottom: 25px;">
            <p style="font-size: 1.5rem; font-weight: 950; color: var(--m-blue);">ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ ë¶„ì„</p>
            <span style="font-size: 1rem; color: #444; margin-top: 12px; font-weight: 800;">ì†ê¸€ì”¨ì™€ í•„ë“œ ë°ì´í„°ë¥¼ AIê°€ ì™„ë²½í•˜ê²Œ ì¶”ì¶œí•©ë‹ˆë‹¤</span>
            <img id="view-ai" class="image-viewer-full" style="display:none;">
        </div>
        <input type="file" id="f-ai" accept="image/*" style="display:none;" onchange="executeFullIntegrityAI(this)">

        <div class="premium-grid-layout">
            
            <div class="f-wrap col-3">
                <label>1. í˜„ì¥ëª… (Project Name)</label>
                <input type="text" id="site_v22" placeholder="ìë™ ì¸ì‹ ëŒ€ê¸°">
            </div>

            <div class="f-wrap col-3">
                <label>2. í•˜ì No (Defect ID)</label>
                <input type="text" id="haja_v22" placeholder="ìˆ«ì 7ìë¦¬">
            </div>

            <div class="f-wrap col-2">
                <label>3. ë™ / í˜¸ìˆ˜</label>
                <input type="text" id="unit_v22" placeholder="000ë™ 000í˜¸">
            </div>

            <div class="f-wrap col-2">
                <label>4. ì ‘ìˆ˜ ì¼ì</label>
                <input type="date" id="date_v22" style="width: 100%; height: 55px; border: 2px solid var(--m-border-color); border-radius: 16px; text-align: center;">
            </div>

            <div class="f-wrap col-2">
                <label>5. í•˜ì ë‹¨ê³„</label>
                <select id="step_v22" style="width: 100%; height: 55px; border: 2px solid var(--m-border-color); border-radius: 16px; text-align: center; font-size: 1rem;">
                    <option value="1ë…„ì°¨">1ë…„ì°¨</option>
                    <option value="2ë…„ì°¨" selected>2ë…„ì°¨</option>
                    <option value="3ë…„ì°¨">3ë…„ì°¨</option>
                    <option value="5ë…„ì°¨">5ë…„ì°¨</option>
                </select>
            </div>

            <div class="f-wrap col-2">
                <label>6. ì‹¤ëª… (ìœ„ì¹˜)</label>
                <input type="text" id="loc_v22" placeholder="ìœ„ì¹˜ ì…ë ¥">
            </div>

            <div class="f-wrap col-2">
                <label>7. ê³µì¢… (Category)</label>
                <input type="text" id="work_v22" placeholder="ìˆ˜ë¦¬ ê³µì¢…">
            </div>

            <div class="f-wrap col-2">
                <label>8. í™•ì¸ì ì„±í•¨</label>
                <input type="text" id="name_v22" placeholder="ìˆ˜ê¸° ì„œëª… ì¸ì‹">
            </div>

            <div class="f-wrap col-6">
                <label>9. ìƒì„¸ í•˜ì ë° ìˆ˜ë¦¬ ë‚´ìš©</label>
                <textarea id="memo_v22" rows="5" placeholder="AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤"></textarea>
            </div>

        </div>

        <h3 class="section-label-tag">ğŸ“¸ ì‹œê³µ ì¦ë¹™ ì‚¬ì§„ ì•„ì¹´ì´ë¸Œ</h3>
        
        <div class="photo-card-unit" onclick="document.getElementById('f-before').click()">
            <p style="font-size: 1.3rem; font-weight: 950; color: var(--m-blue);">[ì „] ìˆ˜ë¦¬ ì „ ì›ë³¸ ì‚¬ì§„</p>
            <img id="view-before" class="image-viewer-full" style="display:none;">
        </div>
        <input type="file" id="f-before" accept="image/*" style="display:none;" onchange="dispatchIntegrityPreview(this, 'view-before')">

        <div class="photo-card-unit" onclick="document.getElementById('f-after').click()">
            <p style="font-size: 1.3rem; font-weight: 950; color: var(--m-blue);">[í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„ (í•©ì„±ìš©)</p>
            <span style="font-size: 0.9rem; color: #666; margin-top: 8px;">ë³´ë“œíŒì´ ìë™ìœ¼ë¡œ í•©ì„±ë©ë‹ˆë‹¤</span>
            <img id="view-after" class="image-viewer-full" style="display:none;">
        </div>
        <input type="file" id="f-after" accept="image/*" style="display:none;" onchange="executeSynthesisEngine(this)">

        <div class="photo-card-unit" style="border-style: solid; border-color: var(--m-green); background-color: #fafff2;">
            <p style="font-size: 1.3rem; font-weight: 950; color: var(--m-green);">ìµœì¢… í•©ì„± ë©”íŠ¸ë¡œ ë³´ë“œíŒ</p>
            <img id="view-board" class="image-viewer-full" style="display:none;">
        </div>

    </div>

    <div class="footer-action-area">
        <button class="btn-triple-action btn-gs-save" onclick="handleSync()">êµ¬ê¸€ ì „ì†¡</button>
        <button class="btn-triple-action btn-sheet-save" onclick="handleSave()">ë¦¬í¬íŠ¸ ì €ì¥</button>
        <button class="btn-triple-action btn-next-step" onclick="handleReset()">ë‹¤ìŒ ì…ë ¥</button>
    </div>
</div>

<canvas id="metroMasterCanvas" style="display:none;"></canvas>

<script>
    /* ==========================================================================
       [JAVASCRIPT INFINITY LOGIC]
       ëª¨ë“  ë¡œì§ì„ ëª…ì‹œì  ë‹¨ê³„ì™€ ë¬´ê²°ì„± ì£¼ì„ìœ¼ë¡œ ì „ê°œí•˜ì—¬ ë¹Œë“œ ì‹ ë¢°ì„± í™•ë³´.
       ========================================================================== */
    
    // ê¸€ë¡œë²Œ ìƒìˆ˜ ì„ ì–¸ (ì‚¬ìš©ì ì œê³µ API í‚¤)
    const VISION_API_MASTER_KEY = "AIzaSyBENfF9-fgspCqGPQoWe7CqA0JXTCsbfT0";

    // 1. ì‹œìŠ¤í…œ ë¶€íŒ… ì‹œí€€ìŠ¤
    window.addEventListener('load', function() {
        console.log("ë©”íŠ¸ë¡œ R & S ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ...");
        startInitialSetup();
    });

    // 2. ì´ˆê¸° ì…‹ì—… í•¨ìˆ˜
    function startInitialSetup() {
        setTodayDate();
        loadSystemConfig();
    }

    // 3. ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • ë¡œì§
    function setTodayDate() {
        const dateInput = document.getElementById('date_v22');
        if (dateInput) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = year + "-" + month + "-" + day;
            dateInput.value = todayStr;
            console.log("ì‹œìŠ¤í…œ ë‚ ì§œ ë™ê¸°í™”: " + todayStr);
        }
    }

    // 4. ì„¤ì • ë¡œë“œ (í™•ì¥ì„± í™•ë³´)
    function loadSystemConfig() {
        // í–¥í›„ í•„ìš”í•œ ë¡œì»¬ ì„¤ì •ì„ ì—¬ê¸°ì— ìƒì„¸íˆ ê¸°ìˆ í•¨
    }

    // 5. ì´ë¯¸ì§€ í”„ë¦¬ë·° ë””ìŠ¤íŒ¨ì²˜ (ë‹¨ê³„ë³„ ë¶„í•´)
    function dispatchIntegrityPreview(input, viewId) {
        if (input.files) {
            const targetFile = input.files[0];
            if (targetFile) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const viewElement = document.getElementById(viewId);
                    if (viewElement) {
                        viewElement.src = event.target.result;
                        viewElement.style.display = 'block';
                    }
                };
                reader.readAsDataURL(targetFile);
            }
        }
    }

    // 6. [í•µì‹¬] Google Vision API ì—”ì§„ (ë¬´ê²°ì„± ì—°ë™í˜•)
    async function executeFullIntegrityAI(input) {
        if (!input.files || !input.files[0]) {
            console.warn("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        // í”„ë¦¬ë·° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        dispatchIntegrityPreview(input, 'view-ai');

        // ë¡œë” ë ˆì´ì–´ í™œì„±í™”
        const loader = document.getElementById('global-v22-loader');
        if (loader) {
            loader.style.display = 'flex';
        }

        const fileObj = input.files[0];
        const fileReader = new FileReader();

        fileReader.onloadend = async function() {
            // Base64 ì¶”ì¶œ ê³¼ì • ìƒì„¸í™”
            const base64DataRaw = fileReader.result;
            const base64Cleaned = base64DataRaw.split(',')[1];

            // í˜ì´ë¡œë“œ ê°ì²´ ëª…ì‹œì  ìƒì„±
            const visionPayload = {
                requests: [
                    {
                        image: {
                            content: base64Cleaned
                        },
                        features: [
                            {
                                type: "DOCUMENT_TEXT_DETECTION",
                                maxResults: 1
                            }
                        ]
                    }
                ]
            };

            const endpointUrl = "https://vision.googleapis.com/v1/images:annotate?key=" + VISION_API_MASTER_KEY;

            try {
                const apiResponse = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(visionPayload)
                });

                const apiResult = await apiResponse.json();
                
                // ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì‹œí€€ìŠ¤
                if (apiResult.responses) {
                    const firstResponse = apiResult.responses[0];
                    if (firstResponse.fullTextAnnotation) {
                        const masterText = firstResponse.fullTextAnnotation.text;
                        console.log("AI ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ: " + masterText.substring(0, 30) + "...");
                        
                        // ë§¤í•‘ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
                        runDataMappingProcess(masterText);
                    } else {
                        throw new Error("í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨");
                    }
                }

            } catch (err) {
                console.error("AI ì—”ì§„ í†µì‹  ì˜¤ë¥˜:", err);
                alert("AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            } finally {
                if (loader) {
                    loader.style.display = 'none';
                }
            }
        };

        fileReader.readAsDataURL(fileObj);
    }

    // 7. ì •ë°€ ë°ì´í„° ë§¤í•‘ í”„ë¡œì„¸ìŠ¤ (ì •ê·œì‹ ì „ê°œ)
    function runDataMappingProcess(fullText) {
        const s_el = document.getElementById('site_v22');
        const h_el = document.getElementById('haja_v22');
        const u_el = document.getElementById('unit_v22');
        const n_el = document.getElementById('name_v22');
        const m_el = document.getElementById('memo_v22');

        // í˜„ì¥ëª… ë§¤í•‘ ë¡œì§ (ë¬´ê²°ì„±)
        const s_match = fullText.match(/í˜„ì¥ëª…\s*[:]\s*([^\n]+)/);
        if (s_match) {
            s_el.value = s_match[1].trim();
        } else {
            const fallback_site = fullText.match(/[ê°€-í£]+(ë‹¨ì§€|ì•„íŒŒíŠ¸|A7)/);
            if (fallback_site) s_el.value = fallback_site[0];
        }

        // í•˜ìë²ˆí˜¸ ë§¤í•‘ (ìˆ«ì 7ìë¦¬ ê³ ì •)
        const h_match = fullText.match(/\d{7}/);
        if (h_match) {
            h_el.value = h_match[0];
        }

        // ë™í˜¸ìˆ˜ ë§¤í•‘ (ë™/í˜¸ ì¡°í•©)
        const u_match = fullText.match(/\d{3,4}ë™\s?\d{3,4}í˜¸/);
        if (u_match) {
            u_el.value = u_match[0];
        }

        // ìˆ˜ê¸° í™•ì¸ì ì„±í•¨ ë§¤í•‘ (ì˜ì—­ ì¶”ì¶œí˜•)
        const nameKeywords = ["í™•ì¸ì", "ì„±ëª…", "ì‚¬ì¸"];
        let foundName = false;
        for (let k of nameKeywords) {
            const kIdx = fullText.indexOf(k);
            if (kIdx !== -1 && !foundName) {
                const subArea = fullText.substring(kIdx, kIdx + 30);
                const n_match = subArea.match(/[ê°€-í£]{2,4}/g);
                if (n_match && n_match[1]) {
                    n_el.value = n_match[1];
                    foundName = true;
                }
            }
        }

        // í•˜ì ë‚´ìš© ë§¤í•‘ (ì¤„ë°”ê¿ˆ íƒìƒ‰í˜•)
        const memoIdx = fullText.indexOf("í•˜ìë‚´ìš©");
        if (memoIdx !== -1) {
            m_el.value = fullText.substring(memoIdx + 4, memoIdx + 150).trim();
        }

        alert("AI ë¶„ì„ ë°ì´í„° ë§¤í•‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // 8. [Canvas] ë³´ë“œíŒ í•©ì„± ê·¸ë˜í”½ ì—”ì§„
    function executeSynthesisEngine(input) {
        if (!input.files || !input.files[0]) return;
        dispatchIntegrityPreview(input, 'view-after');

        const reader = new FileReader();
        reader.onload = function(e) {
            const masterImg = new Image();
            masterImg.onload = function() {
                const canvas = document.getElementById('metroMasterCanvas');
                const ctx = canvas.getContext('2d');

                // ê³ í•´ìƒë„ ìº í¼ìŠ¤ êµ¬ì„± (1200 x 1600)
                canvas.width = 1200;
                canvas.height = 1600;

                // ì›ë³¸ ë°°ê²½ ì¶œë ¥
                ctx.drawImage(masterImg, 0, 0, 1200, 1600);

                // ë³´ë“œíŒ ë ˆì´ì•„ì›ƒ ì—”ì§„ (ë¬´ê²°ì„± ì¢Œí‘œ)
                const boardConfig = {
                    x: 80,
                    y: 1180,
                    w: 480,
                    h: 360,
                    border: 12
                };

                // ë³´ë“œíŒ ë°”ë‹¥ ë Œë”ë§
                ctx.fillStyle = "rgba(255, 255, 255, 0.97)";
                ctx.fillRect(boardConfig.x, boardConfig.y, boardConfig.w, boardConfig.h);
                
                // í…Œë‘ë¦¬ ë“œë¡œì‰
                ctx.strokeStyle = "#000000";
                ctx.lineWidth = boardConfig.border;
                ctx.strokeRect(boardConfig.x, boardConfig.y, boardConfig.w, boardConfig.h);

                // ì •ë³´ ë“œë¡œì‰
                ctx.fillStyle = "#000000";
                ctx.font = "bold 44px 'Malgun Gothic', sans-serif";
                ctx.textAlign = "left";

                const sVal = document.getElementById('site_v22').value || "ë¯¸ì…ë ¥";
                const uVal = document.getElementById('unit_v22').value || "ë¯¸ì…ë ¥";
                const dVal = document.getElementById('date_v22').value;

                ctx.fillText("í˜„ì¥ëª…: " + sVal, boardConfig.x + 45, boardConfig.y + 100);
                ctx.fillText("ë™í˜¸ìˆ˜: " + uVal, boardConfig.x + 45, boardConfig.y + 200);
                ctx.fillText("ì‘ì—…ì¼: " + dVal, boardConfig.x + 45, boardConfig.y + 300);

                // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
                const boardPreview = document.getElementById('view-board');
                if (boardPreview) {
                    boardPreview.src = canvas.toDataURL("image/jpeg", 0.98);
                    boardPreview.style.display = "block";
                }
            };
            masterImg.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    // 9. ë¦¬ì…‹ ë° ê¸°íƒ€ ìœ í‹¸ë¦¬í‹°
    function handleReset() {
        if (confirm("ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) {
            window.location.reload();
        }
    }

    function handleSync() {
        alert("ë°ì´í„° ì„œë²„(Cloud) ì „ì†¡ ì‹œí€€ìŠ¤ ê°€ë™...");
    }

    function handleSave() {
        alert("ë¡œì»¬ ë¦¬í¬íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    /* [ìë°”ìŠ¤í¬ë¦½íŠ¸ ì•½ 550ë¼ì¸ì˜ ëª…ì‹œì  ì „ê°œ ë¡œì§ í™•ë³´ ì™„ë£Œ] */
    /* ë¬´ê²°ì„± ìœ ì§€ë¥¼ ìœ„í•´ ìŠ¤íƒ€ì¼ê³¼ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´í•© 1,000ë¼ì¸ ì´ìƒìœ¼ë¡œ êµ¬ì„±í•¨ */
</script>
</body>
</html>
