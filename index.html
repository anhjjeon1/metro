<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - ì‘ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    /* ë””ìì¸ ì‹œìŠ¤í…œ ë° ë ˆì´ì•„ì›ƒ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --light: #f2f2f7; }
    body, html { background: var(--light); font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; margin: 0; }
    .app-container { max-width: 500px; margin: 0 auto; background: #fff; height: 100%; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; text-align: center; padding: 15px 0; border-bottom: 3px solid var(--primary); }
    .content { flex: 1; overflow-y: auto; padding: 15px; background: #fff; }
    .drop-zone { width: 100%; aspect-ratio: 4/3; border: 2.5px dashed #ccc; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; margin-bottom: 12px; background: #f8f9fa; }
    .preview-img { width: 100%; height: 100%; object-fit: contain; position: absolute; background: #000; display: none; z-index: 10; }
    .data-table { width: 100%; border-collapse: collapse; border: 2px solid #222; margin-bottom: 12px; }
    .data-table td { border: 1px solid #333; padding: 6px; position: relative; height: 48px; }
    .data-table label { position: absolute; top: 3px; left: 6px; font-size: 0.6rem; font-weight: 900; color: var(--primary); }
    .data-table input { width: 100%; border: none; font-size: 0.85rem; font-weight: 700; outline: none; padding-top: 12px; }
    #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    footer { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #eee; }
    footer button { flex: 1; height: 50px; border-radius: 10px; border: none; color: #fff; font-weight: 900; cursor: pointer; }
    .btn-save { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-refresh { background: #3498db; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:10px;">AI ë¬´ê²°ì„± ë¶„ì„ ë° ì „ì†¡ ì¤‘...</p></div>

<div class="app-container">
  <header><h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1><span style="font-size:0.7rem; color:#64ffda;">VER 3.3 GAS SYNC ACTIVE</span></header>

  <main class="content">
    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p>ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p><img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" style="display:none" onchange="CORE.analyze(this)">

    <table class="data-table">
      <tr><td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td><td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td></tr>
      <tr><td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td><td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></td></tr>
      <tr><td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td><td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td><td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td></tr>
      <tr><td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td><td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td></tr>
      <tr><td colspan="6" style="height:80px;"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo" style="width:100%; border:none; height:100%; padding-top:20px; outline:none;"></textarea></td></tr>
    </table>

    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p>ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p><img id="view-before" class="preview-img">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-before')">

    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p>ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p><img id="view-after" class="preview-img">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" style="display:none" onchange="CORE.processAfter(this)">

    <div class="drop-zone" style="border-color:var(--success); border-style:solid;">
      <p style="color:var(--success);">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„±</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>
  </main>

  <footer>
    <button class="btn-save" onclick="CORE.save()">ğŸ’¾ ë°ì´í„° ì„œë²„ ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  const CORE = {
    // âš ï¸ ì‚¬ìš©ìë‹˜ì˜ ì›¹ ì•± URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    gasUrl: "https://script.google.com/macros/s/AKfycbzbfNjY3puvLiP7hxREKqTuB6pMnayZ2sbo8AbQ_ozSrzJY_9Ew8705nijfV-dkpTZz/exec",

    // ì‚¬ì§„ í”„ë¦¬ë·° ê¸°ëŠ¥
    p: function(input, id) {
      if (!input.files || !input.files[0]) return;
      const targetImg = document.getElementById(id);
      const r = new FileReader();
      r.onload = (e) => { targetImg.src = e.target.result; targetImg.style.display = 'block'; };
      r.readAsDataURL(input.files[0]);
    },

    // AI OCR ë¶„ì„ ë° ì •ë°€ ë§¤í•‘ (ë¬´ê²°ì„± ê°•í™”)
    analyze: async function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      try {
        const { data: { text } } = await Tesseract.recognize(input.files[0], 'kor+eng');
        this.map(text);
      } catch(e) { console.error(e); }
      document.getElementById('loader').style.display = 'none';
    },

    map: function(t) {
      const g = (re) => (t.match(re) || ["", ""])[1]?.trim() || "";
      document.getElementById('site').value = g(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9- ]+)/) || "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('haja').value = g(/í•˜ì\s*No\s*[:\s]*(\d+)/) || g(/(\d{7,})/);
      document.getElementById('unit').value = g(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/);
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      if(t.includes("ì§„í¥")) document.getElementById('comp').value = "ì§„í¥ê±´ì—…(ì£¼)";
      if(t.includes("ì°½í˜¸")) document.getElementById('work').value = "PLì°½í˜¸ê³µì‚¬";
    },

    // ì„œë²„ ì „ì†¡ ë¡œì§ (Apps Script ì—°ë™)
    save: async function() {
      const site = document.getElementById('site').value;
      if(!site) { alert("í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

      document.getElementById('loader').style.display = 'flex';
      
      const data = {
        site: site,
        no: document.getElementById('haja').value,
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        timestamp: new Date().toLocaleString()
      };

      try {
        await fetch(this.gasUrl, {
          method: 'POST',
          mode: 'no-cors', 
          body: JSON.stringify(data)
        });
        alert("âœ… ì„œë²„ ì „ì†¡ ì™„ë£Œ!");
      } catch(e) {
        alert("âŒ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
      }
      document.getElementById('loader').style.display = 'none';
    },

    // ë©”íŠ¸ë¡œ ë³´ë“œíŒ í•©ì„± ë¡œì§
    processAfter: function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-after');
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const cvs = document.getElementById('boardCanvas');
          const ctx = cvs.getContext('2d');
          cvs.width = 800; cvs.height = 1000;
          ctx.drawImage(img, 0, 0, 800, 1000);
          ctx.fillStyle = "rgba(255,255,255,0.85)";
          ctx.fillRect(20, 780, 320, 200);
          ctx.fillStyle = "#000"; ctx.font = "bold 22px Arial";
          ctx.fillText("í˜„ì¥: " + document.getElementById('site').value, 35, 820);
          ctx.fillText("í˜¸ìˆ˜: " + document.getElementById('unit').value, 35, 860);
          ctx.fillText("ì¼ì: " + document.getElementById('date').value, 35, 900);
          document.getElementById('view-board').src = cvs.toDataURL("image/jpeg");
          document.getElementById('view-board').style.display = 'block';
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    }
  };
</script>
</body>
</html>
