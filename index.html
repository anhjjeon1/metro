<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #0c1929;
      --navy-light: #132238;
      --navy-mid: #1a2d45;
      --gold: #c8a45e;
      --gold-light: #dbb978;
      --gold-dim: #8a7340;
      --cream: #f5f0e8;
      --cream-dark: #e8e0d0;
      --white: #fefcf9;
      --red: #c0392b;
      --green: #1a8a5c;
      --green-light: #22b573;
      --blue: #2c6fbb;
      --text: #1a1a1a;
      --text-dim: #666;
      --text-muted: #999;
      --border: #d4cfc5;
      --shadow: 0 2px 12px rgba(12,25,41,0.08);
      --shadow-lg: 0 8px 32px rgba(12,25,41,0.12);
      --radius: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { height: 100vh; overflow: hidden; background: var(--cream); }

    body {
      font-family: 'Noto Sans KR', 'Outfit', sans-serif;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--white);
      box-shadow: var(--shadow-lg);
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--navy);
      color: var(--cream);
      text-align: center;
      padding: 14px 16px;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--gold-dim));
    }

    header h1 {
      font-family: 'Outfit', sans-serif;
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--cream);
    }

    header .ver {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      color: var(--gold);
      letter-spacing: 3px;
      margin-top: 2px;
      font-weight: 500;
    }

    /* â”€â”€ CONTENT â”€â”€ */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    /* â”€â”€ SECTION CARDS â”€â”€ */
    .section {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .section-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .section-head .badge {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .badge-navy { background: var(--navy); color: var(--gold); }
    .badge-gold { background: var(--gold); color: var(--navy); }
    .badge-green { background: var(--green); color: white; }

    .section-head h3 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--navy);
      letter-spacing: 0.3px;
    }

    .section-head .sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    /* â”€â”€ INPUTS â”€â”€ */
    .field {
      margin-bottom: 8px;
    }

    .field input, .field select, .field textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.8rem;
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--white);
      color: var(--text);
      transition: border-color 0.2s;
      outline: none;
    }

    .field input:focus, .field select:focus, .field textarea:focus {
      border-color: var(--navy);
    }

    .field input::placeholder { color: var(--text-muted); }

    .field label {
      display: block;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--gold-dim);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field textarea {
      height: 80px;
      resize: none;
      line-height: 1.5;
    }

    .field-row {
      display: grid;
      gap: 8px;
    }

    .field-row.c2 { grid-template-columns: 1fr 1fr; }
    .field-row.c3 { grid-template-columns: 1fr 1fr 1fr; }
    .field-row.c4-2 { grid-template-columns: 2fr 1fr; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn {
      width: 100%;
      padding: 11px;
      border: none;
      border-radius: var(--radius);
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 800;
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.15s ease;
      letter-spacing: 0.3px;
    }

    .btn:active { transform: scale(0.98); }

    .btn-navy {
      background: var(--navy);
      color: var(--gold);
    }

    .btn-gold {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
      color: var(--navy);
    }

    .btn-green {
      background: var(--green);
      color: white;
    }

    .btn-red {
      background: var(--red);
      color: white;
    }

    .btn-outline {
      background: transparent;
      color: var(--text-dim);
      border: 1.5px solid var(--border);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.65rem;
      width: auto;
    }

    /* â”€â”€ DROPZONE â”€â”€ */
    .dropzone {
      width: 100%;
      aspect-ratio: 4/3;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      margin-bottom: 12px;
      background: var(--cream);
      transition: all 0.2s;
    }

    .dropzone:active { background: var(--cream-dark); }

    .dropzone .label {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-dim);
      text-align: center;
      z-index: 2;
      pointer-events: none;
    }

    .dropzone .label .num {
      display: inline-flex;
      width: 22px;
      height: 22px;
      align-items: center;
      justify-content: center;
      background: var(--navy);
      color: var(--gold);
      border-radius: 50%;
      font-size: 0.65rem;
      margin-right: 4px;
      vertical-align: middle;
    }

    .dropzone img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #111;
      display: none;
      z-index: 5;
    }

    /* â”€â”€ DATA TABLE (input form) â”€â”€ */
    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* â”€â”€ NOTICE BOX â”€â”€ */
    .notice {
      background: var(--cream);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 0.7rem;
      line-height: 1.6;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .notice strong { color: var(--navy); }

    .notice details summary {
      cursor: pointer;
      font-weight: 700;
      color: var(--navy);
      margin-top: 6px;
    }

    .notice details div {
      margin-top: 6px;
      padding-left: 10px;
      border-left: 2px solid var(--gold);
      font-size: 0.65rem;
    }

    /* â”€â”€ OCR ENGINE TOGGLE â”€â”€ */
    .ocr-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .ocr-toggle button {
      flex: 1;
      padding: 8px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      background: var(--white);
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .ocr-toggle button.active {
      background: var(--navy);
      color: var(--gold);
      border-color: var(--navy);
    }

    /* â”€â”€ SPREADSHEET TABLE â”€â”€ */
    .sheet-section {
      margin-top: 20px;
      margin-bottom: 30px;
    }

    .sheet-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .sheet-head h3 {
      font-size: 0.85rem;
      font-weight: 800;
      color: var(--navy);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sheet-head h3 .count {
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--text-muted);
    }

    .sheet-actions {
      display: flex;
      gap: 4px;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--white);
      -webkit-overflow-scrolling: touch;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    #spreadsheet {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.62rem;
      min-width: 1100px;
    }

    #spreadsheet th {
      background: var(--navy);
      color: var(--gold);
      padding: 10px 6px;
      border: 1px solid var(--navy-light);
      font-weight: 700;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.6rem;
    }

    #spreadsheet td {
      padding: 8px 6px;
      border: 1px solid #eee;
      text-align: center;
      vertical-align: middle;
      font-size: 0.62rem;
      color: var(--text);
    }

    #spreadsheet tbody tr:nth-child(even) { background: var(--cream); }
    #spreadsheet tbody tr:hover { background: #e8e4d8; }

    .thumb {
      width: 50px;
      height: 38px;
      object-fit: cover;
      border-radius: 3px;
      border: 1px solid var(--border);
      display: block;
      margin: 0 auto;
    }

    .empty-row td {
      padding: 30px;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* â”€â”€ LOADER â”€â”€ */
    #loader {
      position: fixed;
      inset: 0;
      background: rgba(12, 25, 41, 0.95);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: var(--cream);
    }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--navy-mid);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #loader p {
      margin-top: 14px;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--gold);
      letter-spacing: 0.5px;
    }

    #loader .progress {
      width: 200px;
      height: 3px;
      background: var(--navy-mid);
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
    }

    #loader .progress-fill {
      height: 100%;
      background: var(--gold);
      width: 0%;
      transition: width 0.3s;
      border-radius: 2px;
    }

    /* â”€â”€ FOOTER â”€â”€ */
    footer {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--white);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }

    footer button {
      flex: 1;
      height: 50px;
      border-radius: var(--radius);
      border: none;
      font-weight: 800;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
      letter-spacing: 0.5px;
      transition: all 0.15s;
    }

    footer button:active { transform: scale(0.97); }

    .btn-save-main {
      background: var(--navy);
      color: var(--gold);
    }

    .btn-refresh-main {
      background: var(--cream);
      color: var(--navy);
      border: 1.5px solid var(--border);
    }

    /* â”€â”€ STATUS TOAST â”€â”€ */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 20px;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success { background: var(--green); color: white; }
    .toast.error { background: var(--red); color: white; }
    .toast.info { background: var(--navy); color: var(--gold); }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 480px) {
      .content { padding: 12px; }
      header h1 { font-size: 1.05rem; }
    }
  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="spinner"></div>
  <p id="loaderText">OCR ë¶„ì„ ì¤‘...</p>
  <div class="progress"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<div class="app">
  <!-- HEADER -->
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R &amp; S AI</h1>
    <div class="ver">VER 4.0 Â· ULTIMATE SPREADSHEET</div>
  </header>

  <main class="content">

    <!-- â‘  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì • -->
    <div class="section">
      <div class="section-head">
        <span class="badge badge-navy">ğŸ“Š</span>
        <div>
          <h3>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™</h3>
          <span class="sub">Apps Script ì›¹ì•± URL ì…ë ¥</span>
        </div>
      </div>
      <div class="field">
        <label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
        <input type="text" id="spreadsheetId" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID" value="1U915mN26A8E51BueKHWLZF105jcMn529kluYhqHlC8c">
      </div>
      <div class="field">
        <label>ì‹œíŠ¸ ì´ë¦„</label>
        <input type="text" id="sheetName" placeholder="ì‹œíŠ¸1" value="ì‹œíŠ¸1">
      </div>
      <div class="notice" style="margin-top:8px;">
        <strong>â„¹ï¸ ì°¸ê³ :</strong> CORS ì •ì±…ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì—°ê²°ì´ ì œí•œë©ë‹ˆë‹¤.<br>
        ë°ì´í„°ëŠ” <strong>ë¡œì»¬ DBì— ì•ˆì „í•˜ê²Œ ì €ì¥</strong>ë˜ë©° í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- â‘¡ OCR ì—”ì§„ ì„¤ì • -->
    <div class="section">
      <div class="section-head">
        <span class="badge badge-gold">ğŸ”‘</span>
        <div>
          <h3>OCR ì—”ì§„ ì„¤ì •</h3>
          <span class="sub">í…ìŠ¤íŠ¸ ì¸ì‹ ë°©ë²• ì„ íƒ</span>
        </div>
      </div>

      <div class="ocr-toggle" id="ocrToggle">
        <button class="active" data-engine="tesseract" onclick="App.setOcrEngine('tesseract')">
          ğŸ†“ Tesseract.js<br><small style="font-weight:400;">ë¬´ë£Œ Â· ë¡œì»¬ ì²˜ë¦¬</small>
        </button>
        <button data-engine="vision" onclick="App.setOcrEngine('vision')">
          â˜ï¸ Google Vision<br><small style="font-weight:400;">ê³ ì •ë°€ Â· API í‚¤ í•„ìš”</small>
        </button>
      </div>

      <div id="visionKeySection" style="display:none;">
        <div class="field">
          <label>Google Vision API í‚¤</label>
          <input type="text" id="visionApiKey" placeholder="API í‚¤ ì…ë ¥">
        </div>
        <button class="btn btn-gold btn-sm" onclick="App.saveApiKey()" style="width:100%; margin-top:4px;">ğŸ’¾ API í‚¤ ì €ì¥</button>
        <div class="notice" style="margin-top:8px;">
          <details>
            <summary>ğŸ“– API í‚¤ ë°œê¸‰ ë°©ë²•</summary>
            <div>
              <strong>1.</strong> <a href="https://console.cloud.google.com" target="_blank" style="color:var(--blue);">Google Cloud Console</a> ì ‘ì†<br>
              <strong>2.</strong> í”„ë¡œì íŠ¸ ìƒì„± â†’ API ë° ì„œë¹„ìŠ¤ â†’ ë¼ì´ë¸ŒëŸ¬ë¦¬<br>
              <strong>3.</strong> "Cloud Vision API" ì‚¬ìš© ì„¤ì •<br>
              <strong>4.</strong> ì‚¬ìš©ì ì¸ì¦ ì •ë³´ â†’ API í‚¤ ìƒì„± â†’ ë³µì‚¬
            </div>
          </details>
        </div>
      </div>
    </div>

    <!-- â‘¢ ì™„ë£Œí™•ì¸ì„œ OCR -->
    <div class="dropzone" onclick="$('f-ai').click()">
      <div class="label"><span class="num">1</span> ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ Â· OCR ë¶„ì„</div>
      <img id="view-ai">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" hidden onchange="App.analyze(this)">

    <button class="btn btn-navy" onclick="App.retryOCR()" style="margin-bottom:14px;">ğŸ”„ OCR ì¬ì‹œë„</button>

    <!-- â‘£ ë°ì´í„° ì…ë ¥ í¼ -->
    <div class="section">
      <div class="section-head">
        <span class="badge badge-navy">ğŸ“</span>
        <h3>ì‘ì—… ë°ì´í„° ì…ë ¥</h3>
      </div>
      <div class="form-grid">
        <div class="field-row c4-2">
          <div class="field"><label>í˜„ì¥ëª…</label><input type="text" id="site"></div>
          <div class="field"><label>í•˜ìNo</label><input type="text" id="haja"></div>
        </div>
        <div class="field-row c2">
          <div class="field"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></div>
          <div class="field"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></div>
        </div>
        <div class="field-row c3">
          <div class="field"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></div>
          <div class="field"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></div>
          <div class="field"><label>ê³µì¢…</label><input type="text" id="work"></div>
        </div>
        <div class="field-row c2">
          <div class="field"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></div>
          <div class="field"><label>í™•ì¸ì</label><input type="text" id="name"></div>
        </div>
        <div class="field">
          <label>ìƒì„¸ í•˜ì ë‚´ìš©</label>
          <textarea id="memo" placeholder="í•˜ì ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
      </div>
      <button class="btn btn-outline" onclick="App.clearForm()" style="margin-top:10px;">ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <!-- â‘¤ ìˆ˜ë¦¬ ì „ ì‚¬ì§„ -->
    <div class="dropzone" onclick="$('f-before').click()">
      <div class="label"><span class="num">2</span> ìˆ˜ë¦¬ ì „ ì‚¬ì§„</div>
      <img id="view-before">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" hidden onchange="App.preview(this,'view-before')">

    <!-- â‘¥ ìˆ˜ë¦¬ í›„ ì‚¬ì§„ -->
    <div class="dropzone" onclick="$('f-after').click()">
      <div class="label"><span class="num">3</span> ìˆ˜ë¦¬ í›„ ì‚¬ì§„</div>
      <img id="view-after">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" hidden onchange="App.processAfter(this)">

    <!-- â‘¦ ë©”íŠ¸ë¡œ ë³´ë“œíŒ -->
    <div class="dropzone" style="border-style:solid; border-color:var(--green);">
      <div class="label" style="color:var(--green);"><span class="num" style="background:var(--green);color:white;">4</span> ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„±</div>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board">
    </div>

    <!-- â‘§ ìµœì¢… ì™„ë£Œí™•ì¸ì„œ -->
    <div class="dropzone" onclick="$('f-final').click()">
      <div class="label"><span class="num">5</span> ìµœì¢… ì™„ë£Œí™•ì¸ì„œ (ì„œëª…ë³¸)</div>
      <img id="view-final">
    </div>
    <input type="file" id="f-final" accept="image/*" capture="camera" hidden onchange="App.preview(this,'view-final')">

    <!-- â‘¨ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ -->
    <section class="sheet-section">
      <div class="sheet-head">
        <h3>ğŸ“Š ì‘ì—… ë°ì´í„° ë¦¬ìŠ¤íŠ¸ <span class="count" id="dataCount">(0ê±´)</span></h3>
        <div class="sheet-actions">
          <button class="btn btn-sm btn-outline" onclick="App.render()">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn btn-sm btn-red" onclick="App.deleteDB()">DB ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="spreadsheet">
          <thead>
            <tr>
              <th>í˜„ì¥ëª…</th><th>í•˜ìNo</th><th>ë™/í˜¸ìˆ˜</th><th>ì ‘ìˆ˜ì¼</th>
              <th>ë‹¨ê³„</th><th>ìœ„ì¹˜</th><th>ê³µì¢…</th><th>ì—…ì²´ëª…</th>
              <th>í™•ì¸ì</th><th>í•˜ìë‚´ìš©</th><th>ì „</th><th>í›„</th>
              <th>ë³´ë“œíŒ</th><th>í™•ì¸ì„œ</th>
            </tr>
          </thead>
          <tbody id="data-body">
            <tr class="empty-row"><td colspan="14">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer>
    <button class="btn-save-main" onclick="App.save()">ğŸ’¾ ì €ì¥</button>
    <button class="btn-refresh-main" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
// â”€â”€â”€ UTILS â”€â”€â”€
const $ = id => document.getElementById(id);
const DB_KEY = 'METRO_DB_V4';
const API_KEY_STORE = 'METRO_VISION_KEY';

// â”€â”€â”€ APP MODULE â”€â”€â”€
const App = {
  ocrEngine: 'tesseract',

  // â”€â”€ ì´ˆê¸°í™” â”€â”€
  init() {
    this.loadApiKey();
    this.render();
    $('date').valueAsDate = new Date();
  },

  // â”€â”€ TOAST ì•Œë¦¼ â”€â”€
  toast(msg, type = 'info', ms = 3000) {
    const el = $('toast');
    el.textContent = msg;
    el.className = `toast ${type} show`;
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), ms);
  },

  // â”€â”€ LOADER â”€â”€
  showLoader(text = 'OCR ë¶„ì„ ì¤‘...') {
    $('loaderText').textContent = text;
    $('progressFill').style.width = '0%';
    $('loader').style.display = 'flex';
  },

  hideLoader() {
    $('loader').style.display = 'none';
  },

  setProgress(pct) {
    $('progressFill').style.width = pct + '%';
  },

  // â”€â”€ OCR ì—”ì§„ ì„ íƒ â”€â”€
  setOcrEngine(engine) {
    this.ocrEngine = engine;
    document.querySelectorAll('#ocrToggle button').forEach(b => {
      b.classList.toggle('active', b.dataset.engine === engine);
    });
    $('visionKeySection').style.display = engine === 'vision' ? 'block' : 'none';
  },

  // â”€â”€ API í‚¤ â”€â”€
  saveApiKey() {
    const key = $('visionApiKey').value.trim();
    if (!key) return this.toast('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    localStorage.setItem(API_KEY_STORE, key);
    this.toast('âœ… API í‚¤ ì €ì¥ ì™„ë£Œ!', 'success');
  },

  loadApiKey() {
    const key = localStorage.getItem(API_KEY_STORE);
    if (key) {
      $('visionApiKey').value = key;
    }
  },

  getApiKey() {
    return localStorage.getItem(API_KEY_STORE) || '';
  },

  // â”€â”€ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° â”€â”€
  preview(input, imgId) {
    const file = input.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = $(imgId);
      img.src = e.target.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  },

  // â”€â”€ OCR ë¶„ì„ (ë©”ì¸) â”€â”€
  async analyze(input) {
    const file = input.files?.[0];
    if (!file) return;
    this.preview(input, 'view-ai');
    this.showLoader('OCR ë¶„ì„ ì¤‘...');

    try {
      let text = null;

      if (this.ocrEngine === 'vision' && this.getApiKey()) {
        this.setProgress(20);
        text = await this.ocrVision(file);
      }

      if (!text) {
        this.setProgress(20);
        text = await this.ocrTesseract(file);
      }

      if (text && text.length > 5) {
        this.mapOcrText(text);
        this.hideLoader();
        this.toast('âœ… OCR ë¶„ì„ ì™„ë£Œ!', 'success');
      } else {
        throw new Error('í…ìŠ¤íŠ¸ ì¸ì‹ ì‹¤íŒ¨');
      }
    } catch (err) {
      console.warn('OCR ì‹¤íŒ¨:', err.message);
      this.fillSample();
      this.hideLoader();
      this.toast('âš ï¸ OCR ì‹¤íŒ¨ â†’ ìƒ˜í”Œ ë°ì´í„° ì…ë ¥ë¨', 'error', 4000);
    }
  },

  // â”€â”€ Google Vision OCR â”€â”€
  async ocrVision(file) {
    const key = this.getApiKey();
    if (!key) return null;

    const b64 = await this.fileToBase64(file);
    const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        requests: [{ image: { content: b64 }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }]
      })
    });

    if (!res.ok) throw new Error(`Vision API ${res.status}`);
    const data = await res.json();
    this.setProgress(80);
    return data.responses?.[0]?.fullTextAnnotation?.text || null;
  },

  // â”€â”€ Tesseract.js OCR â”€â”€
  async ocrTesseract(file) {
    if (typeof Tesseract === 'undefined') throw new Error('Tesseract ë¯¸ë¡œë“œ');

    const result = await Tesseract.recognize(file, 'kor+eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          this.setProgress(20 + Math.round(m.progress * 60));
        }
      }
    });

    this.setProgress(90);
    return result.data?.text || null;
  },

  // â”€â”€ OCR ì¬ì‹œë„ â”€â”€
  retryOCR() {
    const input = $('f-ai');
    if (!input.files?.length) return this.toast('ë¨¼ì € ì™„ë£Œí™•ì¸ì„œ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
    this.analyze(input);
  },

  // â”€â”€ File â†’ Base64 â”€â”€
  fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result.split(',')[1]);
      reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
      reader.readAsDataURL(file);
    });
  },

  // â”€â”€ OCR í…ìŠ¤íŠ¸ ë§¤í•‘ â”€â”€
  mapOcrText(t) {
    const extract = re => (t.match(re) || ['', ''])[1]?.trim() || '';

    $('site').value = extract(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9A-Za-z\- ]+)/) || '';
    $('haja').value = extract(/í•˜ì\s*No\s*[:\s]*(\d+)/) || extract(/(\d{7})/);
    $('unit').value = extract(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/) || '';
    $('date').value = extract(/(\d{4}-\d{2}-\d{2})/) || new Date().toISOString().split('T')[0];

    const STEPS = ['1ë…„ì°¨', '2ë…„ì°¨', '3ë…„ì°¨'];
    const LOCS = ['ê±°ì‹¤', 'ì•ˆë°©', 'ì¹¨ì‹¤1', 'ì¹¨ì‹¤2', 'ì¹¨ì‹¤3', 'ë°œì½”ë‹ˆ1', 'ë°œì½”ë‹ˆ2', 'ì•ŒíŒŒë£¸'];
    const WORKS = ['PLì°½í˜¸ê³µì‚¬', 'ë„ë°°ê³µì‚¬', 'íƒ€ì¼ê³µì‚¬', 'ë°”ë‹¥ê³µì‚¬'];

    const lines = t.split('\n');
    lines.forEach((line, i) => {
      const c = line.replace(/\s/g, '');
      const nextLine = lines[i + 1]?.trim() || '';

      if (c.includes('ì ‘ìˆ˜ë‹¨ê³„')) {
        const v = line.split(/[:\s]/).filter(x => x && !x.includes('ì ‘ìˆ˜ë‹¨ê³„')).pop() || nextLine;
        $('step').value = STEPS.find(s => v?.includes(s)) || v || '';
      }
      if (c.includes('ì‹¤ëª…') || (c.includes('ìœ„ì¹˜') && !c.includes('ìƒì„¸'))) {
        const v = line.split(/[:\s]/).filter(x => x && !x.includes('ì‹¤ëª…') && !x.includes('ìœ„ì¹˜')).pop() || nextLine;
        $('loc').value = LOCS.find(s => v?.includes(s)) || v || '';
      }
      if (c.includes('ê³µì¢…')) {
        const v = line.split(/[:\s]/).filter(x => x && !x.includes('ê³µì¢…')).pop() || nextLine;
        $('work').value = WORKS.find(s => v?.includes(s)) || v || '';
      }
      if (c.includes('ì—…ì²´ëª…') || c.includes('ì—…ì²´')) {
        const v = line.split(/[:\s]/).filter(x => x && !x.includes('ì—…ì²´ëª…') && !x.includes('ì—…ì²´')).pop() || nextLine;
        $('comp').value = v || '';
      }
      if (c.includes('í™•ì¸ì') || c.includes('ë‹´ë‹¹ì')) {
        const v = line.split(/[:\s]/).filter(x => x && !x.includes('í™•ì¸ì') && !x.includes('ë‹´ë‹¹ì')).pop() || nextLine;
        $('name').value = v || '';
      }
    });

    const memoIdx = t.indexOf('í•˜ìë‚´ìš©');
    if (memoIdx !== -1) {
      $('memo').value = t.substring(memoIdx + 4, memoIdx + 300).replace(/\n/g, ' ').trim();
    }
  },

  // â”€â”€ ìƒ˜í”Œ ë°ì´í„° â”€â”€
  fillSample() {
    const d = { site: 'ì›ì£¼í˜ì‹ C4BL', haja: '2024001', unit: '101ë™ 1001í˜¸', step: '1ë…„ì°¨', loc: 'ê±°ì‹¤', work: 'PLì°½í˜¸ê³µì‚¬', comp: 'ì§„í¥ê±´ì—…(ì£¼)', name: '', memo: '' };
    Object.entries(d).forEach(([k, v]) => { if ($(k)) $(k).value = v; });
    $('date').value = new Date().toISOString().split('T')[0];
  },

  // â”€â”€ ìˆ˜ë¦¬ í›„ ì‚¬ì§„ â†’ ë³´ë“œíŒ ìƒì„± â”€â”€
  processAfter(input) {
    const file = input.files?.[0];
    if (!file) return;
    this.preview(input, 'view-after');

    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => this.drawBoard(img);
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  },

  drawBoard(img) {
    const cvs = $('boardCanvas');
    const ctx = cvs.getContext('2d');
    cvs.width = 1200;
    cvs.height = 1600;
    ctx.drawImage(img, 0, 0, 1200, 1600);

    const bW = 460, bH = 360, sX = 45, sY = 1600 - bH - 45;

    // ë°°ê²½
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.fillRect(sX, sY, bW, bH);
    ctx.strokeStyle = '#0c1929';
    ctx.lineWidth = 5;
    ctx.strokeRect(sX, sY, bW, bH);

    // í—¤ë”
    const headers = ['í˜„ì¥ëª…', 'ë™/í˜¸ìˆ˜', 'ìœ„ì¹˜', 'ì‘ì—…ì§„í–‰', 'ì‘ì—…ì¼'];
    ctx.fillStyle = '#0c1929';
    ctx.font = 'bold 28px sans-serif';

    const rowH = bH / 5;
    headers.forEach((h, i) => {
      const y = sY + rowH * i;
      if (i > 0) {
        ctx.beginPath();
        ctx.moveTo(sX, y);
        ctx.lineTo(sX + bW, y);
        ctx.stroke();
      }
      ctx.fillText(h, sX + 15, y + 42);
    });

    // ê°’
    const val = id => $(id).value || '-';
    ctx.font = '26px sans-serif';
    ctx.fillStyle = '#333';
    ctx.fillText(val('site'), sX + 155, sY + 42);
    ctx.fillText(val('unit'), sX + 155, sY + rowH + 42);
    ctx.fillText(val('loc'), sX + 155, sY + rowH * 2 + 42);
    ctx.fillText('ìˆ˜ë¦¬í›„', sX + 155, sY + rowH * 3 + 42);
    ctx.fillText(val('date'), sX + 155, sY + rowH * 4 + 42);

    const boardImg = $('view-board');
    boardImg.src = cvs.toDataURL('image/jpeg', 0.9);
    boardImg.style.display = 'block';

    this.toast('âœ… ë³´ë“œíŒ ìë™ í•©ì„± ì™„ë£Œ', 'success');
  },

  // â”€â”€ í¼ ì´ˆê¸°í™” â”€â”€
  clearForm() {
    if (!confirm('ì…ë ¥ì¹¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    ['site', 'haja', 'unit', 'date', 'step', 'loc', 'work', 'comp', 'name', 'memo'].forEach(id => {
      if ($(id)) $(id).value = '';
    });
    ['view-ai', 'view-before', 'view-after', 'view-board', 'view-final'].forEach(id => {
      const img = $(id);
      if (img) { img.src = ''; img.style.display = 'none'; }
    });
    $('date').valueAsDate = new Date();
    this.toast('ì´ˆê¸°í™” ì™„ë£Œ', 'info');
  },

  // â”€â”€ ë°ì´í„° ì €ì¥ â”€â”€
  async save() {
    const site = $('site').value;
    const haja = $('haja').value;
    if (!site && !haja) return this.toast('í˜„ì¥ëª… ë˜ëŠ” í•˜ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');

    const getSrc = id => {
      const el = $(id);
      return (el?.src && el.style.display !== 'none') ? el.src : '';
    };

    const data = {
      site: site,
      no: haja || '0000',
      unit: $('unit').value,
      date: $('date').value,
      step: $('step').value,
      loc: $('loc').value,
      work: $('work').value,
      comp: $('comp').value,
      name: $('name').value,
      memo: $('memo').value,
      imgBefore: getSrc('view-before'),
      imgAfter: getSrc('view-after'),
      imgBoard: getSrc('view-board'),
      imgFinal: getSrc('view-final'),
      timestamp: new Date().toLocaleString('ko-KR')
    };

    // ë¡œì»¬ DB ì €ì¥
    const list = this.loadDB();
    list.push(data);
    this.saveDB(list);

    // ë Œë”ë§
    this.render();

    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ìŠ¤í¬ë¡¤
    this.toast(`âœ… ì €ì¥ ì™„ë£Œ! (ì´ ${list.length}ê±´)`, 'success', 4000);
    setTimeout(() => {
      document.querySelector('.sheet-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 400);
  },

  // â”€â”€ DB í—¬í¼ â”€â”€
  loadDB() {
    try {
      return JSON.parse(localStorage.getItem(DB_KEY) || '[]');
    } catch {
      return [];
    }
  },

  saveDB(list) {
    localStorage.setItem(DB_KEY, JSON.stringify(list));
  },

  // â”€â”€ ë Œë”ë§ â”€â”€
  render() {
    const list = this.loadDB();
    const body = $('data-body');
    const count = $('dataCount');
    if (!body) return;

    count.textContent = `(${list.length}ê±´)`;

    if (!list.length) {
      body.innerHTML = '<tr class="empty-row"><td colspan="14">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
      return;
    }

    const thumbHtml = src => src ? `<img src="${src}" class="thumb" alt="ì‚¬ì§„">` : '-';

    // âš ï¸ FIX: .slice().reverse() â†’ ì›ë³¸ ë°°ì—´ ë³€ê²½ ë°©ì§€
    body.innerHTML = list.slice().reverse().map(r => `
      <tr>
        <td style="font-weight:700;">${r.site || '-'}</td>
        <td style="color:var(--blue);">${r.no || '-'}</td>
        <td>${r.unit || '-'}</td>
        <td style="font-size:0.58rem;">${r.date || '-'}</td>
        <td>${r.step || '-'}</td>
        <td>${r.loc || '-'}</td>
        <td>${r.work || '-'}</td>
        <td>${r.comp || '-'}</td>
        <td>${r.name || '-'}</td>
        <td style="text-align:left;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.memo || '-'}</td>
        <td>${thumbHtml(r.imgBefore)}</td>
        <td>${thumbHtml(r.imgAfter)}</td>
        <td>${thumbHtml(r.imgBoard)}</td>
        <td>${thumbHtml(r.imgFinal)}</td>
      </tr>
    `).join('');
  },

  // â”€â”€ DB ì´ˆê¸°í™” â”€â”€
  deleteDB() {
    if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    localStorage.removeItem(DB_KEY);
    this.render();
    this.toast('DB ì´ˆê¸°í™” ì™„ë£Œ', 'info');
  }
};

// â”€â”€ í˜ì´ì§€ ë¡œë“œ â”€â”€
window.onload = () => App.init();
</script>
</body>
</html>
