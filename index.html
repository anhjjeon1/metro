<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI v6.2</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{
      --navy:#0c1929;--navy-light:#162d4a;--navy-mid:#1e3a5f;
      --gold:#c8a45e;--gold-dim:#8a7340;--gold-pale:#f5edd8;
      --cream:#faf7f0;--white:#fefcf9;
      --red:#c0392b;--red-light:#fdf0ee;
      --green:#1a8a5c;--green-light:#eef8f3;
      --blue:#2c6fbb;--blue-light:#eef4fb;
      --text:#1a1a1a;--text-sub:#555;--text-dim:#888;--text-muted:#bbb;
      --border:#e0dbd0;--border-light:#eee9df;
      --shadow:0 2px 12px rgba(12,25,41,.08);--shadow-lg:0 8px 32px rgba(12,25,41,.12);
      --r:8px;--r-sm:5px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body,html{height:100vh;overflow:hidden;background:#e8e3d8}
    body{font-family:'Noto Sans KR','Outfit',sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:520px;margin:0 auto;height:100%;display:flex;flex-direction:column;background:var(--cream);box-shadow:var(--shadow-lg)}

    header{background:var(--navy);color:var(--cream);text-align:center;padding:11px 16px;position:relative;flex-shrink:0}
    header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
    header h1{font-family:'Outfit';font-size:1.1rem;font-weight:800;letter-spacing:2.5px;text-transform:uppercase}
    header .ver{font-family:'JetBrains Mono';font-size:.55rem;color:var(--gold);letter-spacing:3px;margin-top:1px}

    .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:10px}
    .content::-webkit-scrollbar{width:3px}
    .content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

    .sec{padding:12px 16px;border-bottom:1px solid var(--border-light)}
    .sec-head{display:flex;align-items:center;gap:7px;margin-bottom:10px}
    .sec-num{width:22px;height:22px;border-radius:50%;background:var(--navy);color:var(--gold);font-family:'Outfit';font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .sec-title{font-size:.8rem;font-weight:800;color:var(--navy)}
    .sec-sub{font-size:.58rem;color:var(--text-dim);margin-left:4px}

    .upload-area{border:2px dashed var(--border);border-radius:var(--r);padding:14px;text-align:center;cursor:pointer;background:var(--white);transition:all .2s}
    .upload-area:active{background:var(--gold-pale);border-color:var(--gold)}
    .upload-area.loaded{border-style:solid;border-color:var(--green);background:var(--green-light)}
    .upload-icon{font-size:22px;margin-bottom:2px}
    .upload-text{font-size:.7rem;color:var(--text-sub);font-weight:600}
    .upload-hint{font-size:.56rem;color:var(--text-dim);margin-top:2px}
    .loaded-info{display:none;font-size:.68rem;font-weight:700;color:var(--green)}
    .upload-area.loaded .loaded-info{display:block}
    .upload-area.loaded .upload-icon,.upload-area.loaded .upload-text,.upload-area.loaded .upload-hint{display:none}

    /* FORM */
    .form-grid{display:flex;flex-direction:column;gap:6px}
    .form-row{display:grid;gap:6px}
    .form-row.c2{grid-template-columns:1fr 1fr}
    .form-row.c2-1{grid-template-columns:2fr 1fr}

    .field label{display:block;font-size:.52rem;font-weight:700;color:var(--gold-dim);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}
    .field input,.field textarea{
      width:100%;padding:9px 10px;border:1.5px solid var(--border);border-radius:var(--r-sm);
      font-size:.8rem;font-family:'Noto Sans KR';font-weight:600;background:var(--white);
      color:var(--text);outline:none;transition:border-color .2s;
    }
    .field input:focus,.field textarea:focus{border-color:var(--navy)}
    .field input::placeholder,.field textarea::placeholder{color:var(--text-muted);font-weight:400}
    .field textarea{height:50px;resize:none;line-height:1.4;font-size:.72rem}

    .field.auto input,.field.auto textarea{background:#eef4fb;border-color:#b8d4f0;color:var(--blue)}
    .field.auto label{color:var(--blue)}
    .field.auto label::after{content:' âš¡ìë™';font-weight:400;color:var(--text-muted);font-size:.45rem}

    .field.locked input{background:#e8f5e9;border-color:#4caf50;color:var(--green)}

    .match-info{padding:6px 10px;border-radius:var(--r-sm);font-size:.58rem;font-weight:600;margin-bottom:4px;display:none}
    .match-info.found{display:block;background:var(--green-light);color:var(--green);border:1px solid #b8e6d0}
    .match-info.notfound{display:block;background:var(--red-light);color:var(--red);border:1px solid #f0c8c4}

    /* PHOTOS - í•œ ì¤„ ê°€ë¡œ ë°°ì¹˜ */
    .photo-section{margin-top:6px}
    .photo-section-label{font-size:.58rem;font-weight:700;color:var(--navy);margin-bottom:4px}
    .photo-strip{display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px}
    .photo-strip::-webkit-scrollbar{height:2px}
    .photo-strip::-webkit-scrollbar-thumb{background:var(--border)}
    .photo-item{flex:0 0 auto;width:100px;text-align:center}
    .photo-item-label{font-size:.5rem;font-weight:700;color:var(--text-dim);margin-bottom:3px}
    .photo-slot{
      width:100px;height:75px;border:2px dashed var(--border);border-radius:var(--r-sm);
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      cursor:pointer;position:relative;overflow:hidden;background:var(--cream);transition:all .15s;
    }
    .photo-slot:active{background:var(--gold-pale);border-color:var(--gold)}
    .photo-slot.filled{border-style:solid;border-color:var(--green)}
    .photo-slot .ps-icon{font-size:16px}
    .photo-slot .ps-sub{font-size:.45rem;color:var(--text-muted)}
    .photo-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;z-index:5}
    .photo-slot.filled .ps-icon,.photo-slot.filled .ps-sub{display:none}
    .photo-slot.filled img{display:block}
    .photo-del{display:none;position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:var(--red);color:white;border:none;font-size:9px;font-weight:900;cursor:pointer;z-index:10;align-items:center;justify-content:center}
    .photo-slot.filled .photo-del{display:flex}

    /* BTN */
    .btn-del-row{padding:9px;border:1.5px solid var(--red);border-radius:var(--r-sm);background:var(--red-light);color:var(--red);font-size:.65rem;font-weight:800;cursor:pointer;font-family:'Noto Sans KR';width:100%}
    .btn-del-row:active{background:var(--red);color:white}

    /* LOG */
    .log-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .log-head h3{font-size:.78rem;font-weight:800;color:var(--navy);display:flex;align-items:center;gap:6px}
    .log-count{font-size:.58rem;font-weight:400;color:var(--text-dim)}
    .btn-log-clear{padding:5px 10px;border:none;border-radius:var(--r-sm);font-size:.58rem;font-weight:800;cursor:pointer;font-family:'Noto Sans KR';background:var(--red);color:white}

    .table-wrap{width:100%;overflow-x:auto;border:1px solid var(--border);border-radius:var(--r);background:var(--white);-webkit-overflow-scrolling:touch;max-height:500px;overflow-y:auto;box-shadow:var(--shadow)}
    .log-table{width:100%;border-collapse:collapse;font-size:.52rem;min-width:1050px}
    .log-table th{background:var(--navy);color:var(--gold);padding:7px 3px;border:1px solid var(--navy-light);font-weight:700;white-space:nowrap;position:sticky;top:0;z-index:10;font-size:.5rem}
    .log-table td{padding:4px 3px;border:1px solid #eee;text-align:center;vertical-align:middle;font-size:.52rem}
    .log-table tbody tr:nth-child(even){background:var(--cream)}
    .log-table .thumb{width:40px;height:30px;object-fit:cover;border-radius:3px;border:1px solid var(--border);display:block;margin:0 auto}
    .log-table .order-num{font-weight:800;color:var(--navy);font-size:.6rem}
    .log-table .btn-del-log{padding:3px 5px;border:none;border-radius:3px;background:var(--red);color:white;font-size:.48rem;font-weight:800;cursor:pointer}
    .log-empty{text-align:center;padding:20px;color:var(--text-muted);font-size:.68rem}

    footer{display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--border);background:var(--white);padding-bottom:calc(10px + env(safe-area-inset-bottom));flex-shrink:0}
    footer button{flex:1;height:46px;border-radius:var(--r);border:none;font-weight:800;font-size:.85rem;cursor:pointer;font-family:'Noto Sans KR';letter-spacing:.5px;transition:all .15s}
    footer button:active{transform:scale(.97)}
    .btn-send{background:var(--navy);color:var(--gold)}
    .btn-new{background:var(--gold);color:var(--navy)}

    .toast{position:fixed;bottom:68px;left:50%;transform:translateX(-50%) translateY(20px);padding:9px 20px;border-radius:var(--r);font-size:.72rem;font-weight:700;z-index:10000;opacity:0;transition:all .3s;pointer-events:none;max-width:90%;text-align:center;white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{background:var(--green);color:white}
    .toast.error{background:var(--red);color:white}
    .toast.info{background:var(--navy);color:var(--gold)}

    #loader{position:fixed;inset:0;background:rgba(12,25,41,.92);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center}
    .spinner{width:38px;height:38px;border:3px solid var(--navy-mid);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #loader p{margin-top:10px;font-weight:700;font-size:.8rem;color:var(--gold)}
    .hidden-inputs{position:absolute;width:0;height:0;overflow:hidden}
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loaderText">ì²˜ë¦¬ ì¤‘...</p></div>
<div class="toast" id="toast"></div>

<div class="app">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R &amp; S AI</h1>
    <div class="ver">VER 6.2 Â· FIELD WORK SYSTEM</div>
  </header>

  <main class="content">

    <!-- â‘  í•˜ì ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div class="sec">
      <div class="sec-head">
        <span class="sec-num">1</span>
        <span class="sec-title">í•˜ì ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</span>
        <span class="sec-sub">ìë™ì…ë ¥ìš©</span>
      </div>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">íŒŒì¼ ì—…ë¡œë“œ (ì—‘ì…€/CSV)</div>
        <div class="upload-hint">ì›ë“œë¼ì´ë¸Œ Â· êµ¬ê¸€ë“œë¼ì´ë¸Œ Â· ë‚´ íŒŒì¼ì—ì„œ ì„ íƒ</div>
        <div class="loaded-info" id="loadedInfo">âœ… <span id="loadedFileName"></span> Â· <span id="loadedRowCount"></span>ê±´</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv,*/*" hidden onchange="App.loadFile(this)">
      <button style="width:100%;margin-top:6px;padding:7px;border:1.5px solid var(--border);border-radius:var(--r-sm);background:var(--white);font-size:.6rem;font-weight:700;color:var(--text-dim);cursor:pointer;font-family:'Noto Sans KR'" onclick="App.loadSample()">ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <!-- â‘¡ í˜„ì¥ ì…ë ¥ -->
    <div class="sec">
      <div class="sec-head">
        <span class="sec-num">2</span>
        <span class="sec-title">í˜„ì¥ ì…ë ¥</span>
        <span class="sec-sub">ë™/í˜¸ ì…ë ¥ ì‹œ ìë™ë§¤ì¹­</span>
      </div>

      <div class="form-grid">
        <!-- í˜„ì¥ëª… (ê³ ì •) -->
        <div class="form-row c2-1">
          <div class="field" id="siteField"><label>í˜„ì¥ëª… <span id="siteLock" style="display:none;color:var(--green);font-size:.45rem">ğŸ”’ê³ ì •</span></label><input type="text" id="fSite" placeholder="í˜„ì¥ëª… ì…ë ¥" onblur="App.lockSite()"></div>
          <div style="display:flex;align-items:end"><button class="btn-del-row" onclick="App.unlockSite()" style="font-size:.58rem;padding:7px">âœï¸ ë³€ê²½</button></div>
        </div>

        <!-- ë™ / í˜¸ (ìˆ˜ë™ â†’ ìë™ë§¤ì¹­ íŠ¸ë¦¬ê±°) -->
        <div class="form-row c2">
          <div class="field"><label>ë™</label><input type="text" id="fDong" placeholder="101" inputmode="numeric" oninput="App.doMatch()"></div>
          <div class="field"><label>í˜¸</label><input type="text" id="fHo" placeholder="101" inputmode="numeric" oninput="App.doMatch()"></div>
        </div>

        <!-- ë§¤ì¹­ ê²°ê³¼ -->
        <div class="match-info" id="matchInfo"></div>

        <!-- ìœ„ì¹˜ / ê³µì¢… (ìë™) -->
        <div class="form-row c2">
          <div class="field auto"><label>ìœ„ì¹˜</label><input type="text" id="fLoc" placeholder="ìë™ / ì§ì ‘ì…ë ¥"></div>
          <div class="field auto"><label>ê³µì¢…</label><input type="text" id="fWork" placeholder="ìë™ / ì§ì ‘ì…ë ¥"></div>
        </div>

        <!-- ìœ í˜• / ì‹œê³µì—…ì²´ (ìë™) -->
        <div class="form-row c2">
          <div class="field auto"><label>ìœ í˜•</label><input type="text" id="fType" placeholder="ìë™ / ì§ì ‘ì…ë ¥"></div>
          <div class="field auto"><label>ì‹œê³µì—…ì²´</label><input type="text" id="fComp" placeholder="ìë™ / ì§ì ‘ì…ë ¥"></div>
        </div>

        <!-- í•˜ìë‚´ìš© (ìë™) -->
        <div class="field auto"><label>í•˜ìë‚´ìš©</label><textarea id="fMemo" placeholder="ìë™ / ì§ì ‘ì…ë ¥"></textarea></div>

        <!-- ì‚¬ì§„ í•œ ì¤„ ê°€ë¡œ ë°°ì¹˜ -->
        <div class="photo-section">
          <div class="photo-section-label">ğŸ“¸ ì‚¬ì§„ ì…ë ¥</div>
          <div class="photo-strip">
            <div class="photo-item">
              <div class="photo-item-label">ìˆ˜ë¦¬ ì „</div>
              <div class="photo-slot" onclick="App.takePhoto('before')">
                <span class="ps-icon">ğŸ“·</span><span class="ps-sub">ì´¬ì˜</span>
                <img id="imgBefore"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('before')">âœ•</button>
              </div>
            </div>
            <div class="photo-item">
              <div class="photo-item-label">ìˆ˜ë¦¬ í›„</div>
              <div class="photo-slot" onclick="App.takePhoto('after')">
                <span class="ps-icon">ğŸ“·</span><span class="ps-sub">ì´¬ì˜</span>
                <img id="imgAfter"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('after')">âœ•</button>
              </div>
            </div>
            <div class="photo-item">
              <div class="photo-item-label">ì™„ë£Œí™•ì¸ì„œ</div>
              <div class="photo-slot" onclick="App.takePhoto('confirm')">
                <span class="ps-icon">ğŸ“‹</span><span class="ps-sub">ì´¬ì˜</span>
                <img id="imgConfirm"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('confirm')">âœ•</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â‘¢ ì €ì¥ ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="sec" id="secLog">
      <div class="log-head">
        <h3><span class="sec-num" style="background:var(--green)">3</span> ì €ì¥ ì™„ë£Œ <span class="log-count" id="logCount">(0ê±´)</span></h3>
        <button class="btn-log-clear" onclick="App.clearLog()">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
      </div>
      <div class="table-wrap">
        <table class="log-table">
          <thead><tr>
            <th>No</th><th>í˜„ì¥ëª…</th><th>ë™</th><th>í˜¸</th><th>ìœ„ì¹˜</th><th>ê³µì¢…</th>
            <th>ìœ í˜•</th><th>ì‹œê³µì—…ì²´</th><th>í•˜ìë‚´ìš©</th>
            <th>ìˆ˜ë¦¬ì „</th><th>ìˆ˜ë¦¬í›„</th><th>í™•ì¸ì„œ</th><th>ì™„ë£Œì¼</th><th>ì‚­ì œ</th>
          </tr></thead>
          <tbody id="logBody"><tr><td colspan="14" class="log-empty">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

  </main>

  <footer>
    <button class="btn-send" onclick="App.exportExcel()">ğŸ“¤ íŒŒì¼ì „ì†¡</button>
    <button class="btn-new" onclick="App.save()">ğŸ’¾ ì €ì¥</button>
  </footer>
</div>

<div class="hidden-inputs">
  <input type="file" id="fCapture" accept="image/*" capture="environment" onchange="App.onPhoto(this)">
</div>

<script>
var STORAGE = {LOG:'METRO_V63_LOG', SOURCE:'METRO_V63_SRC'};

var App = {
  sourceData: [],
  colMap: {},
  savedLog: [],
  photos: {before:'',after:'',confirm:''},
  pendingType: '',
  matchedRow: null,
  siteLocked: false,

  init: function() {
    this.loadSource();
    this.loadLog();
    this.renderLog();
    var s = localStorage.getItem('METRO_SITE')||'';
    if (s) { document.getElementById('fSite').value=s; this.lockSite(); }
  },

  toast: function(m,t,d) {
    t=t||'info';d=d||2500;
    var e=document.getElementById('toast');
    e.textContent=m;e.className='toast '+t+' show';
    clearTimeout(e._t);e._t=setTimeout(function(){e.classList.remove('show');},d);
  },

  // â•â•â• í˜„ì¥ëª… ê³ ì • â•â•â•
  lockSite: function() {
    var v=document.getElementById('fSite').value.trim();
    if(!v) return;
    this.siteLocked=true;
    document.getElementById('fSite').readOnly=true;
    document.getElementById('siteField').classList.add('locked');
    document.getElementById('siteLock').style.display='inline';
    localStorage.setItem('METRO_SITE',v);
  },
  unlockSite: function() {
    this.siteLocked=false;
    document.getElementById('fSite').readOnly=false;
    document.getElementById('siteField').classList.remove('locked');
    document.getElementById('siteLock').style.display='none';
    document.getElementById('fSite').focus();
    this.toast('í˜„ì¥ëª… ìˆ˜ì • ê°€ëŠ¥','info');
  },

  // â•â•â• íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° â•â•â•
  loadFile: function(input) {
    var file=input.files&&input.files[0]; if(!file) return;
    var name=file.name.toLowerCase();
    if(name.indexOf('.xlsx')<0&&name.indexOf('.xls')<0&&name.indexOf('.csv')<0){this.toast('ì—‘ì…€/CSV íŒŒì¼ë§Œ ê°€ëŠ¥','error');return;}
    var self=this;
    document.getElementById('loaderText').textContent='íŒŒì¼ ì½ëŠ” ì¤‘...';
    document.getElementById('loader').style.display='flex';
    var reader=new FileReader();
    reader.onload=function(e){
      try{
        var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        var json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
        if(!json.length) throw new Error('ë¹ˆ íŒŒì¼');
        self.sourceData=[];
        for(var i=0;i<json.length;i++){json[i]._idx=i;self.sourceData.push(json[i]);}
        self.detectCols(json[0]);
        self.saveSource();
        document.getElementById('uploadArea').classList.add('loaded');
        document.getElementById('loadedFileName').textContent=file.name;
        document.getElementById('loadedRowCount').textContent=json.length;
        self.toast('âœ… '+json.length+'ê±´ ë¡œë“œ!','success',3000);
      }catch(err){self.toast('âŒ '+err.message,'error',4000);}
      document.getElementById('loader').style.display='none';
    };
    reader.readAsArrayBuffer(file);
  },

  // â•â•â• ì»¬ëŸ¼ ê°ì§€ â•â•â•
  detectCols: function(row) {
    var keys=Object.keys(row);
    var used={};
    function find(){
      var kws=Array.prototype.slice.call(arguments);
      for(var i=0;i<keys.length;i++){if(used[keys[i]])continue;var k=keys[i].replace(/\s/g,'');for(var j=0;j<kws.length;j++){if(k===kws[j]){used[keys[i]]=true;return keys[i];}}}
      for(var i2=0;i2<keys.length;i2++){if(used[keys[i2]])continue;var k2=keys[i2].replace(/\s/g,'');for(var j2=0;j2<kws.length;j2++){if(k2.indexOf(kws[j2])>=0){used[keys[i2]]=true;return keys[i2];}}}
      return '';
    }
    this.colMap={
      dong:find('ë™','dong','Dong'),
      ho:find('í˜¸','í˜¸ìˆ˜','ho','Ho'),
      unit:find('ë™í˜¸','ë™/í˜¸','ì„¸ëŒ€'),
      site:find('í˜„ì¥ëª…','í˜„ì¥'),
      no:find('í•˜ìNo','í•˜ìë²ˆí˜¸','No','NO','ë²ˆí˜¸'),
      loc:find('ìœ„ì¹˜','ì‹¤ëª…','location'),
      work:find('ê³µì¢…','ê³µì‚¬'),
      type:find('ìœ í˜•','í•˜ììœ í˜•','type'),
      step:find('ì ‘ìˆ˜ë‹¨ê³„','ë‹¨ê³„'),
      comp:find('ì—…ì²´ëª…','ì—…ì²´','ì‹œê³µì—…ì²´','ì‹œê³µ'),
      memo:find('í•˜ìë‚´ìš©','ë‚´ìš©','ë¹„ê³ ','ìƒì„¸'),
      date:find('ì ‘ìˆ˜ì¼','ë‚ ì§œ','ì™„ë£Œì¼')
    };
    console.log('ì»¬ëŸ¼ë§¤í•‘:', JSON.stringify(this.colMap));
    console.log('í‚¤ëª©ë¡:', keys.join(', '));
  },

  gv: function(row,f){var c=this.colMap[f];return c?String(row[c]||'').trim():'';},

  parseDH: function(row){
    var d=this.gv(row,'dong'),h=this.gv(row,'ho');
    if(!d&&!h){var u=this.gv(row,'unit');var m=u.match(/(\d+)\s*ë™?\s*[-\/]?\s*(\d+)\s*í˜¸?/);if(m){d=m[1];h=m[2];}}
    return{dong:d.replace(/[^0-9]/g,''),ho:h.replace(/[^0-9]/g,'')};
  },

  // â•â•â• ë™/í˜¸ ì…ë ¥ â†’ ìë™ë§¤ì¹­ â•â•â•
  doMatch: function() {
    var qD=document.getElementById('fDong').value.trim();
    var qH=document.getElementById('fHo').value.trim();
    var info=document.getElementById('matchInfo');

    if(!this.sourceData.length){info.style.display='none';return;}
    if(!qD){info.style.display='none';this.matchedRow=null;return;}

    // ê²€ìƒ‰
    var matches=[];
    for(var i=0;i<this.sourceData.length;i++){
      var row=this.sourceData[i];
      var dh=this.parseDH(row);
      if(dh.dong!==qD) continue;
      if(qH && dh.ho!==qH) continue;
      matches.push(row);
    }

    if(matches.length>0){
      var m=matches[0];
      this.matchedRow=m;

      // â˜… ìë™ì…ë ¥: ìœ„ì¹˜, ê³µì¢…, ìœ í˜•, ì‹œê³µì—…ì²´, í•˜ìë‚´ìš©
      document.getElementById('fLoc').value  = this.gv(m,'loc')||'';
      document.getElementById('fWork').value = this.gv(m,'work')||'';
      document.getElementById('fType').value = this.gv(m,'type')||this.gv(m,'step')||'';
      document.getElementById('fComp').value = this.gv(m,'comp')||'';
      document.getElementById('fMemo').value = this.gv(m,'memo')||'';

      // í˜„ì¥ëª… ë¹„ì—ˆìœ¼ë©´ ì±„ìš°ê¸°
      if(!document.getElementById('fSite').value.trim()){
        var sv=this.gv(m,'site')||'';
        if(sv){document.getElementById('fSite').value=sv;this.lockSite();}
      }

      var loc=this.gv(m,'loc')||'';
      info.textContent='âœ… ë§¤ì¹­! '+this.gv(m,'dong')+'ë™ '+this.gv(m,'ho')+'í˜¸ '+loc+' ('+matches.length+'ê±´)';
      if(matches.length>1) info.textContent+=' â€” ì²«ë²ˆì§¸ í‘œì‹œì¤‘';
      info.className='match-info found';
    }else{
      this.matchedRow=null;
      document.getElementById('fLoc').value='';
      document.getElementById('fWork').value='';
      document.getElementById('fType').value='';
      document.getElementById('fComp').value='';
      document.getElementById('fMemo').value='';

      var hint='';
      if(this.sourceData.length>0){
        var ex=[];
        for(var s=0;s<Math.min(3,this.sourceData.length);s++){var sd=this.parseDH(this.sourceData[s]);ex.push(sd.dong+'ë™'+sd.ho+'í˜¸');}
        hint=' (ì˜ˆ: '+ex.join(', ')+')';
      }
      info.textContent='âŒ ë§¤ì¹­ì—†ìŒ (ë™:'+qD+(qH?' í˜¸:'+qH:'')+')'+hint;
      info.className='match-info notfound';
    }
  },

  // â•â•â• ì‚¬ì§„ â•â•â•
  takePhoto: function(type){
    this.pendingType=type;
    var f=document.getElementById('fCapture');f.value='';f.click();
  },
  onPhoto: function(input){
    var file=input.files&&input.files[0];
    if(!file||!this.pendingType) return;
    var type=this.pendingType,self=this;
    var reader=new FileReader();
    reader.onload=function(e){
      var img=new Image();
      img.onload=function(){
        var mW=1200,sc=img.width>mW?mW/img.width:1;
        var c=document.createElement('canvas');c.width=img.width*sc;c.height=img.height*sc;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        var b=c.toDataURL('image/jpeg',0.8);
        self.photos[type]=b;self.updateSlot(type,b);
        self.toast('âœ… ì‚¬ì§„ ì €ì¥','success',1500);
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  },
  delPhoto: function(type){this.photos[type]='';this.updateSlot(type,'');},
  updateSlot: function(type,src){
    var id=type==='before'?'imgBefore':type==='after'?'imgAfter':'imgConfirm';
    var el=document.getElementById(id),slot=el.closest('.photo-slot');
    if(src){el.src=src;el.style.display='block';slot.classList.add('filled');}
    else{el.src='';el.style.display='none';slot.classList.remove('filled');}
  },

  // â•â•â• ì €ì¥ (ì™„ë£Œì¼ = ì˜¤ëŠ˜ ìë™) â•â•â•
  save: function(){
    var site=document.getElementById('fSite').value.trim();
    var dong=document.getElementById('fDong').value.trim();
    var ho=document.getElementById('fHo').value.trim();
    if(!site){this.toast('í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
    if(!dong){this.toast('ë™ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
    if(!ho){this.toast('í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}

    // ì™„ë£Œì¼ = ì˜¤ëŠ˜ ìë™
    var today=new Date();
    var dateStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');

    var entry={
      no:this.savedLog.length+1,
      site:site,
      dong:dong,
      ho:ho,
      loc:document.getElementById('fLoc').value.trim(),
      work:document.getElementById('fWork').value.trim(),
      type:document.getElementById('fType').value.trim(),
      comp:document.getElementById('fComp').value.trim(),
      memo:document.getElementById('fMemo').value.trim(),
      before:this.photos.before||'',
      after:this.photos.after||'',
      confirm:this.photos.confirm||'',
      date:dateStr
    };

    this.savedLog.push(entry);
    this.saveLog();
    this.renderLog();
    this.toast('âœ… ì €ì¥! #'+entry.no+' ('+dateStr+')','success');
    setTimeout(function(){document.getElementById('secLog').scrollIntoView({behavior:'smooth'});},400);
  },

  // â•â•â• ìƒˆë¡œì…ë ¥ â•â•â•
  newEntry: function(){
    var ids=['fDong','fHo','fLoc','fWork','fType','fComp','fMemo'];
    for(var i=0;i<ids.length;i++) document.getElementById(ids[i]).value='';
    this.photos={before:'',after:'',confirm:''};
    var t=['before','after','confirm'];
    for(var j=0;j<t.length;j++) this.updateSlot(t[j],'');
    document.getElementById('matchInfo').className='match-info';
    document.getElementById('matchInfo').style.display='none';
    this.matchedRow=null;
    document.querySelector('.content').scrollTo({top:0,behavior:'smooth'});
    document.getElementById('fDong').focus();
    this.toast('ìƒˆ ì‘ì—… ì…ë ¥ (í˜„ì¥ëª… ìœ ì§€)','info');
  },

  // â•â•â• ë¡œê·¸ â•â•â•
  renderLog: function(){
    var c=this.savedLog.length;
    document.getElementById('logCount').textContent='('+c+'ê±´)';
    if(!c){document.getElementById('logBody').innerHTML='<tr><td colspan="14" class="log-empty">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}
    var html='';
    for(var i=0;i<c;i++){
      var it=this.savedLog[i];
      html+='<tr>'
        +'<td class="order-num">'+it.no+'</td>'
        +'<td>'+(it.site||'-')+'</td>'
        +'<td>'+(it.dong||'-')+'</td>'
        +'<td>'+(it.ho||'-')+'</td>'
        +'<td>'+(it.loc||'-')+'</td>'
        +'<td>'+(it.work||'-')+'</td>'
        +'<td>'+(it.type||'-')+'</td>'
        +'<td>'+(it.comp||'-')+'</td>'
        +'<td style="text-align:left;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(it.memo||'-')+'</td>'
        +'<td>'+(it.before?'<img src="'+it.before+'" class="thumb">':'-')+'</td>'
        +'<td>'+(it.after?'<img src="'+it.after+'" class="thumb">':'-')+'</td>'
        +'<td>'+(it.confirm?'<img src="'+it.confirm+'" class="thumb">':'-')+'</td>'
        +'<td style="font-size:.48rem">'+it.date+'</td>'
        +'<td><button class="btn-del-log" onclick="App.delItem('+i+')">ì‚­ì œ</button></td>'
        +'</tr>';
    }
    document.getElementById('logBody').innerHTML=html;
  },

  delItem: function(idx){
    if(!confirm('#'+this.savedLog[idx].no+' ì‚­ì œ?'))return;
    this.savedLog.splice(idx,1);
    for(var i=0;i<this.savedLog.length;i++) this.savedLog[i].no=i+1;
    this.saveLog();this.renderLog();this.toast('ì‚­ì œ','info');
  },
  clearLog: function(){
    if(!this.savedLog.length){this.toast('ì‚­ì œí•  í•­ëª© ì—†ìŒ','error');return;}
    if(!confirm('ì „ì²´ '+this.savedLog.length+'ê±´ ì‚­ì œ?'))return;
    this.savedLog=[];this.saveLog();this.renderLog();this.toast('ì „ì²´ ì‚­ì œ','info');
  },

  // â•â•â• ì—‘ì…€ ë‚´ë³´ë‚´ê¸° â•â•â•
  exportExcel: function(){
    if(!this.savedLog.length){this.toast('ì „ì†¡í•  ë°ì´í„° ì—†ìŒ','error');return;}
    var self=this;
    document.getElementById('loaderText').textContent='ì—‘ì…€ ìƒì„± ì¤‘...';
    document.getElementById('loader').style.display='flex';
    setTimeout(function(){
      try{
        var wb=new ExcelJS.Workbook();wb.creator='(ì£¼)ë©”íŠ¸ë¡œ R&S AI';
        var ws=wb.addWorksheet('ì‘ì—…ì™„ë£Œ',{views:[{state:'frozen',ySplit:1}]});
        ws.addRow(['No','í˜„ì¥ëª…','ë™','í˜¸','ìœ„ì¹˜','ê³µì¢…','ìœ í˜•','ì‹œê³µì—…ì²´','í•˜ìë‚´ìš©','ìˆ˜ë¦¬ì „','ìˆ˜ë¦¬í›„','ì™„ë£Œí™•ì¸ì„œ','ì™„ë£Œì¼']);
        var hr=ws.getRow(1);hr.height=28;
        hr.eachCell(function(c){c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0C1929'}};c.font={color:{argb:'FFC8A45E'},bold:true,size:10};c.alignment={horizontal:'center',vertical:'middle',wrapText:true};c.border={top:{style:'thin',color:{argb:'FF2A2A2A'}},bottom:{style:'thin',color:{argb:'FF2A2A2A'}},left:{style:'thin',color:{argb:'FF2A2A2A'}},right:{style:'thin',color:{argb:'FF2A2A2A'}}};});
        ws.columns=[{width:5},{width:14},{width:6},{width:6},{width:9},{width:12},{width:10},{width:12},{width:25},{width:18},{width:18},{width:18},{width:12}];

        for(var i=0;i<self.savedLog.length;i++){
          var it=self.savedLog[i],rn=i+2;
          ws.addRow([it.no,it.site||'',it.dong||'',it.ho||'',it.loc||'',it.work||'',it.type||'',it.comp||'',it.memo||'','','','',it.date||'']);
          ws.getRow(rn).height=120;
          var dr=ws.getRow(rn);
          dr.eachCell(function(c){c.alignment={horizontal:'center',vertical:'middle',wrapText:true};c.font={size:9};c.border={top:{style:'thin',color:{argb:'FFDDDDDD'}},bottom:{style:'thin',color:{argb:'FFDDDDDD'}},left:{style:'thin',color:{argb:'FFDDDDDD'}},right:{style:'thin',color:{argb:'FFDDDDDD'}}};});
          if(i%2===1) dr.eachCell(function(c){c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF8F5ED'}};});
          dr.getCell(9).alignment={horizontal:'left',vertical:'middle',wrapText:true};

          var pm=[{k:'before',c:9},{k:'after',c:10},{k:'confirm',c:11}];
          for(var p=0;p<pm.length;p++){
            var pd=it[pm[p].k];
            if(pd&&pd.indexOf('data:image')===0){
              try{var b64=pd.split(',')[1];var ext=pd.indexOf('png')>=0?'png':'jpeg';var imgId=wb.addImage({base64:b64,extension:ext});ws.addImage(imgId,{tl:{col:pm[p].c,row:rn-1},br:{col:pm[p].c+1,row:rn},editAs:'oneCell'});}
              catch(ie){dr.getCell(pm[p].c+1).value='(ì‹¤íŒ¨)';}
            }else{dr.getCell(pm[p].c+1).value='-';dr.getCell(pm[p].c+1).font={size:9,color:{argb:'FF999999'}};}
          }
        }
        wb.xlsx.writeBuffer().then(function(buf){
          var blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
          var fn='ë©”íŠ¸ë¡œ_ì‘ì—…ì™„ë£Œ_'+new Date().toISOString().slice(0,10)+'.xlsx';
          if(typeof saveAs!=='undefined')saveAs(blob,fn);
          else{var u=URL.createObjectURL(blob);var a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
          document.getElementById('loader').style.display='none';
          self.toast('âœ… ì—‘ì…€ ì „ì†¡! ('+self.savedLog.length+'ê±´)','success',4000);
        }).catch(function(err){document.getElementById('loader').style.display='none';self.toast('âŒ '+err.message,'error');});
      }catch(e){document.getElementById('loader').style.display='none';self.toast('âŒ '+e.message,'error');}
    },100);
  },

  // â•â•â• Storage â•â•â•
  saveLog: function(){
    try{localStorage.setItem(STORAGE.LOG,JSON.stringify(this.savedLog));}
    catch(e){
      try{var s=[];for(var i=0;i<this.savedLog.length;i++){var c={};var ks=Object.keys(this.savedLog[i]);for(var j=0;j<ks.length;j++){var k=ks[j];c[k]=(k==='before'||k==='after'||k==='confirm')?(this.savedLog[i][k]?'ğŸ“·':''):this.savedLog[i][k];}s.push(c);}localStorage.setItem(STORAGE.LOG,JSON.stringify(s));self.toast('âš ï¸ ìš©ëŸ‰ì´ˆê³¼â†’ì‚¬ì§„ì¶•ì†Œ','error');}catch(e2){}
    }
  },
  loadLog: function(){try{this.savedLog=JSON.parse(localStorage.getItem(STORAGE.LOG)||'[]');}catch(e){this.savedLog=[];}},
  saveSource: function(){
    try{var s=[];for(var i=0;i<this.sourceData.length;i++){var c={};var ks=Object.keys(this.sourceData[i]);for(var j=0;j<ks.length;j++)c[ks[j]]=this.sourceData[i][ks[j]];s.push(c);}localStorage.setItem(STORAGE.SOURCE,JSON.stringify({data:s}));}catch(e){}
  },
  loadSource: function(){
    try{
      var s=JSON.parse(localStorage.getItem(STORAGE.SOURCE)||'null');
      if(s&&s.data&&s.data.length){
        this.sourceData=[];for(var i=0;i<s.data.length;i++){s.data[i]._idx=i;this.sourceData.push(s.data[i]);}
        this.detectCols(s.data[0]);
        document.getElementById('uploadArea').classList.add('loaded');
        document.getElementById('loadedFileName').textContent='ì´ì „ ë°ì´í„°';
        document.getElementById('loadedRowCount').textContent=this.sourceData.length;
      }
    }catch(e){}
  },

  // â•â•â• ìƒ˜í”Œ â•â•â•
  loadSample: function(){
    var sample=[],locs=['ê±°ì‹¤','ë°œì½”ë‹ˆ1','ì•ˆë°©','ì¹¨ì‹¤1','ì¹¨ì‹¤2','ì•ŒíŒŒë£¸','ë‹¤ìš©ë„','ë°œì½”ë‹ˆ2'];
    var works=['PLì°½í˜¸ê³µì‚¬','ë„ë°°ê³µì‚¬','íƒ€ì¼ê³µì‚¬','ë°”ë‹¥ê³µì‚¬','ì„¤ë¹„ê³µì‚¬'];
    var types=['ê· ì—´','ëˆ„ìˆ˜','ë“¤ëœ¸','íŒŒì†','ë³€ìƒ‰','ê²°ë¡œ'];
    var comps=['ì§„í¥ê±´ì—…(ì£¼)','ëŒ€ë¦¼ì‚°ì—…','í˜„ëŒ€ê±´ì„¤','ì‚¼ì„±ë¬¼ì‚°'];
    var memos=['ì°½ë¬¸ í‹ˆìƒˆ ë³´ìˆ˜','ë²½ì§€ ë“¤ëœ¸ ìˆ˜ë¦¬','íƒ€ì¼ ê¹¨ì§ êµì²´','ë°”ë‹¥ ê¸í˜ ë³´ìˆ˜','ë°°ìˆ˜ ë¶ˆëŸ‰','ë„ë°° ê³°íŒ¡ì´','ì‹¤ë¦¬ì½˜ ì¬ì‹œê³µ'];
    for(var d=101;d<=103;d++){for(var h=101;h<=106;h++){var n=1+Math.floor(Math.random()*2);for(var c=0;c<n;c++){
      sample.push({'í˜„ì¥ëª…':'ì›ì£¼í˜ì‹ C4BL','í•˜ìNo':'H'+String(sample.length+1).padStart(4,'0'),'ë™':String(d),'í˜¸':String(h),'ìœ„ì¹˜':locs[Math.floor(Math.random()*locs.length)],'ê³µì¢…':works[Math.floor(Math.random()*works.length)],'ìœ í˜•':types[Math.floor(Math.random()*types.length)],'ì‹œê³µì—…ì²´':comps[Math.floor(Math.random()*comps.length)],'í•˜ìë‚´ìš©':memos[Math.floor(Math.random()*memos.length)],'ì ‘ìˆ˜ì¼':'2025-02-09'});
    }}}
    this.sourceData=[];for(var i=0;i<sample.length;i++){sample[i]._idx=i;this.sourceData.push(sample[i]);}
    this.detectCols(sample[0]);this.saveSource();
    document.getElementById('uploadArea').classList.add('loaded');
    document.getElementById('loadedFileName').textContent='ìƒ˜í”Œ';
    document.getElementById('loadedRowCount').textContent=sample.length;
    this.toast('âœ… ìƒ˜í”Œ '+sample.length+'ê±´! ë™/í˜¸ ì…ë ¥í•´ë³´ì„¸ìš”','success',4000);
  }
};

window.onload=function(){App.init();};
</script>
</body>
</html>
