<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - í†µí•© ì‘ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  
  <!-- Tesseract.js for OCR -->
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  
  <style>
    :root {
      --primary: #007aff;
      --success: #34c759;
      --danger: #ff3b30;
      --warning: #ff9500;
      --dark: #1c1c1e;
      --light: #f2f2f7;
      --border: #c6c6c8;
      --ai-gray: #444444;
      --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --gradient-orange: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0;
      padding: 0;
    }

    body, html { 
      background: var(--light); 
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif; 
      height: 100vh; 
      overflow: hidden; 
    }

    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: #fff; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 0 50px rgba(0,0,0,0.2); 
    }

    /* í—¤ë” */
    header { 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff; 
      text-align: center; 
      padding: 15px 0; 
      border-bottom: 3px solid var(--primary); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    header h1 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 900; 
      letter-spacing: 0.5px;
    }

    .badge { 
      font-size: 0.65rem; 
      color: #64ffda; 
      font-weight: 700; 
      margin-top: 3px; 
      display: block; 
      opacity: 0.9;
    }

    /* ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ í‘œì‹œ */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 1px solid #dee2e6;
      font-size: 0.7rem;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.online {
      background: var(--success);
    }

    .status-dot.offline {
      background: var(--danger);
    }

    .status-dot.syncing {
      background: var(--warning);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pending-count {
      font-weight: 700;
      color: var(--warning);
    }

    .content { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      -webkit-overflow-scrolling: touch; 
      background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    }

    /* ì„¤ì • ì„¹ì…˜ */
    .config-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 2px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .config-section h3 {
      margin: 0 0 8px 0;
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 800;
    }
    
    .config-input {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #ddd;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.75rem;
      background: white;
      transition: all 0.3s ease;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* 3D ê·¸ë¼ë°ì´ì…˜ ë²„íŠ¼ */
    .btn-3d {
      width: 100%;
      padding: 10px;
      background: var(--gradient-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 900;
      font-size: 0.8rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 4px 8px rgba(102, 126, 234, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn-3d::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-3d:hover::before {
      left: 100%;
    }

    .btn-3d:active {
      transform: translateY(2px);
      box-shadow: 
        0 2px 4px rgba(102, 126, 234, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* ìƒíƒœ ë©”ì‹œì§€ */
    .status-message {
      padding: 8px 10px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.7rem;
      display: none;
      animation: slideIn 0.3s ease;
      font-weight: 600;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      margin-top: 8px;
      line-height: 1.5;
    }

    .info-box strong {
      color: #856404;
      display: block;
      margin-bottom: 3px;
    }

    /* ë“œë¡­ì¡´ */
    .drop-zone { 
      width: 100%; 
      aspect-ratio: 4/3; 
      border: 2.5px dashed var(--border); 
      border-radius: 12px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      cursor: pointer; 
      overflow: hidden; 
      position: relative; 
      margin-bottom: 12px; 
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      transition: all 0.3s ease;
    }

    .drop-zone:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
      transform: scale(1.01);
    }

    .preview-img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      position: absolute; 
      background: #000; 
      display: none; 
      z-index: 10; 
    }

    .zone-txt { 
      font-weight: 900; 
      color: #666; 
      text-align: center; 
      font-size: 0.85rem; 
      z-index: 5;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

    /* ë°ì´í„° í…Œì´ë¸” */
    .data-table { 
      width: 100%; 
      border-collapse: collapse; 
      border: 2px solid #222; 
      margin-bottom: 12px; 
      background: #fff; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .data-table td { 
      border: 1px solid #333; 
      padding: 6px; 
      position: relative; 
      height: 48px; 
      vertical-align: middle; 
    }

    .data-table label { 
      position: absolute; 
      top: 3px; 
      left: 6px; 
      font-size: 0.6rem; 
      font-weight: 900; 
      color: var(--primary); 
    }

    .data-table input { 
      width: 100%; 
      border: none; 
      font-size: 0.85rem; 
      font-weight: 700; 
      outline: none; 
      background: transparent; 
      padding-top: 12px; 
      color: var(--ai-gray); 
    }

    .memo-td { 
      height: 100px !important; 
      vertical-align: top !important; 
      padding-top: 22px !important; 
    }

    .memo-td textarea { 
      width: 100%; 
      height: 100%; 
      border: none; 
      resize: none; 
      outline: none; 
      font-size: 0.8rem; 
      line-height: 1.4; 
      font-family: inherit;
    }

    /* ì…ë ¥ì¹¸ ì‚­ì œ ë²„íŠ¼ */
    .btn-clear {
      width: 100%;
      height: 38px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: #fff;
      font-weight: 900;
      margin-bottom: 15px;
      cursor: pointer;
      font-size: 0.8rem;
      box-shadow: 
        0 4px 8px rgba(255, 107, 107, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-clear:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
    }

    /* ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¹ì…˜ */
    .sheet-section { 
      margin-top: 20px; 
      margin-bottom: 30px; 
    }

    .sheet-title { 
      font-size: 0.95rem; 
      font-weight: 900; 
      margin-bottom: 10px; 
      border-left: 4px solid var(--success); 
      padding-left: 10px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      color: #333;
    }

    .data-count {
      font-size: 0.7rem;
      color: #666;
      font-weight: normal;
    }

    .table-scroll { 
      width: 100%; 
      overflow-x: auto; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      background: #fff; 
      -webkit-overflow-scrolling: touch; 
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    #spreadsheet { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.65rem; 
      min-width: 1200px;
    }

    #spreadsheet th { 
      background: linear-gradient(135deg, #34c759 0%, #2ba84a 100%);
      color: white;
      padding: 10px 5px; 
      border: 1px solid #2ba84a; 
      font-weight: 900; 
      white-space: nowrap; 
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #spreadsheet td { 
      padding: 8px 5px; 
      border: 1px solid #e2e8f0; 
      text-align: center; 
      color: #444; 
      vertical-align: middle; 
      font-size: 0.65rem;
    }

    #spreadsheet tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #spreadsheet tbody tr:hover {
      background-color: #e3f2fd;
      transition: background-color 0.2s ease;
    }

    .thumb { 
      width: 60px; 
      height: 45px; 
      object-fit: cover; 
      border-radius: 4px; 
      border: 1px solid #ccc; 
      background: #eee; 
      display: block;
      margin: 0 auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    #loader { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      z-index: 9999; 
      display: none; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      color: #fff; 
    }

    .spinner { 
      width: 50px; 
      height: 50px; 
      border: 5px solid #333; 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      animation: rot 0.8s linear infinite; 
    }

    @keyframes rot { 
      100% { transform: rotate(360deg); } 
    }

    .spinner-text {
      margin-top: 15px;
      font-weight: 900;
      font-size: 0.9rem;
    }

    /* í•˜ë‹¨ í‘¸í„° ë²„íŠ¼ */
    footer { 
      display: flex; 
      gap: 8px; 
      padding: 12px; 
      border-top: 1px solid #eee; 
      background: #fff; 
      padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    footer button { 
      flex: 1; 
      height: 55px; 
      border-radius: 12px; 
      border: none; 
      color: #fff; 
      font-weight: 900; 
      font-size: 0.95rem; 
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn-save { 
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 
        0 4px 8px rgba(17, 153, 142, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-save::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-save:hover::before {
      left: 100%;
    }

    .btn-save:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(17, 153, 142, 0.3);
    }

    .btn-refresh { 
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      box-shadow: 
        0 4px 8px rgba(52, 152, 219, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-refresh::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-refresh:hover::before {
      left: 100%;
    }

    .btn-refresh:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
    }

    /* ì˜¤í”„ë¼ì¸ ë°°ë„ˆ */
    .offline-banner {
      background: var(--warning);
      color: var(--dark);
      padding: 8px;
      text-align: center;
      font-size: 0.75rem;
      font-weight: 700;
      display: none;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 480px) {
      .content {
        padding: 12px;
      }
      
      header h1 {
        font-size: 1.1rem;
      }

      .badge {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>

<!-- ì˜¤í”„ë¼ì¸ ë°°ë„ˆ -->
<div class="offline-banner" id="offlineBanner">
  âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë°ì´í„°ê°€ ë¡œì»¬ì— ì €ì¥ë˜ë©° ì˜¨ë¼ì¸ ì‹œ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤
</div>

<!-- ë¡œë”© -->
<div id="loader">
  <div class="spinner"></div>
  <p class="spinner-text">AI ë¬´ê²°ì„± ë¶„ì„ ì¤‘...</p>
</div>

<div class="app-container">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1>
    <span class="badge" id="versionBadge">VER 3.0 ULTIMATE INTEGRATED</span>
  </header>

  <!-- ìƒíƒœë°” -->
  <div class="status-bar">
    <div class="connection-status">
      <div class="status-dot online" id="statusDot"></div>
      <span id="statusText">ì˜¨ë¼ì¸</span>
    </div>
    <div class="pending-count" id="pendingCount">ëŒ€ê¸°: 0ê±´</div>
  </div>

  <main class="content">
    <!-- êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì • -->
    <div class="config-section">
      <h3>ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì •</h3>
      <input type="text" id="spreadsheetId" class="config-input" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID" value="1U915mN26A8E51BueKHWLZF105jcMn529kluYhqHlC8c">
      <input type="text" id="sheetName" class="config-input" placeholder="ì‹œíŠ¸ ì´ë¦„" value="ì‹œíŠ¸1">
      <button class="btn-3d" onclick="SYSTEM.testConnection()">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <div id="statusMessage" class="status-message"></div>
      
      <div class="info-box">
        <strong>ğŸ’¡ ë¡œì»¬ ì €ì¥ ì‹œìŠ¤í…œ</strong>
        ë°ì´í„°ëŠ” <strong>IndexedDB</strong>ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©°,<br>
        ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.<br>
        ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤! 
      </div>
    </div>

    <!-- Google Vision API í‚¤ ì„¤ì • -->
    <div class="config-section" style="border-color: #ff9500;">
      <h3>ğŸ”‘ Google Vision API í‚¤ (ì„ íƒì‚¬í•­)</h3>
      <input type="text" id="visionApiKey" class="config-input" placeholder="Google Cloud Vision API í‚¤ (ì„ íƒì‚¬í•­)">
      <button class="btn-3d" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); box-shadow: 0 4px 8px rgba(255, 149, 0, 0.3);" onclick="SYSTEM.saveApiKey()">ğŸ’¾ API í‚¤ ì €ì¥</button>
      
      <div class="info-box" style="background: #e8f5e9; border-color: #4caf50;">
        <strong>âœ… OCRì€ API í‚¤ ì—†ì´ë„ ì‘ë™í•©ë‹ˆë‹¤!</strong><br>
        Tesseract.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ì—ì„œ OCRì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.<br>
        Google Vision API í‚¤ëŠ” ë” ì •í™•í•œ ì¸ì‹ì„ ì›í•  ë•Œë§Œ ì…ë ¥í•˜ì„¸ìš”.
      </div>
    </div>
  
    <!-- 1. ì™„ë£Œí™•ì¸ì„œ OCR ì…ë ¥ -->
    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p class="zone-txt">ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p>
      <img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" style="display:none" onchange="SYSTEM.analyze(this)">

    <!-- OCR ìƒíƒœ ì•ˆë‚´ -->
    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
      <div style="font-size: 0.75rem; color: #1565c0; font-weight: 700; margin-bottom: 5px;">
        ğŸ¤– 3ë‹¨ê³„ ì•ˆì •ì„± ë³´ì¥ ì‹œìŠ¤í…œ
      </div>
      <div style="font-size: 0.7rem; color: #1976d2; line-height: 1.4;">
        1ï¸âƒ£ <strong>ë¡œì»¬ ì €ì¥</strong> - IndexedDBì— ì¦‰ì‹œ ì €ì¥<br>
        2ï¸âƒ£ <strong>OCR ì²˜ë¦¬</strong> - AI ìë™ ì¸ì‹<br>
        3ï¸âƒ£ <strong>í´ë¼ìš°ë“œ ë™ê¸°í™”</strong> - ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
      </div>
      <button onclick="SYSTEM.manualOCR()" style="width:100%; margin-top:8px; padding:8px; background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color:#fff; border:none; border-radius:6px; font-weight:900; font-size:0.75rem; cursor:pointer; box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);">
        ğŸ”„ OCR ì¬ì‹œë„
      </button>
    </div>

    <!-- ë°ì´í„° ì…ë ¥ í…Œì´ë¸” -->
    <table class="data-table">
      <tr>
        <td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td>
        <td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td>
        <td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></td>
      </tr>
      <tr>
        <td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td>
        <td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td>
        <td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td>
        <td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td>
      </tr>
      <tr>
        <td colspan="6" class="memo-td"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo"></textarea></td>
      </tr>
    </table>

    <!-- ì…ë ¥ì¹¸ ì‚­ì œ ë²„íŠ¼ -->
    <button class="btn-clear" onclick="SYSTEM.clearForm()">ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì „ì²´ ì‚­ì œ</button>

    <!-- 2. ìˆ˜ë¦¬ ì „ ì‚¬ì§„ -->
    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p class="zone-txt">ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p>
      <img id="view-before" class="preview-img">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" style="display:none" onchange="SYSTEM.processImage(this, 'view-before')">

    <!-- 3. ìˆ˜ë¦¬ í›„ ì‚¬ì§„ -->
    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p class="zone-txt">ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p>
      <img id="view-after" class="preview-img">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" style="display:none" onchange="SYSTEM.processAfter(this)">

    <!-- 4. ë©”íŠ¸ë¡œë³´ë“œíŒ -->
    <div class="drop-zone" style="border-style:solid; border-color:var(--success);">
      <p class="zone-txt" style="color:var(--success);">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„± ê²°ê³¼</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>

    <!-- 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ -->
    <div class="drop-zone" onclick="document.getElementById('f-final').click()">
      <p class="zone-txt">ğŸ“¸ 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ (ì„œëª…ë³¸)</p>
      <img id="view-final" class="preview-img">
    </div>
    <input type="file" id="f-final" accept="image/*" capture="camera" style="display:none" onchange="SYSTEM.processImage(this, 'view-final')">

    <!-- ì‘ì—… ë°ì´í„° ë¦¬ìŠ¤íŠ¸ -->
    <section class="sheet-section">
      <div class="sheet-title">
        <span>ğŸ“Š ì‘ì—… ë¬´ê²°ì„± ë°ì´í„° ë¦¬ìŠ¤íŠ¸ <span class="data-count" id="dataCount">(0ê±´)</span></span>
        <div>
          <button onclick="SYSTEM.syncAll()" style="font-size:0.6rem; padding:4px 8px; background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color:#fff; border:none; border-radius:5px; cursor:pointer; margin-right:5px; font-weight:900;">ë™ê¸°í™”</button>
          <button onclick="SYSTEM.deleteDB()" style="font-size:0.6rem; padding:4px 8px; background:linear-gradient(135deg, #ff3b30 0%, #e63946 100%); color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:900;">DB ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="table-scroll">
        <table id="spreadsheet">
          <thead>
            <tr>
              <th>í˜„ì¥ëª…</th>
              <th>í•˜ìNo</th>
              <th>ë™/í˜¸ìˆ˜</th>
              <th>ì ‘ìˆ˜ì¼</th>
              <th>ë‹¨ê³„</th>
              <th>ìœ„ì¹˜</th>
              <th>ê³µì¢…</th>
              <th>ì—…ì²´ëª…</th>
              <th>í™•ì¸ì</th>
              <th>í•˜ìë‚´ìš©</th>
              <th>ì‚¬ì§„ì „</th>
              <th>ì‚¬ì§„í›„</th>
              <th>ë©”íŠ¸ë¡œ<br>ë³´ë“œíŒ</th>
              <th>ìµœì¢…<br>í™•ì¸ì„œ</th>
              <th>ë™ê¸°í™”</th>
            </tr>
          </thead>
          <tbody id="data-body">
            <tr>
              <td colspan="15" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
  <footer>
    <button class="btn-save" onclick="SYSTEM.save()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  // ============================================
  // í†µí•© ì‹œìŠ¤í…œ - IndexedDB + LocalStorage í•˜ì´ë¸Œë¦¬ë“œ
  // ============================================
  
  const CODE_VERSION = "3.0";
  
  const SYSTEM = {
    // ì„¤ì •
    apiKey: "",
    db: null,
    dbName: "METRO_INTEGRATED_DB",
    storeName: "workData",
    pendingQueue: [],
    isOnline: navigator.onLine,
    
    // ìŠ¤í† ë¦¬ì§€ í‚¤
    keys: {
      version: "METRO_VERSION",
      codeVersion: "METRO_CODE_VERSION",
      apiKey: "METRO_VISION_API_KEY",
      legacyDB: "METRO_DB_SYNC"
    },

    // ============================================
    // ì´ˆê¸°í™”
    // ============================================
    
    init: async function() {
      console.log('ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
      
      // ë²„ì „ ì²´í¬
      this.checkVersion();
      
      // API í‚¤ ë¡œë“œ
      this.loadApiKey();
      
      // IndexedDB ì´ˆê¸°í™”
      await this.initIndexedDB();
      
      // ê¸°ì¡´ LocalStorage ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
      await this.migrateLegacyData();
      
      // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      this.setupNetworkListeners();
      
      // ë°ì´í„° ë Œë”ë§
      await this.render();
      
      // ëŒ€ê¸° ì¤‘ì¸ í•­ëª© í™•ì¸
      await this.checkPendingItems();
      
      // UI ì—…ë°ì´íŠ¸
      this.updateOnlineStatus();
      
      console.log('âœ… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    },

    // ============================================
    // IndexedDB ê´€ë¦¬
    // ============================================
    
    initIndexedDB: function() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(this.dbName, 1);
        
        request.onerror = () => {
          console.error('âŒ IndexedDB ì—´ê¸° ì‹¤íŒ¨:', request.error);
          reject(request.error);
        };
        
        request.onsuccess = () => {
          this.db = request.result;
          console.log('âœ… IndexedDB ì—°ê²° ì„±ê³µ');
          resolve(this.db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          if (!db.objectStoreNames.contains(this.storeName)) {
            const store = db.createObjectStore(this.storeName, { 
              keyPath: 'id', 
              autoIncrement: true 
            });
            
            // ì¸ë±ìŠ¤ ìƒì„±
            store.createIndex('timestamp', 'timestamp', { unique: false });
            store.createIndex('synced', 'synced', { unique: false });
            store.createIndex('site', 'site', { unique: false });
            store.createIndex('haja', 'no', { unique: false });
            
            console.log('âœ… IndexedDB ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ');
          }
        };
      });
    },

    // ë°ì´í„° ì €ì¥ (IndexedDB)
    saveToIndexedDB: function(data) {
      return new Promise((resolve, reject) => {
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        const request = store.add(data);
        
        request.onsuccess = () => {
          console.log('âœ… IndexedDB ì €ì¥ ì„±ê³µ:', request.result);
          resolve(request.result);
        };
        
        request.onerror = () => {
          console.error('âŒ IndexedDB ì €ì¥ ì‹¤íŒ¨:', request.error);
          reject(request.error);
        };
      });
    },

    // ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    getAllFromIndexedDB: function() {
      return new Promise((resolve, reject) => {
        const transaction = this.db.transaction([this.storeName], 'readonly');
        const store = transaction.objectStore(this.storeName);
        const request = store.getAll();
        
        request.onsuccess = () => {
          resolve(request.result || []);
        };
        
        request.onerror = () => {
          reject(request.error);
        };
      });
    },

    // ë°ì´í„° ì—…ë°ì´íŠ¸
    updateInIndexedDB: function(data) {
      return new Promise((resolve, reject) => {
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        const request = store.put(data);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    },

    // ê¸°ì¡´ LocalStorage ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
    migrateLegacyData: async function() {
      const legacyData = localStorage.getItem(this.keys.legacyDB);
      if (!legacyData) return;
      
      try {
        const oldList = JSON.parse(legacyData);
        console.log(`ğŸ”„ ê¸°ì¡´ ë°ì´í„° ${oldList.length}ê±´ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘`);
        
        for (const item of oldList) {
          // ë™ê¸°í™” ìƒíƒœ ì¶”ê°€
          item.synced = false;
          item.migratedFrom = 'localStorage';
          await this.saveToIndexedDB(item);
        }
        
        console.log('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
        
        // ê¸°ì¡´ ë°ì´í„° ë°±ì—… í›„ ì‚­ì œ
        localStorage.setItem(this.keys.legacyDB + '_backup', legacyData);
        localStorage.removeItem(this.keys.legacyDB);
      } catch(err) {
        console.error('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
      }
    },

    // ============================================
    // ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬
    // ============================================
    
    setupNetworkListeners: function() {
      window.addEventListener('online', () => this.handleOnlineStatusChange(true));
      window.addEventListener('offline', () => this.handleOnlineStatusChange(false));
    },

    handleOnlineStatusChange: function(isOnline) {
      this.isOnline = isOnline;
      this.updateOnlineStatus();
      
      if (isOnline) {
        this.showToast('âœ… ì˜¨ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜', 'success');
        setTimeout(() => this.syncPendingItems(), 1000);
      } else {
        this.showToast('âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤', 'warning');
      }
    },

    updateOnlineStatus: function() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const banner = document.getElementById('offlineBanner');
      
      if (this.isOnline) {
        dot.className = 'status-dot online';
        text.textContent = 'ì˜¨ë¼ì¸';
        banner.style.display = 'none';
      } else {
        dot.className = 'status-dot offline';
        text.textContent = 'ì˜¤í”„ë¼ì¸';
        banner.style.display = 'block';
      }
    },

    updatePendingCount: function(count) {
      const el = document.getElementById('pendingCount');
      if (el) {
        el.textContent = `ëŒ€ê¸°: ${count}ê±´`;
      }
    },

    checkPendingItems: async function() {
      const allData = await this.getAllFromIndexedDB();
      const pending = allData.filter(item => !item.synced);
      this.updatePendingCount(pending.length);
      return pending;
    },

    // ============================================
    // OCR ì²˜ë¦¬
    // ============================================
    
    saveApiKey: function() {
      const apiKey = document.getElementById('visionApiKey').value.trim();
      if (apiKey) {
        localStorage.setItem(this.keys.apiKey, apiKey);
        this.apiKey = apiKey;
        this.showToast('âœ… API í‚¤ ì €ì¥ ì™„ë£Œ', 'success');
      } else {
        this.showToast('âŒ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      }
    },

    loadApiKey: function() {
      const saved = localStorage.getItem(this.keys.apiKey);
      if (saved) {
        this.apiKey = saved;
        const input = document.getElementById('visionApiKey');
        if (input) input.value = saved;
        console.log('âœ… API í‚¤ ë¡œë“œ ì™„ë£Œ');
      }
    },

    analyze: async function(input) {
      if (!input.files[0]) return;
      
      this.processImage(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      
      const file = input.files[0];
      let success = false;
      
      // 1. Tesseract.js ì‹œë„
      try {
        console.log('ğŸ“¸ Tesseract.js OCR ì‹œë„...');
        success = await this.tryTesseract(file);
        if (success) {
          document.getElementById('loader').style.display = 'none';
          this.showToast('âœ… OCR ë¶„ì„ ì™„ë£Œ!', 'success');
          return;
        }
      } catch(err) {
        console.log('âŒ Tesseract ì‹¤íŒ¨:', err.message);
      }
      
      // 2. Google Vision ì‹œë„
      if (this.apiKey) {
        try {
          console.log('ğŸ“¸ Google Vision API ì‹œë„...');
          success = await this.tryGoogleVision(file);
          if (success) {
            document.getElementById('loader').style.display = 'none';
            this.showToast('âœ… AI ë¶„ì„ ì™„ë£Œ!', 'success');
            return;
          }
        } catch(err) {
          console.log('âŒ Vision API ì‹¤íŒ¨:', err.message);
        }
      }
      
      // 3. ìƒ˜í”Œ ë°ì´í„°
      this.fillSampleData();
      document.getElementById('loader').style.display = 'none';
      this.showToast('â„¹ï¸ ìƒ˜í”Œ ë°ì´í„° ì…ë ¥ë¨', 'warning');
    },

    tryTesseract: async function(file) {
      if (typeof Tesseract === 'undefined') {
        throw new Error('Tesseract.js ë¯¸ë¡œë“œ');
      }
      
      const { data: { text } } = await Tesseract.recognize(
        file,
        'kor+eng',
        { logger: m => console.log(m) }
      );
      
      if (text && text.length > 10) {
        this.mapOCRText(text);
        return true;
      }
      throw new Error('ì¸ì‹ëœ í…ìŠ¤íŠ¸ ë¶€ì¡±');
    },

    tryGoogleVision: async function(file) {
      if (!this.apiKey) throw new Error('API í‚¤ ì—†ìŒ');
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const b64 = e.target.result.split(',')[1];
            const url = `https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`;
            
            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                requests: [{ 
                  image: { content: b64 }, 
                  features: [{ type: "DOCUMENT_TEXT_DETECTION" }] 
                }] 
              })
            });
            
            if (!res.ok) {
              const errorText = await res.text();
              console.error('API ì‘ë‹µ ì˜¤ë¥˜:', res.status, errorText);
              reject(new Error(`API ì˜¤ë¥˜: ${res.status}`));
              return;
            }
            
            const data = await res.json();
            
            if (data.responses && data.responses[0]?.fullTextAnnotation) {
              this.mapOCRText(data.responses[0].fullTextAnnotation.text);
              resolve(true);
            } else {
              reject(new Error('í…ìŠ¤íŠ¸ ì¸ì‹ ì‹¤íŒ¨'));
            }
          } catch(err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    },

    mapOCRText: function(text) {
      const get = (regex) => (text.match(regex) || ["", ""])[1]?.trim() || "";
      
      document.getElementById('site').value = get(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9- ]+)/) || "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('haja').value = get(/í•˜ì\s*No\s*[:\s]*(\d+)/) || get(/(\d{7})/);
      document.getElementById('unit').value = get(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/);
      
      // ì ‘ìˆ˜ì¼: ì™„ë£Œí™•ì¸ì„œì—ì„œ OCRë¡œ ì¶”ì¶œëœ ë‚ ì§œë§Œ ì…ë ¥
      // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì§€ì›: 2024-01-15, 2024.01.15, 2024/01/15, 20240115 ë“±
      let ocrDate = '';
      
      // 1. "ì ‘ìˆ˜ì¼" ë ˆì´ë¸” ê·¼ì²˜ì˜ ë‚ ì§œ ì°¾ê¸°
      const dateWithLabel = text.match(/ì ‘ìˆ˜ì¼\s*[:\s]*(\d{4}[-./\s]*\d{1,2}[-./\s]*\d{1,2})/);
      if (dateWithLabel) {
        ocrDate = dateWithLabel[1];
      } else {
        // 2. "ì ‘ìˆ˜ì¼" ë‹¤ìŒ ì¤„ì— ìˆëŠ” ë‚ ì§œ ì°¾ê¸°
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes('ì ‘ìˆ˜ì¼') && i + 1 < lines.length) {
            const nextLine = lines[i + 1];
            const dateMatch = nextLine.match(/(\d{4}[-./\s]*\d{1,2}[-./\s]*\d{1,2})/);
            if (dateMatch) {
              ocrDate = dateMatch[1];
              break;
            }
          }
        }
      }
      
      // 3. ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì¼ë°˜ì ì¸ ë‚ ì§œ íŒ¨í„´ ì°¾ê¸° (ì²« ë²ˆì§¸ ë°œê²¬ëœ ë‚ ì§œ)
      if (!ocrDate) {
        const generalDate = text.match(/(\d{4}[-./]\d{1,2}[-./]\d{1,2})/);
        if (generalDate) {
          ocrDate = generalDate[1];
        }
      }
      
      // 4. 8ìë¦¬ ìˆ«ì í˜•ì‹ (20240115 â†’ 2024-01-15)
      if (!ocrDate) {
        const compactDate = text.match(/(\d{8})/);
        if (compactDate) {
          const d = compactDate[1];
          if (d.startsWith('20')) { // 2000ë…„ëŒ€ ë‚ ì§œë§Œ
            ocrDate = `${d.substr(0,4)}-${d.substr(4,2)}-${d.substr(6,2)}`;
          }
        }
      }
      
      // ë‚ ì§œ í˜•ì‹ ì •ê·œí™” ë° ì…ë ¥
      if (ocrDate) {
        // êµ¬ë¶„ì í†µì¼ (., / â†’ -)
        let normalized = ocrDate.replace(/[.\/ ]/g, '-');
        const parts = normalized.split('-').filter(p => p);
        
        if (parts.length === 3) {
          const year = parts[0];
          const month = parts[1].padStart(2, '0');
          const day = parts[2].padStart(2, '0');
          
          // ìœ íš¨ì„± ê²€ì‚¬ (ê°„ë‹¨)
          if (year.length === 4 && parseInt(month) <= 12 && parseInt(day) <= 31) {
            document.getElementById('date').value = `${year}-${month}-${day}`;
            console.log(`ğŸ“… ì ‘ìˆ˜ì¼ ì¸ì‹: ${year}-${month}-${day}`);
          }
        }
      } else {
        console.log('âš ï¸ ì ‘ìˆ˜ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
      }
      
      const steps = ["1ë…„ì°¨", "2ë…„ì°¨", "3ë…„ì°¨"];
      const locs = ["ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "ì•ŒíŒŒë£¸"];
      const works = ["PLì°½í˜¸ê³µì‚¬", "ë„ë°°ê³µì‚¬", "íƒ€ì¼ê³µì‚¬", "ë°”ë‹¥ê³µì‚¬"];
      
      const lines = text.split('\n');
      lines.forEach((line, i) => {
        const clean = line.replace(/\s/g, "");
        
        if (clean.includes("ì ‘ìˆ˜ë‹¨ê³„")) {
          let val = line.split(/[:\s]/).filter(x => x && !x.includes("ì ‘ìˆ˜ë‹¨ê³„")).pop() || lines[i+1]?.trim();
          document.getElementById('step').value = steps.find(s => val?.includes(s)) || "1ë…„ì°¨";
        }
        
        if (clean.includes("ì‹¤ëª…") || (clean.includes("ìœ„ì¹˜") && !clean.includes("ìƒì„¸"))) {
          let val = line.split(/[:\s]/).filter(x => x && !x.includes("ì‹¤ëª…") && !x.includes("ìœ„ì¹˜")).pop() || lines[i+1]?.trim();
          document.getElementById('loc').value = locs.find(s => val?.includes(s)) || "ê±°ì‹¤";
        }
        
        if (clean.includes("ê³µì¢…")) {
          let val = line.split(/[:\s]/).filter(x => x && !x.includes("ê³µì¢…")).pop() || lines[i+1]?.trim();
          document.getElementById('work').value = works.find(s => val?.includes(s)) || "PLì°½í˜¸ê³µì‚¬";
        }
      });
      
      document.getElementById('comp').value = "ì§„í¥ê±´ì—…(ì£¼)";
      
      const memoIdx = text.indexOf("í•˜ìë‚´ìš©");
      if (memoIdx !== -1) {
        document.getElementById('memo').value = text.substring(memoIdx + 4, memoIdx + 300).replace(/\n/g, " ").trim();
      }
    },

    fillSampleData: function() {
      const samples = {
        site: 'ì›ì£¼í˜ì‹ C4BL',
        haja: '2024001',
        unit: '101ë™ 1001í˜¸',
        date: '2024-01-15',  // ìƒ˜í”Œ ë°ì´í„°ë„ ê³ ì •ëœ ë‚ ì§œ ì‚¬ìš©
        step: '1ë…„ì°¨',
        loc: 'ê±°ì‹¤',
        work: 'PLì°½í˜¸ê³µì‚¬',
        comp: 'ì§„í¥ê±´ì—…(ì£¼)',
        name: 'í™ê¸¸ë™',
        memo: 'ì°½ë¬¸ í‹ˆìƒˆ ë³´ìˆ˜ ì‘ì—… ì™„ë£Œ'
      };
      
      Object.keys(samples).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = samples[key];
      });
    },

    manualOCR: async function() {
      const input = document.getElementById('f-ai');
      if (!input.files || !input.files[0]) {
        this.showToast('âš ï¸ ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }
      await this.analyze(input);
    },

    // ============================================
    // ì´ë¯¸ì§€ ì²˜ë¦¬
    // ============================================
    
    processImage: function(input, targetId) {
      if (!input.files || !input.files[0]) return;
      
      const targetImg = document.getElementById(targetId);
      const reader = new FileReader();
      
      reader.onload = function(e) {
        targetImg.onload = () => { targetImg.style.display = 'block'; };
        targetImg.src = e.target.result;
      };
      
      reader.readAsDataURL(input.files[0]);
    },

    processAfter: function(input) {
      if (!input.files[0]) return;
      
      this.processImage(input, 'view-after');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => this.drawBoard(img);
        img.src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    },

    drawBoard: function(img) {
      const canvas = document.getElementById('boardCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 1200; 
      canvas.height = 1600;
      ctx.drawImage(img, 0, 0, 1200, 1600);
      
      const boardW = 460, boardH = 360;
      const startX = 45, startY = 1600 - boardH - 45;
      
      // ë³´ë“œíŒ ë°°ê²½
      ctx.fillStyle = "rgba(255,255,255,0.95)"; 
      ctx.fillRect(startX, startY, boardW, boardH);
      ctx.strokeStyle = "#000"; 
      ctx.lineWidth = 7; 
      ctx.strokeRect(startX, startY, boardW, boardH);
      
      // í…ìŠ¤íŠ¸
      ctx.fillStyle = "#000"; 
      ctx.font = "bold 32px sans-serif";
      
      const headers = ["í˜„ì¥ëª…", "ë™/í˜¸ìˆ˜", "ìœ„ì¹˜", "ì‘ì—…ì§„í–‰", "ì‘ì—…ì¼"];
      for(let i = 0; i < 5; i++) {
        let y = startY + (boardH / 5) * i;
        
        if (i > 0) { 
          ctx.beginPath(); 
          ctx.moveTo(startX, y); 
          ctx.lineTo(startX + boardW, y); 
          ctx.stroke(); 
        }
        
        ctx.fillText(headers[i], startX + 15, y + 45);
      }
      
      const getValue = (id) => document.getElementById(id).value || "-";
      ctx.font = "30px sans-serif";
      
      ctx.fillText(getValue('site'), startX + 155, startY + 45);
      ctx.fillText(getValue('unit'), startX + 155, startY + (boardH/5) * 1 + 45);
      ctx.fillText(getValue('loc'), startX + 155, startY + (boardH/5) * 2 + 45);
      ctx.fillText("ìˆ˜ë¦¬í›„", startX + 155, startY + (boardH/5) * 3 + 45);
      ctx.fillText(getValue('date'), startX + 155, startY + (boardH/5) * 4 + 45);
      
      const viewBoard = document.getElementById('view-board');
      viewBoard.src = canvas.toDataURL("image/jpeg", 0.9);
      viewBoard.style.display = 'block';
    },

    // ============================================
    // ë°ì´í„° ì €ì¥ ë° ë™ê¸°í™”
    // ============================================
    
    save: async function() {
      console.log('ğŸ’¾ ===== ì €ì¥ ì‹œì‘ =====');
      
      const site = document.getElementById('site').value;
      const haja = document.getElementById('haja').value;
      
      if (!site && !haja) {
        this.showToast('âŒ ìµœì†Œí•œ í˜„ì¥ëª…ì´ë‚˜ í•˜ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
      }
      
      const getSrc = (id) => {
        const el = document.getElementById(id);
        return (el && el.src && el.style.display !== 'none') ? el.src : "";
      };
      
      const data = {
        site: document.getElementById('site').value,
        no: document.getElementById('haja').value || "0000",
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        imgBefore: getSrc('view-before'),
        imgAfter: getSrc('view-after'),
        imgBoard: getSrc('view-board'),
        imgFinal: getSrc('view-final'),
        timestamp: new Date().toISOString(),
        timestampKR: new Date().toLocaleString('ko-KR'),
        version: this.getVersion(),
        synced: false
      };
      
      try {
        // 1. IndexedDBì— ì €ì¥
        const id = await this.saveToIndexedDB(data);
        console.log('âœ… IndexedDB ì €ì¥:', id);
        
        // 2. ë²„ì „ ì¦ê°€
        const newVersion = this.incrementVersion();
        
        // 3. í™”ë©´ ë Œë”ë§
        await this.render();
        
        // 4. êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì‹œë„
        if (this.isOnline) {
          try {
            const synced = await this.syncToSheet(data);
            if (synced) {
              data.id = id;
              data.synced = true;
              await this.updateInIndexedDB(data);
            }
          } catch(err) {
            console.log('â„¹ï¸ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ëŒ€ê¸°ì—´ì— ì¶”ê°€');
          }
        }
        
        // 5. ëŒ€ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
        await this.checkPendingItems();
        
        // 6. ì™„ë£Œ ì•Œë¦¼
        this.showToast('âœ… ì €ì¥ ì™„ë£Œ!', 'success');
        
        // 7. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ìŠ¤í¬ë¡¤
        setTimeout(() => {
          const section = document.querySelector('.sheet-section');
          if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 500);
        
        console.log('ğŸ’¾ ===== ì €ì¥ ì™„ë£Œ =====');
        
      } catch(err) {
        console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', err);
        this.showToast('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
      }
    },

    syncToSheet: async function(data) {
      const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
      const sheetName = document.getElementById('sheetName').value.trim();
      
      if (!spreadsheetId || !sheetName) return false;

      const values = [[
        data.timestampKR || data.timestamp,
        data.site || '', 
        data.no || '', 
        data.unit || '', 
        data.date || '',
        data.step || '', 
        data.loc || '', 
        data.work || '', 
        data.comp || '',
        data.name || '', 
        data.memo || '',
        data.imgBefore ? 'ì‚¬ì§„ ìˆìŒ' : '', 
        data.imgAfter ? 'ì‚¬ì§„ ìˆìŒ' : '',
        data.imgBoard ? 'ì‚¬ì§„ ìˆìŒ' : '', 
        data.imgFinal ? 'ì‚¬ì§„ ìˆìŒ' : ''
      ]];

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!A:O:append?valueInputOption=USER_ENTERED&key=${this.apiKey}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ values: values })
        });
        return response.ok;
      } catch (error) {
        console.log('â„¹ï¸ CORSë¡œ ì¸í•œ ì œí•œ (ì •ìƒ)');
        return false;
      }
    },

    syncAll: async function() {
      const pending = await this.checkPendingItems();
      
      if (pending.length === 0) {
        this.showToast('â„¹ï¸ ë™ê¸°í™”í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }
      
      const dot = document.getElementById('statusDot');
      dot.className = 'status-dot syncing';
      
      this.showToast(`ğŸ”„ ${pending.length}ê±´ ë™ê¸°í™” ì¤‘...`, 'warning');
      
      let synced = 0;
      for (const item of pending) {
        try {
          const success = await this.syncToSheet(item);
          if (success) {
            item.synced = true;
            await this.updateInIndexedDB(item);
            synced++;
          }
        } catch(err) {
          console.error('ë™ê¸°í™” ì‹¤íŒ¨:', err);
        }
      }
      
      dot.className = 'status-dot online';
      await this.checkPendingItems();
      await this.render();
      
      this.showToast(`âœ… ${synced}ê±´ ë™ê¸°í™” ì™„ë£Œ`, 'success');
    },

    syncPendingItems: async function() {
      const pending = await this.checkPendingItems();
      if (pending.length > 0) {
        await this.syncAll();
      }
    },

    // ============================================
    // ë Œë”ë§
    // ============================================
    
    render: async function() {
      console.log('ğŸ¨ ë Œë”ë§ ì‹œì‘');
      
      const list = await this.getAllFromIndexedDB();
      console.log(`ğŸ“Š ë°ì´í„°: ${list.length}ê±´`);
      
      const body = document.getElementById('data-body');
      const count = document.getElementById('dataCount');
      
      if (count) count.textContent = `(${list.length}ê±´)`;
      
      if (list.length === 0) {
        body.innerHTML = '<tr><td colspan="15" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      const makeImg = (src) => src ? `<img src="${src}" class="thumb" alt="ì‚¬ì§„">` : '-';
      const syncBadge = (synced) => synced 
        ? '<span style="color:#34c759; font-weight:900;">âœ“</span>' 
        : '<span style="color:#ff9500; font-weight:900;">â³</span>';
      
      const html = list.reverse().map(item => `
        <tr>
          <td style="font-weight:700;">${item.site || '-'}</td>
          <td style="color:#007aff;">${item.no || '-'}</td>
          <td>${item.unit || '-'}</td>
          <td style="font-size:0.6rem;">${item.date || '-'}</td>
          <td>${item.step || '-'}</td>
          <td>${item.loc || '-'}</td>
          <td>${item.work || '-'}</td>
          <td>${item.comp || '-'}</td>
          <td>${item.name || '-'}</td>
          <td style="text-align:left; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.memo || '-'}</td>
          <td>${makeImg(item.imgBefore)}</td>
          <td>${makeImg(item.imgAfter)}</td>
          <td>${makeImg(item.imgBoard)}</td>
          <td>${makeImg(item.imgFinal)}</td>
          <td>${syncBadge(item.synced)}</td>
        </tr>
      `).join('');
      
      body.innerHTML = html;
      console.log('âœ… ë Œë”ë§ ì™„ë£Œ');
    },

    // ============================================
    // ìœ í‹¸ë¦¬í‹°
    // ============================================
    
    checkVersion: function() {
      const saved = localStorage.getItem(this.keys.codeVersion);
      
      if (saved !== CODE_VERSION) {
        console.log(`ğŸ”„ ë²„ì „ ì—…ë°ì´íŠ¸: ${saved || 'ì—†ìŒ'} â†’ ${CODE_VERSION}`);
        localStorage.setItem(this.keys.codeVersion, CODE_VERSION);
        localStorage.setItem(this.keys.version, CODE_VERSION);
        
        if (saved) {
          this.showToast(`ğŸ‰ v${CODE_VERSION} ì—…ë°ì´íŠ¸!`, 'success');
        }
      }
    },

    getVersion: function() {
      return localStorage.getItem(this.keys.version) || CODE_VERSION;
    },

    incrementVersion: function() {
      let current = parseFloat(this.getVersion());
      let newVer = Math.round((current + 0.1) * 10) / 10;
      localStorage.setItem(this.keys.version, newVer.toFixed(1));
      this.updateVersionDisplay();
      return newVer;
    },

    updateVersionDisplay: function() {
      const badge = document.getElementById('versionBadge');
      if (badge) {
        badge.textContent = `VER ${this.getVersion()} ULTIMATE INTEGRATED`;
      }
    },

    testConnection: function() {
      this.showToast('â„¹ï¸ ë¡œì»¬ ì €ì¥ ì‹œìŠ¤í…œ ì‚¬ìš© ì¤‘', 'warning');
    },

    clearForm: function() {
      if (confirm("ì…ë ¥ì¹¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        ['site','haja','unit','date','step','loc','work','comp','name','memo'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        
        ['view-ai','view-before','view-after','view-board','view-final'].forEach(id => {
          const img = document.getElementById(id);
          if (img) { 
            img.src = ""; 
            img.style.display = "none"; 
          }
        });
      }
    },

    deleteDB: async function() {
      if (confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // IndexedDB ì‚­ì œ
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        await store.clear();
        
        // ë²„ì „ ë¦¬ì…‹
        localStorage.setItem(this.keys.version, CODE_VERSION);
        this.updateVersionDisplay();
        
        // ë Œë”ë§
        await this.render();
        await this.checkPendingItems();
        
        this.showToast('âœ… DB ì´ˆê¸°í™” ì™„ë£Œ', 'success');
      }
    },

    showToast: function(message, type = 'info') {
      const status = document.getElementById('statusMessage');
      if (status) {
        status.textContent = message;
        status.className = 'status-message status-' + type;
        status.style.display = 'block';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
      }
    }
  };

  // ============================================
  // í˜ì´ì§€ ë¡œë“œ
  // ============================================
  
  window.addEventListener('DOMContentLoaded', async () => {
    console.log('ğŸš€ ì•± ì‹œì‘');
    await SYSTEM.init();
    console.log('âœ… ì¤€ë¹„ ì™„ë£Œ');
  });
</script>
</body>
</html>
