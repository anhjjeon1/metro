<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - Auto Version</title>
  <style>
    :root {
      --primary: #007aff;
      --success: #34c759;
      --danger: #ff3b30;
      --dark: #1c1c1e;
      --light: #f2f2f7;
      --border: #c6c6c8;
      --ai-gray: #444444;
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
    }

    body, html { 
      margin: 0; 
      padding: 0; 
      background: var(--light); 
      font-family: sans-serif; 
      height: 100vh; 
      overflow: hidden; 
    }

    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: #fff; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 0 50px rgba(0,0,0,0.2); 
    }

    header { 
      background: var(--dark); 
      color: #fff; 
      text-align: center; 
      padding: 20px 0; 
      border-bottom: 4px solid var(--primary); 
    }

    header h1 { 
      margin: 0; 
      font-size: 1.3rem; 
      font-weight: 900; 
    }

    .badge { 
      font-size: 0.7rem; 
      color: var(--primary); 
      font-weight: bold; 
      margin-top: 5px; 
      display: block; 
    }

    .content { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      -webkit-overflow-scrolling: touch; 
    }

    .drop-zone { 
      width: 100%; 
      aspect-ratio: 4/3; 
      border: 2.5px dashed var(--border); 
      border-radius: 12px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      cursor: pointer; 
      overflow: hidden; 
      position: relative; 
      margin-bottom: 15px; 
      background: #f8f9fa; 
    }

    .preview-img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      position: absolute; 
      background: #000; 
      display: none; 
      z-index: 10; 
    }

    .zone-txt { 
      font-weight: 900; 
      color: #666; 
      text-align: center; 
      font-size: 0.9rem; 
      z-index: 5; 
    }

    .data-table { 
      width: 100%; 
      border-collapse: collapse; 
      border: 2px solid #222; 
      margin-bottom: 15px; 
      background: #fff; 
    }

    .data-table td { 
      border: 1px solid #333; 
      padding: 6px; 
      position: relative; 
      height: 48px; 
      vertical-align: middle; 
    }

    .data-table label { 
      position: absolute; 
      top: 3px; 
      left: 6px; 
      font-size: 0.6rem; 
      font-weight: 900; 
      color: var(--primary); 
    }

    .data-table input { 
      width: 100%; 
      border: none; 
      font-size: 0.88rem; 
      font-weight: 800; 
      outline: none; 
      background: transparent; 
      padding-top: 12px; 
      color: var(--ai-gray); 
    }

    .memo-td { 
      height: 120px !important; 
      vertical-align: top !important; 
      padding-top: 25px !important; 
    }

    .memo-td textarea { 
      width: 100%; 
      height: 100%; 
      border: none; 
      resize: none; 
      outline: none; 
      font-size: 0.85rem; 
      line-height: 1.4; 
    }

    .sheet-section { 
      margin-top: 25px; 
      margin-bottom: 40px; 
    }

    .sheet-title { 
      font-size: 1rem; 
      font-weight: 900; 
      margin-bottom: 10px; 
      border-left: 5px solid var(--success); 
      padding-left: 10px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }

    .table-scroll { 
      width: 100%; 
      overflow-x: auto; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      background: #fff; 
      -webkit-overflow-scrolling: touch; 
      max-height: 500px;
      overflow-y: auto;
    }
    
    #spreadsheet { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.65rem; 
      min-width: 1200px;
    }

    #spreadsheet th { 
      background: #34c759; 
      color: white;
      padding: 10px 5px; 
      border: 1px solid #2ba84a; 
      font-weight: 900; 
      white-space: nowrap; 
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #spreadsheet td { 
      padding: 8px 5px; 
      border: 1px solid #e2e8f0; 
      text-align: center; 
      color: #444; 
      vertical-align: middle; 
      font-size: 0.65rem;
    }

    #spreadsheet tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #spreadsheet tbody tr:hover {
      background-color: #e3f2fd;
    }

    .thumb { 
      width: 60px; 
      height: 45px; 
      object-fit: cover; 
      border-radius: 4px; 
      border: 1px solid #ccc; 
      background: #eee; 
      display: block;
      margin: 0 auto;
    }

    #loader { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      z-index: 9999; 
      display: none; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      color: #fff; 
    }

    .spinner { 
      width: 50px; 
      height: 50px; 
      border: 5px solid #333; 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      animation: rot 0.8s linear infinite; 
    }

    @keyframes rot { 100% { transform: rotate(360deg); } }

    footer { 
      display: flex; 
      gap: 10px; 
      padding: 15px; 
      border-top: 1px solid #eee; 
      background: #fff; 
      padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
    }

    footer button { 
      flex: 1; 
      height: 60px; 
      border-radius: 30px; 
      border: none; 
      color: #fff; 
      font-weight: 900; 
      font-size: 1rem; 
      cursor: pointer; 
    }

    .btn-save { background: var(--success); }
    .btn-refresh { background: var(--primary); }
    
    .config-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 2px solid var(--primary);
    }
    
    .config-section h3 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: var(--primary);
    }
    
    .config-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }
    
    .status-message {
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 0.85rem;
      display: none;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .data-count {
      font-size: 0.75rem;
      color: #666;
      font-weight: normal;
    }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="font-weight:900;">AI ë¬´ê²°ì„± ë¶„ì„ ì¤‘...</p>
</div>

<div class="app-container">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1>
    <span class="badge" id="versionBadge">VER 1.0 ULTIMATE SPREADSHEET</span>
  </header>

  <main class="content">
    <div class="config-section">
      <h3>ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì •</h3>
      <input type="text" id="spreadsheetId" class="config-input" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID" value="1U915mN26A8E51BueKHWLZF105jcMn529kluYhqHlC8c">
      <input type="text" id="sheetName" class="config-input" placeholder="ì‹œíŠ¸ ì´ë¦„" value="ì‹œíŠ¸1">
      <button onclick="CORE.testConnection()" style="width:100%; padding:10px; background:var(--primary); color:#fff; border:none; border-radius:5px; font-weight:900; cursor:pointer;">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <div id="statusMessage" class="status-message"></div>
    </div>
  
    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p class="zone-txt">ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p>
      <img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" style="display:none" onchange="CORE.analyze(this)">

    <table class="data-table">
      <tr>
        <td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td>
        <td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td>
        <td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="text" id="date"></td>
      </tr>
      <tr>
        <td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td>
        <td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td>
        <td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td>
        <td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td>
      </tr>
      <tr>
        <td colspan="6" class="memo-td"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo"></textarea></td>
      </tr>
    </table>

    <button onclick="CORE.clearForm()" style="width:100%; height:40px; border-radius:8px; border:1px solid #ddd; background:#eee; color:#ff3b30; font-weight:900; margin-bottom:20px; cursor:pointer;">ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì „ì²´ ì‚­ì œ</button>

    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p class="zone-txt">ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p>
      <img id="view-before" class="preview-img">
    </div>

    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p class="zone-txt">ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p>
      <img id="view-after" class="preview-img">
    </div>

    <div class="drop-zone" style="border-style:solid; border-color:var(--success);">
      <p class="zone-txt" style="color:var(--success);">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„± ê²°ê³¼</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>

    <div class="drop-zone" onclick="document.getElementById('f-final').click()">
      <p class="zone-txt">ğŸ“¸ 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ (ì„œëª…ë³¸)</p>
      <img id="view-final" class="preview-img">
    </div>

    <input type="file" id="f-before" accept="image/*" style="display:none" onchange="CORE.p(this, 'view-before')">
    <input type="file" id="f-after" accept="image/*" style="display:none" onchange="CORE.processAfter(this)">
    <input type="file" id="f-final" accept="image/*" style="display:none" onchange="CORE.p(this, 'view-final')">

    <section class="sheet-section">
      <div class="sheet-title">
        <span>ğŸ“Š ì‘ì—… ë¬´ê²°ì„± ë°ì´í„° ë¦¬ìŠ¤íŠ¸ <span class="data-count" id="dataCount">(0ê±´)</span></span>
        <button onclick="CORE.deleteDB()" style="font-size:0.6rem; padding:4px 8px; background:var(--danger); color:#fff; border:none; border-radius:5px; cursor:pointer;">DB ì´ˆê¸°í™”</button>
      </div>
      <div class="table-scroll">
        <table id="spreadsheet">
          <thead>
            <tr>
              <th>í˜„ì¥ëª…</th>
              <th>í•˜ìNo</th>
              <th>ë™/í˜¸ìˆ˜</th>
              <th>ì ‘ìˆ˜ì¼</th>
              <th>ë‹¨ê³„</th>
              <th>ìœ„ì¹˜</th>
              <th>ê³µì¢…</th>
              <th>ì—…ì²´ëª…</th>
              <th>í™•ì¸ì</th>
              <th>í•˜ìë‚´ìš©</th>
              <th>ì‚¬ì§„ì „</th>
              <th>ì‚¬ì§„í›„</th>
              <th>ë©”íŠ¸ë¡œ<br>ë³´ë“œíŒ</th>
              <th>ìµœì¢…<br>í™•ì¸ì„œ</th>
            </tr>
          </thead>
          <tbody id="data-body">
            <tr>
              <td colspan="14" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <button class="btn-save" onclick="CORE.save()">ë°ì´í„° ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  const CORE = {
    key: "AIzaSyBENfF9-fgspCqGPQoWe7CqA0JXTCsbfT0",
    db: "METRO_DB_V2",  // DB í‚¤ ë³€ê²½ìœ¼ë¡œ ë²„ì „ ì‹œìŠ¤í…œ ë¦¬ì…‹
    versionKey: "METRO_VERSION_V2",  // ë²„ì „ í‚¤ë„ ë³€ê²½

    // ========== ë²„ì „ ê´€ë¦¬ ==========
    getVersion: function() {
      let version = parseFloat(localStorage.getItem(this.versionKey) || "1.0");
      console.log('ğŸ“Œ í˜„ì¬ ë²„ì „:', version);
      return version;
    },

    incrementVersion: function() {
      let currentVersion = this.getVersion();
      let newVersion = currentVersion + 0.1;
      newVersion = Math.round(newVersion * 10) / 10; // ì†Œìˆ˜ì  1ìë¦¬
      localStorage.setItem(this.versionKey, newVersion.toString());
      console.log(`ğŸ“ˆ ë²„ì „ ì¦ê°€: ${currentVersion} â†’ ${newVersion}`);
      this.updateVersionDisplay();
      return newVersion;
    },

    updateVersionDisplay: function() {
      const version = this.getVersion();
      const badge = document.getElementById('versionBadge');
      if (badge) {
        badge.textContent = `VER ${version.toFixed(1)} ULTIMATE SPREADSHEET`;
        console.log('âœ… í™”ë©´ ë²„ì „ ì—…ë°ì´íŠ¸:', version.toFixed(1));
      }
    },

    resetVersion: function() {
      localStorage.setItem(this.versionKey, "1.0");
      this.updateVersionDisplay();
      console.log('ğŸ”„ ë²„ì „ 1.0ìœ¼ë¡œ ì´ˆê¸°í™”');
    },

    // ========== êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ==========
    appendToSheet: async function(data) {
      const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
      const sheetName = document.getElementById('sheetName').value.trim();
      
      if (!spreadsheetId || !sheetName) {
        this.showStatus('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDì™€ ì‹œíŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return false;
      }

      const values = [[
        data.site || '',
        data.no || '',
        data.unit || '',
        data.date || '',
        data.step || '',
        data.loc || '',
        data.work || '',
        data.comp || '',
        data.name || '',
        data.memo || '',
        data.imgBefore ? 'ì‚¬ì§„ ìˆìŒ' : '',
        data.imgAfter ? 'ì‚¬ì§„ ìˆìŒ' : '',
        data.imgBoard ? 'ì‚¬ì§„ ìˆìŒ' : '',
        data.imgFinal ? 'ì‚¬ì§„ ìˆìŒ' : ''
      ]];

      const range = `${sheetName}!A:N`;

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}:append?valueInputOption=USER_ENTERED&key=${this.key}`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            values: values
          })
        });

        const result = await response.json();
        
        if (response.ok) {
          console.log('âœ… Google Sheets ì €ì¥ ì„±ê³µ:', result);
          this.showStatus('âœ… êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          return true;
        } else {
          console.error('âŒ Google Sheets API ì˜¤ë¥˜:', result);
          this.showStatus(`âš ï¸ êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨: CORS ì •ì±… ì œí•œ`, 'warning');
          return false;
        }
      } catch (error) {
        console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        this.showStatus('âš ï¸ ë¡œì»¬ DBì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.', 'warning');
        return false;
      }
    },

    testConnection: async function() {
      const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
      
      if (!spreadsheetId) {
        this.showStatus('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${this.key}`;
        const response = await fetch(url);

        if (response.ok) {
          const data = await response.json();
          console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì •ë³´:', data);
          this.showStatus('âœ… ì—°ê²° ì„±ê³µ!', 'success');
        } else {
          this.showStatus('âš ï¸ CORS ì •ì±…ìœ¼ë¡œ ì—°ê²° ì œí•œ', 'warning');
        }
      } catch (error) {
        console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        this.showStatus('âš ï¸ CORS ì •ì±…ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      }
    },

    showStatus: function(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = 'status-message status-' + type;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    },

    // ========== ì‚¬ì§„ ì²˜ë¦¬ ==========
    p: function(input, id) {
      if (!input.files || !input.files[0]) return;
      const targetImg = document.getElementById(id);
      const r = new FileReader();
      r.onload = function(e) {
        targetImg.onload = () => { 
          targetImg.style.display = 'block'; 
          console.log('âœ… ì‚¬ì§„ ì—…ë¡œë“œ:', id);
        };
        targetImg.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    },

    // ========== AI í…ìŠ¤íŠ¸ ì¸ì‹ ==========
    map: function(t) {
      const g = (re) => (t.match(re) || ["", ""])[1]?.trim() || "";
      const steps = ["1ë…„ì°¨", "2ë…„ì°¨", "3ë…„ì°¨"];
      const locs = ["ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "ì•ŒíŒŒë£¸"];
      const works = ["PLì°½í˜¸ê³µì‚¬", "ë„ë°°ê³µì‚¬"];
      
      document.getElementById('site').value = g(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9- ]+)/) || "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('haja').value = g(/í•˜ì\s*No\s*[:\s]*(\d+)/) || g(/(\d{7})/);
      document.getElementById('unit').value = g(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/);
      document.getElementById('date').value = g(/(\d{4}-\d{2}-\d{2})/) || new Date().toISOString().split('T')[0];
      
      const lines = t.split('\n');
      lines.forEach((l, i) => {
        const c = l.replace(/\s/g, "");
        if(c.includes("ì ‘ìˆ˜ë‹¨ê³„")) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ì ‘ìˆ˜ë‹¨ê³„")).pop() || lines[i+1]?.trim();
          document.getElementById('step').value = steps.find(s => v?.includes(s)) || "1ë…„ì°¨";
        }
        if(c.includes("ì‹¤ëª…") || (c.includes("ìœ„ì¹˜") && !c.includes("ìƒì„¸"))) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ì‹¤ëª…") && !x.includes("ìœ„ì¹˜")).pop() || lines[i+1]?.trim();
          document.getElementById('loc').value = locs.find(s => v?.includes(s)) || "ê±°ì‹¤";
        }
        if(c.includes("ê³µì¢…")) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ê³µì¢…")).pop() || lines[i+1]?.trim();
          document.getElementById('work').value = works.find(s => v?.includes(s)) || "PLì°½í˜¸ê³µì‚¬";
        }
      });
      
      document.getElementById('comp').value = "ì§„í¥ê±´ì—…(ì£¼)";
      const mIdx = t.indexOf("í•˜ìë‚´ìš©");
      if(mIdx !== -1) {
        document.getElementById('memo').value = t.substring(mIdx + 4, mIdx + 300).replace(/\n/g, " ").trim();
      }
      
      console.log('âœ… AI í…ìŠ¤íŠ¸ ë§¤í•‘ ì™„ë£Œ');
    },

    analyze: async function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      const r = new FileReader();
      r.onload = async (e) => {
        const b64 = e.target.result.split(',')[1];
        try {
          const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.key}`, {
            method: 'POST',
            body: JSON.stringify({ 
              requests: [{ 
                image: { content: b64 }, 
                features: [{ type: "DOCUMENT_TEXT_DETECTION" }] 
              }] 
            })
          });
          const d = await res.json();
          if (d.responses[0]?.fullTextAnnotation) {
            this.map(d.responses[0].fullTextAnnotation.text);
          }
        } catch(err) { 
          console.error('âŒ AI ë¶„ì„ ì˜¤ë¥˜:', err);
          alert("AI ë¶„ì„ ì‹¤íŒ¨"); 
        } finally { 
          document.getElementById('loader').style.display = 'none'; 
        }
      };
      r.readAsDataURL(input.files[0]);
    },

    // ========== ë³´ë“œíŒ ìƒì„± ==========
    processAfter: function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-after');
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => this.draw(img);
        img.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    },

    draw: function(img) {
      const cvs = document.getElementById('boardCanvas');
      const ctx = cvs.getContext('2d');
      cvs.width = 1200; 
      cvs.height = 1600;
      ctx.drawImage(img, 0, 0, 1200, 1600);
      
      const bW = 460, bH = 360, sX = 45, sY = 1600 - bH - 45;
      ctx.fillStyle = "rgba(255,255,255,0.95)"; 
      ctx.fillRect(sX, sY, bW, bH);
      ctx.strokeStyle = "#000"; 
      ctx.lineWidth = 7; 
      ctx.strokeRect(sX, sY, bW, bH);
      ctx.fillStyle = "#000"; 
      ctx.font = "bold 32px sans-serif";
      
      const h = ["í˜„ì¥ëª…", "ë™/í˜¸ìˆ˜", "ìœ„ì¹˜", "ì‘ì—…ì§„í–‰", "ì‘ì—…ì¼"];
      for(let i=0; i<5; i++){
        let y = sY + (bH/5)*i;
        if(i>0){ 
          ctx.beginPath(); 
          ctx.moveTo(sX,y); 
          ctx.lineTo(sX+bW,y); 
          ctx.stroke(); 
        }
        ctx.fillText(h[i], sX+15, y+45);
      }
      
      const v = (id) => document.getElementById(id).value || "-";
      ctx.font = "30px sans-serif";
      ctx.fillText(v('site'), sX+155, sY+45);
      ctx.fillText(v('unit'), sX+155, sY+(bH/5)*1+45);
      ctx.fillText(v('loc'), sX+155, sY+(bH/5)*2+45);
      ctx.fillText("ìˆ˜ë¦¬í›„", sX+155, sY+(bH/5)*3+45);
      ctx.fillText(v('date'), sX+155, sY+(bH/5)*4+45);
      
      const vb = document.getElementById('view-board');
      vb.src = cvs.toDataURL("image/jpeg", 0.9);
      vb.style.display='block';
      
      console.log('âœ… ë³´ë“œíŒ ìƒì„± ì™„ë£Œ');
    },

    // ========== ë°ì´í„° ì €ì¥ (ë²„ì „ ì¦ê°€ í¬í•¨) ==========
    save: async function() {
      console.log('ğŸ’¾ ì €ì¥ ì‹œì‘...');
      
      const getSrc = (id) => {
        const el = document.getElementById(id);
        return (el && el.src && el.style.display !== 'none') ? el.src : "";
      };
      
      const data = {
        site: document.getElementById('site').value,
        no: document.getElementById('haja').value || "0000",
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        imgBefore: getSrc('view-before'),
        imgAfter: getSrc('view-after'),
        imgBoard: getSrc('view-board'),
        imgFinal: getSrc('view-final'),
        timestamp: new Date().toLocaleString('ko-KR')
      };
      
      console.log('ğŸ“¦ ì €ì¥í•  ë°ì´í„°:', {
        í˜„ì¥ëª…: data.site,
        í•˜ìNo: data.no,
        ë™í˜¸ìˆ˜: data.unit,
        ì‚¬ì§„ì „: data.imgBefore ? 'O' : 'X',
        ì‚¬ì§„í›„: data.imgAfter ? 'O' : 'X',
        ë³´ë“œíŒ: data.imgBoard ? 'O' : 'X',
        í™•ì¸ì„œ: data.imgFinal ? 'O' : 'X'
      });
      
      // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      let list = JSON.parse(localStorage.getItem(this.db) || "[]");
      list.push(data);
      localStorage.setItem(this.db, JSON.stringify(list));
      console.log(`âœ… ë¡œì»¬ DB ì €ì¥ ì™„ë£Œ (ì´ ${list.length}ê±´)`);
      
      // 2. ë²„ì „ ì¦ê°€ (ì¤‘ìš”!)
      const newVersion = this.incrementVersion();
      
      // 3. í™”ë©´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      this.render();
      
      // 4. êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ ì‹œë„
      const sheetSuccess = await this.appendToSheet(data);
      
      // 5. ê²°ê³¼ ì•Œë¦¼
      if (sheetSuccess) {
        alert(`âœ… ì €ì¥ ì™„ë£Œ!\n\në²„ì „: ${newVersion.toFixed(1)}\në¡œì»¬ DB: âœ“\nêµ¬ê¸€ ì‹œíŠ¸: âœ“`);
      } else {
        alert(`âœ… ë¡œì»¬ DBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në²„ì „: ${newVersion.toFixed(1)}\nì´ ë°ì´í„°: ${list.length}ê±´`);
      }
      
      console.log('ğŸ‰ ì €ì¥ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!');
    },

    // ========== í™”ë©´ ë Œë”ë§ ==========
    render: function() {
      const list = JSON.parse(localStorage.getItem(this.db) || "[]");
      console.log(`ğŸ”„ ë Œë”ë§ ì‹œì‘ (ë°ì´í„° ${list.length}ê±´)`);
      
      const body = document.getElementById('data-body');
      const dataCount = document.getElementById('dataCount');
      
      if (!body) {
        console.error('âŒ data-body ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
      }
      
      // ë°ì´í„° ê°œìˆ˜ ì—…ë°ì´íŠ¸
      if (dataCount) {
        dataCount.textContent = `(${list.length}ê±´)`;
      }
      
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´
      if (list.length === 0) {
        body.innerHTML = '<tr><td colspan="14" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        console.log('â„¹ï¸ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ');
        return;
      }
      
      // ë°ì´í„° ë Œë”ë§
      const makeImg = (src) => src ? `<img src="${src}" class="thumb">` : '-';
      
      const html = list.map((r, idx) => {
        console.log(`ğŸ“‹ í–‰ ${idx + 1}:`, {
          í˜„ì¥ëª…: r.site,
          í•˜ìNo: r.no,
          ë‹¨ê³„: r.step,
          ìœ„ì¹˜: r.loc
        });
        
        return `
          <tr>
            <td style="font-weight:700;">${r.site || '-'}</td>
            <td style="color:#007aff;">${r.no || '-'}</td>
            <td>${r.unit || '-'}</td>
            <td style="font-size:0.6rem;">${r.date || '-'}</td>
            <td>${r.step || '-'}</td>
            <td>${r.loc || '-'}</td>
            <td>${r.work || '-'}</td>
            <td>${r.comp || '-'}</td>
            <td>${r.name || '-'}</td>
            <td style="text-align:left; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.memo || '-'}</td>
            <td>${makeImg(r.imgBefore)}</td>
            <td>${makeImg(r.imgAfter)}</td>
            <td>${makeImg(r.imgBoard)}</td>
            <td>${makeImg(r.imgFinal)}</td>
          </tr>
        `;
      }).join('');
      
      body.innerHTML = html;
      console.log('âœ… ë Œë”ë§ ì™„ë£Œ!');
    },

    // ========== ì…ë ¥ì¹¸ ì´ˆê¸°í™” ==========
    clearForm: function() {
      if(confirm("ì…ë ¥ì¹¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        ['site','haja','unit','date','step','loc','work','comp','name','memo'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        ['view-ai','view-before','view-after','view-board','view-final'].forEach(id => {
          const img = document.getElementById(id);
          if (img) {
            img.src = "";
            img.style.display = "none";
          }
        });
        console.log('ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    },

    // ========== DB ì´ˆê¸°í™” ==========
    deleteDB: function() {
      if(confirm("ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në²„ì „ë„ 1.0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) {
        localStorage.removeItem(this.db);
        this.resetVersion();
        this.render();
        alert("âœ… ë¡œì»¬ DBì™€ ë²„ì „ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        console.log('ğŸ”„ DB ì´ˆê¸°í™” ì™„ë£Œ');
      }
    }
  };

  // ========== í˜ì´ì§€ ë¡œë“œ ==========
  window.onload = () => {
    console.log('ğŸš€ (ì£¼)ë©”íŠ¸ë¡œ R&S AI ì‹œìŠ¤í…œ ì‹œì‘');
    console.log('ğŸ“ DB í‚¤:', CORE.db);
    console.log('ğŸ“ ë²„ì „ í‚¤:', CORE.versionKey);
    
    CORE.updateVersionDisplay();
    CORE.render();
    
    console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
  };
</script>
</body>
</html>
