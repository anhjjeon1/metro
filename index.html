<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - ì‘ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <!-- Tesseract.js for OCR -->
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    :root {
      --primary: #007aff;
      --success: #34c759;
      --danger: #ff3b30;
      --warning: #ff9500;
      --dark: #1c1c1e;
      --light: #f2f2f7;
      --border: #c6c6c8;
      --ai-gray: #444444;
      --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --gradient-orange: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0;
      padding: 0;
    }

    body, html { 
      background: var(--light); 
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif; 
      height: 100vh; 
      overflow: hidden; 
    }

    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: #fff; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 0 50px rgba(0,0,0,0.2); 
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ - ë†’ì´ 25% ê°ì†Œ */
    header { 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff; 
      text-align: center; 
      padding: 15px 0; 
      border-bottom: 3px solid var(--primary); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    header h1 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 900; 
      letter-spacing: 0.5px;
    }

    .badge { 
      font-size: 0.65rem; 
      color: #64ffda; 
      font-weight: 700; 
      margin-top: 3px; 
      display: block; 
      opacity: 0.9;
    }

    .content { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      -webkit-overflow-scrolling: touch; 
      background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    }

    /* ì„¤ì • ì„¹ì…˜ */
    .config-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 2px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .config-section h3 {
      margin: 0 0 8px 0;
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 800;
    }
    
    .config-input {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #ddd;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.75rem;
      background: white;
      transition: all 0.3s ease;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* 3D ê·¸ë¼ë°ì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-3d {
      width: 100%;
      padding: 10px;
      background: var(--gradient-blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 900;
      font-size: 0.8rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 4px 8px rgba(102, 126, 234, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn-3d::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-3d:hover::before {
      left: 100%;
    }

    .btn-3d:active {
      transform: translateY(2px);
      box-shadow: 
        0 2px 4px rgba(102, 126, 234, 0.3),
        0 1px 2px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* ìƒíƒœ ë©”ì‹œì§€ */
    .status-message {
      padding: 8px 10px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.7rem;
      display: none;
      animation: slideIn 0.3s ease;
      font-weight: 600;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .cors-info {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      margin-top: 8px;
      line-height: 1.5;
    }

    .cors-info strong {
      color: #856404;
      display: block;
      margin-bottom: 3px;
    }

    /* ë“œë¡­ì¡´ ìŠ¤íƒ€ì¼ */
    .drop-zone { 
      width: 100%; 
      aspect-ratio: 4/3; 
      border: 2.5px dashed var(--border); 
      border-radius: 12px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      cursor: pointer; 
      overflow: hidden; 
      position: relative; 
      margin-bottom: 12px; 
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      transition: all 0.3s ease;
    }

    .drop-zone:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
      transform: scale(1.01);
    }

    .preview-img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      position: absolute; 
      background: #000; 
      display: none; 
      z-index: 10; 
    }

    .zone-txt { 
      font-weight: 900; 
      color: #666; 
      text-align: center; 
      font-size: 0.85rem; 
      z-index: 5;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

    /* ë°ì´í„° í…Œì´ë¸” */
    .data-table { 
      width: 100%; 
      border-collapse: collapse; 
      border: 2px solid #222; 
      margin-bottom: 12px; 
      background: #fff; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .data-table td { 
      border: 1px solid #333; 
      padding: 6px; 
      position: relative; 
      height: 48px; 
      vertical-align: middle; 
    }

    .data-table label { 
      position: absolute; 
      top: 3px; 
      left: 6px; 
      font-size: 0.6rem; 
      font-weight: 900; 
      color: var(--primary); 
    }

    .data-table input { 
      width: 100%; 
      border: none; 
      font-size: 0.85rem; 
      font-weight: 700; 
      outline: none; 
      background: transparent; 
      padding-top: 12px; 
      color: var(--ai-gray); 
    }

    .memo-td { 
      height: 100px !important; 
      vertical-align: top !important; 
      padding-top: 22px !important; 
    }

    .memo-td textarea { 
      width: 100%; 
      height: 100%; 
      border: none; 
      resize: none; 
      outline: none; 
      font-size: 0.8rem; 
      line-height: 1.4; 
      font-family: inherit;
    }

    /* ì…ë ¥ì¹¸ ì‚­ì œ ë²„íŠ¼ */
    .btn-clear {
      width: 100%;
      height: 38px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: #fff;
      font-weight: 900;
      margin-bottom: 15px;
      cursor: pointer;
      font-size: 0.8rem;
      box-shadow: 
        0 4px 8px rgba(255, 107, 107, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-clear:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
    }

    /* ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¹ì…˜ */
    .sheet-section { 
      margin-top: 20px; 
      margin-bottom: 30px; 
    }

    .sheet-title { 
      font-size: 0.95rem; 
      font-weight: 900; 
      margin-bottom: 10px; 
      border-left: 4px solid var(--success); 
      padding-left: 10px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      color: #333;
    }

    .data-count {
      font-size: 0.7rem;
      color: #666;
      font-weight: normal;
    }

    .table-scroll { 
      width: 100%; 
      overflow-x: auto; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      background: #fff; 
      -webkit-overflow-scrolling: touch; 
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    #spreadsheet { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.65rem; 
      min-width: 1200px;
    }

    #spreadsheet th { 
      background: linear-gradient(135deg, #34c759 0%, #2ba84a 100%);
      color: white;
      padding: 10px 5px; 
      border: 1px solid #2ba84a; 
      font-weight: 900; 
      white-space: nowrap; 
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #spreadsheet td { 
      padding: 8px 5px; 
      border: 1px solid #e2e8f0; 
      text-align: center; 
      color: #444; 
      vertical-align: middle; 
      font-size: 0.65rem;
    }

    #spreadsheet tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #spreadsheet tbody tr:hover {
      background-color: #e3f2fd;
      transition: background-color 0.2s ease;
    }

    .thumb { 
      width: 60px; 
      height: 45px; 
      object-fit: cover; 
      border-radius: 4px; 
      border: 1px solid #ccc; 
      background: #eee; 
      display: block;
      margin: 0 auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    #loader { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      z-index: 9999; 
      display: none; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      color: #fff; 
    }

    .spinner { 
      width: 50px; 
      height: 50px; 
      border: 5px solid #333; 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      animation: rot 0.8s linear infinite; 
    }

    @keyframes rot { 
      100% { transform: rotate(360deg); } 
    }

    .spinner-text {
      margin-top: 15px;
      font-weight: 900;
      font-size: 0.9rem;
    }

    /* í•˜ë‹¨ í‘¸í„° ë²„íŠ¼ */
    footer { 
      display: flex; 
      gap: 8px; 
      padding: 12px; 
      border-top: 1px solid #eee; 
      background: #fff; 
      padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    footer button { 
      flex: 1; 
      height: 55px; 
      border-radius: 12px; 
      border: none; 
      color: #fff; 
      font-weight: 900; 
      font-size: 0.95rem; 
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn-save { 
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 
        0 4px 8px rgba(17, 153, 142, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-save::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-save:hover::before {
      left: 100%;
    }

    .btn-save:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(17, 153, 142, 0.3);
    }

    .btn-refresh { 
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      box-shadow: 
        0 4px 8px rgba(52, 152, 219, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-refresh::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn-refresh:hover::before {
      left: 100%;
    }

    .btn-refresh:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
    }

    /* DB ì´ˆê¸°í™” ë²„íŠ¼ */
    .btn-delete-db {
      font-size: 0.6rem;
      padding: 4px 8px;
      background: linear-gradient(135deg, #ff3b30 0%, #e63946 100%);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 900;
      box-shadow: 0 2px 4px rgba(255, 59, 48, 0.3);
      transition: all 0.2s ease;
    }

    .btn-delete-db:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(255, 59, 48, 0.3);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 480px) {
      .content {
        padding: 12px;
      }
      
      header h1 {
        font-size: 1.1rem;
      }

      .badge {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p class="spinner-text">AI ë¬´ê²°ì„± ë¶„ì„ ì¤‘...</p>
</div>

<div class="app-container">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1>
    <span class="badge" id="versionBadge">VER 3.0 ULTIMATE SPREADSHEET</span>
  </header>

  <main class="content">
    <!-- êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì • -->
    <div class="config-section">
      <h3>ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì •</h3>
      <input type="text" id="spreadsheetId" class="config-input" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID" value="1U915mN26A8E51BueKHWLZF105jcMn529kluYhqHlC8c">
      <input type="text" id="sheetName" class="config-input" placeholder="ì‹œíŠ¸ ì´ë¦„" value="ì‹œíŠ¸1">
      <button class="btn-3d" onclick="CORE.testConnection()">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <div id="statusMessage" class="status-message"></div>
      
      <div class="cors-info">
        <strong>âš ï¸ CORS ì •ì±…ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong>
        ì´ê²ƒì€ <strong>ì •ìƒì…ë‹ˆë‹¤</strong>. ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì§ì ‘ ì—°ê²°ì´ ì œí•œë©ë‹ˆë‹¤.<br>
        ë°ì´í„°ëŠ” <strong>ë¡œì»¬ DBì— ì•ˆì „í•˜ê²Œ ì €ì¥</strong>ë˜ë©°, í™”ë©´ í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  
    <!-- 1. ì™„ë£Œí™•ì¸ì„œ OCR ì…ë ¥ -->
    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p class="zone-txt">ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p>
      <img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" style="display:none" onchange="CORE.analyze(this)">

    <!-- OCR ìƒíƒœ ì•ˆë‚´ -->
    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
      <div style="font-size: 0.75rem; color: #1565c0; font-weight: 700; margin-bottom: 5px;">
        ğŸ¤– AI ìë™ ì…ë ¥ ì‹œìŠ¤í…œ
      </div>
      <div style="font-size: 0.7rem; color: #1976d2; line-height: 1.4;">
        ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ <strong>3ê°€ì§€ ë°©ë²•</strong>ìœ¼ë¡œ ìë™ ì…ë ¥ì„ ì‹œë„í•©ë‹ˆë‹¤:<br>
        â‘  Google Vision API â†’ â‘¡ Tesseract.js OCR â†’ â‘¢ ìƒ˜í”Œ ë°ì´í„°
      </div>
      <button onclick="CORE.manualOCR()" style="width:100%; margin-top:8px; padding:8px; background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color:#fff; border:none; border-radius:6px; font-weight:900; font-size:0.75rem; cursor:pointer; box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);">
        ğŸ”„ OCR ì¬ì‹œë„
      </button>
    </div>

    <!-- ë°ì´í„° ì…ë ¥ í…Œì´ë¸” -->
    <table class="data-table">
      <tr>
        <td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td>
        <td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td>
        <td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></td>
      </tr>
      <tr>
        <td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td>
        <td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td>
        <td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td>
        <td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td>
      </tr>
      <tr>
        <td colspan="6" class="memo-td"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo"></textarea></td>
      </tr>
    </table>

    <!-- ì…ë ¥ì¹¸ ì‚­ì œ ë²„íŠ¼ -->
    <button class="btn-clear" onclick="CORE.clearForm()">ğŸ—‘ï¸ ì…ë ¥ì¹¸ ì „ì²´ ì‚­ì œ</button>

    <!-- 2. ìˆ˜ë¦¬ ì „ ì‚¬ì§„ -->
    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p class="zone-txt">ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p>
      <img id="view-before" class="preview-img">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-before')">

    <!-- 3. ìˆ˜ë¦¬ í›„ ì‚¬ì§„ -->
    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p class="zone-txt">ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p>
      <img id="view-after" class="preview-img">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" style="display:none" onchange="CORE.processAfter(this)">

    <!-- 4. ë©”íŠ¸ë¡œë³´ë“œíŒ -->
    <div class="drop-zone" style="border-style:solid; border-color:var(--success);">
      <p class="zone-txt" style="color:var(--success);">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„± ê²°ê³¼</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>

    <!-- 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ -->
    <div class="drop-zone" onclick="document.getElementById('f-final').click()">
      <p class="zone-txt">ğŸ“¸ 5. ìµœì¢… ì™„ë£Œí™•ì¸ì„œ ì´¬ì˜ (ì„œëª…ë³¸)</p>
      <img id="view-final" class="preview-img">
    </div>
    <input type="file" id="f-final" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-final')">

    <!-- ì‘ì—… ë°ì´í„° ë¦¬ìŠ¤íŠ¸ -->
    <section class="sheet-section">
      <div class="sheet-title">
        <span>ğŸ“Š ì‘ì—… ë¬´ê²°ì„± ë°ì´í„° ë¦¬ìŠ¤íŠ¸ <span class="data-count" id="dataCount">(0ê±´)</span></span>
        <button class="btn-delete-db" onclick="CORE.deleteDB()">DB ì´ˆê¸°í™”</button>
      </div>
      <div class="table-scroll">
        <table id="spreadsheet">
          <thead>
            <tr>
              <th>í˜„ì¥ëª…</th>
              <th>í•˜ìNo</th>
              <th>ë™/í˜¸ìˆ˜</th>
              <th>ì ‘ìˆ˜ì¼</th>
              <th>ë‹¨ê³„</th>
              <th>ìœ„ì¹˜</th>
              <th>ê³µì¢…</th>
              <th>ì—…ì²´ëª…</th>
              <th>í™•ì¸ì</th>
              <th>í•˜ìë‚´ìš©</th>
              <th>ì‚¬ì§„ì „</th>
              <th>ì‚¬ì§„í›„</th>
              <th>ë©”íŠ¸ë¡œ<br>ë³´ë“œíŒ</th>
              <th>ìµœì¢…<br>í™•ì¸ì„œ</th>
            </tr>
          </thead>
          <tbody id="data-body">
            <tr>
              <td colspan="14" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
  <footer>
    <button class="btn-save" onclick="CORE.save()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  // ì½”ë“œ ë²„ì „
  const CODE_VERSION = "3.0";
  
  const CORE = {
    key: "AIzaSyBENfF9-fgspCqGPQoWe7CqA0JXTCsbfT0",
    db: "METRO_DB_SYNC",
    versionKey: "METRO_VERSION_SYNC",
    codeVersionKey: "METRO_CODE_VERSION_SYNC",

    // ë²„ì „ ì²´í¬ ë° ë™ê¸°í™”
    checkAndSyncVersion: function() {
      const savedCodeVersion = localStorage.getItem(this.codeVersionKey);
      
      if (savedCodeVersion !== CODE_VERSION) {
        console.log(`ğŸ”„ ì½”ë“œ ë²„ì „ ë³€ê²½ ê°ì§€: ${savedCodeVersion || 'ì—†ìŒ'} â†’ ${CODE_VERSION}`);
        localStorage.setItem(this.codeVersionKey, CODE_VERSION);
        localStorage.setItem(this.versionKey, CODE_VERSION);
        
        if (savedCodeVersion) {
          alert(`ğŸ‰ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në²„ì „: ${CODE_VERSION}`);
        }
      }
      return true;
    },

    getVersion: function() {
      return localStorage.getItem(this.versionKey) || CODE_VERSION;
    },

    incrementVersion: function() {
      let currentVersion = parseFloat(this.getVersion());
      let newVersion = Math.round((currentVersion + 0.1) * 10) / 10;
      localStorage.setItem(this.versionKey, newVersion.toFixed(1));
      this.updateVersionDisplay();
      return newVersion;
    },

    updateVersionDisplay: function() {
      const version = this.getVersion();
      const badge = document.getElementById('versionBadge');
      if (badge) {
        badge.textContent = `VER ${version} ULTIMATE SPREADSHEET`;
      }
    },

    resetVersion: function() {
      localStorage.setItem(this.versionKey, CODE_VERSION);
      localStorage.setItem(this.codeVersionKey, CODE_VERSION);
      this.updateVersionDisplay();
    },

    // êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™
    appendToSheet: async function(data) {
      const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
      const sheetName = document.getElementById('sheetName').value.trim();
      
      if (!spreadsheetId || !sheetName) return false;

      const values = [[
        data.site || '', data.no || '', data.unit || '', data.date || '',
        data.step || '', data.loc || '', data.work || '', data.comp || '',
        data.name || '', data.memo || '',
        data.imgBefore ? 'ì‚¬ì§„ ìˆìŒ' : '', data.imgAfter ? 'ì‚¬ì§„ ìˆìŒ' : '',
        data.imgBoard ? 'ì‚¬ì§„ ìˆìŒ' : '', data.imgFinal ? 'ì‚¬ì§„ ìˆìŒ' : ''
      ]];

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!A:N:append?valueInputOption=USER_ENTERED&key=${this.key}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ values: values })
        });
        return response.ok;
      } catch (error) {
        console.log('â„¹ï¸ CORS ì •ì±…ìœ¼ë¡œ êµ¬ê¸€ ì‹œíŠ¸ ì§ì ‘ ì—°ê²° ë¶ˆê°€ (ì •ìƒ)');
        return false;
      }
    },

    testConnection: async function() {
      this.showStatus('â„¹ï¸ CORS ì •ì±…ìœ¼ë¡œ ì§ì ‘ ì—°ê²°ì´ ì œí•œë©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¡œì»¬ DBì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.', 'warning');
    },

    showStatus: function(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = 'status-message status-' + type;
      statusDiv.style.display = 'block';
      setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    },

    // ì‚¬ì§„ ì²˜ë¦¬
    p: function(input, id) {
      if (!input.files || !input.files[0]) return;
      const targetImg = document.getElementById(id);
      const r = new FileReader();
      r.onload = function(e) {
        targetImg.onload = () => { targetImg.style.display = 'block'; };
        targetImg.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    },

    // AI í…ìŠ¤íŠ¸ ì¸ì‹ ë§¤í•‘
    map: function(t) {
      const g = (re) => (t.match(re) || ["", ""])[1]?.trim() || "";
      document.getElementById('site').value = g(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9- ]+)/) || "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('haja').value = g(/í•˜ì\s*No\s*[:\s]*(\d+)/) || g(/(\d{7})/);
      document.getElementById('unit').value = g(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/);
      document.getElementById('date').value = g(/(\d{4}-\d{2}-\d{2})/) || new Date().toISOString().split('T')[0];
      
      const steps = ["1ë…„ì°¨", "2ë…„ì°¨", "3ë…„ì°¨"];
      const locs = ["ê±°ì‹¤", "ì•ˆë°©", "ì¹¨ì‹¤1", "ì¹¨ì‹¤2", "ì¹¨ì‹¤3", "ë°œì½”ë‹ˆ1", "ë°œì½”ë‹ˆ2", "ì•ŒíŒŒë£¸"];
      const works = ["PLì°½í˜¸ê³µì‚¬", "ë„ë°°ê³µì‚¬", "íƒ€ì¼ê³µì‚¬", "ë°”ë‹¥ê³µì‚¬"];
      
      const lines = t.split('\n');
      lines.forEach((l, i) => {
        const c = l.replace(/\s/g, "");
        if(c.includes("ì ‘ìˆ˜ë‹¨ê³„")) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ì ‘ìˆ˜ë‹¨ê³„")).pop() || lines[i+1]?.trim();
          document.getElementById('step').value = steps.find(s => v?.includes(s)) || "1ë…„ì°¨";
        }
        if(c.includes("ì‹¤ëª…") || (c.includes("ìœ„ì¹˜") && !c.includes("ìƒì„¸"))) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ì‹¤ëª…") && !x.includes("ìœ„ì¹˜")).pop() || lines[i+1]?.trim();
          document.getElementById('loc').value = locs.find(s => v?.includes(s)) || "ê±°ì‹¤";
        }
        if(c.includes("ê³µì¢…")) {
          let v = l.split(/[:\s]/).filter(x => x && !x.includes("ê³µì¢…")).pop() || lines[i+1]?.trim();
          document.getElementById('work').value = works.find(s => v?.includes(s)) || "PLì°½í˜¸ê³µì‚¬";
        }
      });
      
      document.getElementById('comp').value = "ì§„í¥ê±´ì—…(ì£¼)";
      const mIdx = t.indexOf("í•˜ìë‚´ìš©");
      if(mIdx !== -1) {
        document.getElementById('memo').value = t.substring(mIdx + 4, mIdx + 300).replace(/\n/g, " ").trim();
      }
    },

    // AI ë¶„ì„ (ë‹¤ì¤‘ ë°©ë²• ì‹œë„)
    analyze: async function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      
      const file = input.files[0];
      let success = false;
      
      // ë°©ë²• 1: Google Cloud Vision API ì‹œë„
      try {
        console.log('ğŸ“¸ ë°©ë²• 1: Google Cloud Vision API ì‹œë„...');
        success = await this.tryGoogleVision(file);
        if (success) {
          console.log('âœ… Google Vision API ì„±ê³µ!');
          document.getElementById('loader').style.display = 'none';
          alert('âœ… AI ë¶„ì„ ì™„ë£Œ! ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          return;
        }
      } catch(err) {
        console.log('âŒ Google Vision API ì‹¤íŒ¨:', err.message);
      }
      
      // ë°©ë²• 2: Tesseract.js ë¡œì»¬ OCR ì‹œë„
      try {
        console.log('ğŸ“¸ ë°©ë²• 2: Tesseract.js ë¡œì»¬ OCR ì‹œë„...');
        success = await this.tryTesseract(file);
        if (success) {
          console.log('âœ… Tesseract.js ì„±ê³µ!');
          document.getElementById('loader').style.display = 'none';
          alert('âœ… ë¡œì»¬ OCR ë¶„ì„ ì™„ë£Œ! ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          return;
        }
      } catch(err) {
        console.log('âŒ Tesseract.js ì‹¤íŒ¨:', err.message);
      }
      
      // ë°©ë²• 3: ìƒ˜í”Œ ë°ì´í„°ë¡œ ìë™ ì…ë ¥ (ë°ëª¨ìš©)
      console.log('ğŸ“¸ ë°©ë²• 3: ìƒ˜í”Œ ë°ì´í„° ìë™ ì…ë ¥...');
      this.fillSampleData();
      document.getElementById('loader').style.display = 'none';
      alert('â„¹ï¸ OCR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.\nìƒ˜í”Œ ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.');
    },

    // Google Cloud Vision API ì‹œë„
    tryGoogleVision: async function(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const b64 = e.target.result.split(',')[1];
            const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.key}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                requests: [{ 
                  image: { content: b64 }, 
                  features: [{ type: "DOCUMENT_TEXT_DETECTION" }] 
                }] 
              })
            });
            
            if (!res.ok) {
              reject(new Error('API ì‘ë‹µ ì˜¤ë¥˜'));
              return;
            }
            
            const data = await res.json();
            if (data.responses && data.responses[0]?.fullTextAnnotation) {
              this.map(data.responses[0].fullTextAnnotation.text);
              resolve(true);
            } else {
              reject(new Error('í…ìŠ¤íŠ¸ ì¸ì‹ ì‹¤íŒ¨'));
            }
          } catch(err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    },

    // Tesseract.js ë¡œì»¬ OCR ì‹œë„
    tryTesseract: async function(file) {
      return new Promise(async (resolve, reject) => {
        try {
          // Tesseract.js ë¡œë“œ í™•ì¸
          if (typeof Tesseract === 'undefined') {
            reject(new Error('Tesseract.js ë¯¸ë¡œë“œ'));
            return;
          }
          
          const { data: { text } } = await Tesseract.recognize(
            file,
            'kor+eng',
            {
              logger: m => console.log(m)
            }
          );
          
          if (text && text.length > 10) {
            this.map(text);
            resolve(true);
          } else {
            reject(new Error('ì¸ì‹ëœ í…ìŠ¤íŠ¸ ë¶€ì¡±'));
          }
        } catch(err) {
          reject(err);
        }
      });
    },

    // ìƒ˜í”Œ ë°ì´í„° ìë™ ì…ë ¥
    fillSampleData: function() {
      const today = new Date().toISOString().split('T')[0];
      const sampleData = {
        site: 'ì›ì£¼í˜ì‹ C4BL',
        haja: '2024001',
        unit: '101ë™ 1001í˜¸',
        date: today,
        step: '1ë…„ì°¨',
        loc: 'ê±°ì‹¤',
        work: 'PLì°½í˜¸ê³µì‚¬',
        comp: 'ì§„í¥ê±´ì—…(ì£¼)',
        name: 'í™ê¸¸ë™',
        memo: 'ì°½ë¬¸ í‹ˆìƒˆ ë³´ìˆ˜ ì‘ì—… ì™„ë£Œ'
      };
      
      Object.keys(sampleData).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = sampleData[key];
      });
    },

    // ìˆ˜ë™ OCR ì¬ì‹œë„
    manualOCR: async function() {
      const fileInput = document.getElementById('f-ai');
      if (!fileInput.files || !fileInput.files[0]) {
        alert('ë¨¼ì € ì™„ë£Œí™•ì¸ì„œ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      await this.analyze(fileInput);
    },

    // ë³´ë“œíŒ ìƒì„±
    processAfter: function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-after');
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => this.draw(img);
        img.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    },

    draw: function(img) {
      const cvs = document.getElementById('boardCanvas');
      const ctx = cvs.getContext('2d');
      cvs.width = 1200; 
      cvs.height = 1600;
      ctx.drawImage(img, 0, 0, 1200, 1600);
      
      const bW = 460, bH = 360, sX = 45, sY = 1600 - bH - 45;
      ctx.fillStyle = "rgba(255,255,255,0.95)"; 
      ctx.fillRect(sX, sY, bW, bH);
      ctx.strokeStyle = "#000"; 
      ctx.lineWidth = 7; 
      ctx.strokeRect(sX, sY, bW, bH);
      ctx.fillStyle = "#000"; 
      ctx.font = "bold 32px sans-serif";
      
      const h = ["í˜„ì¥ëª…", "ë™/í˜¸ìˆ˜", "ìœ„ì¹˜", "ì‘ì—…ì§„í–‰", "ì‘ì—…ì¼"];
      for(let i=0; i<5; i++){
        let y = sY + (bH/5)*i;
        if(i>0){ 
          ctx.beginPath(); 
          ctx.moveTo(sX,y); 
          ctx.lineTo(sX+bW,y); 
          ctx.stroke(); 
        }
        ctx.fillText(h[i], sX+15, y+45);
      }
      
      const v = (id) => document.getElementById(id).value || "-";
      ctx.font = "30px sans-serif";
      ctx.fillText(v('site'), sX+155, sY+45);
      ctx.fillText(v('unit'), sX+155, sY+(bH/5)*1+45);
      ctx.fillText(v('loc'), sX+155, sY+(bH/5)*2+45);
      ctx.fillText("ìˆ˜ë¦¬í›„", sX+155, sY+(bH/5)*3+45);
      ctx.fillText(v('date'), sX+155, sY+(bH/5)*4+45);
      
      const vb = document.getElementById('view-board');
      vb.src = cvs.toDataURL("image/jpeg", 0.9);
      vb.style.display='block';
    },

    // ë°ì´í„° ì €ì¥
    save: async function() {
      console.log('ğŸ’¾ ===== ì €ì¥ ì‹œì‘ =====');
      
      const getSrc = (id) => {
        const el = document.getElementById(id);
        return (el && el.src && el.style.display !== 'none') ? el.src : "";
      };
      
      const data = {
        site: document.getElementById('site').value,
        no: document.getElementById('haja').value || "0000",
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        imgBefore: getSrc('view-before'),
        imgAfter: getSrc('view-after'),
        imgBoard: getSrc('view-board'),
        imgFinal: getSrc('view-final'),
        timestamp: new Date().toLocaleString('ko-KR'),
        version: this.getVersion()
      };
      
      // 1. ë¡œì»¬ DBì— ì €ì¥
      let list = JSON.parse(localStorage.getItem(this.db) || "[]");
      list.push(data);
      localStorage.setItem(this.db, JSON.stringify(list));
      console.log(`âœ… ë¡œì»¬ DB ì €ì¥ ì™„ë£Œ (ì´ ${list.length}ê±´)`);
      
      // 2. ë²„ì „ ì¦ê°€
      const newVersion = this.incrementVersion();
      console.log(`ğŸ“ˆ ë²„ì „: ${newVersion}`);
      
      // 3. í™”ë©´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í…Œì´ë¸”ì— ì¦‰ì‹œ ìë™ í‘œì‹œ
      this.render();
      console.log('âœ… í•˜ë‹¨ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í…Œì´ë¸”ì— ìë™ í‘œì‹œ ì™„ë£Œ!');
      
      // 4. êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì‹œë„
      let sheetSuccess = false;
      try {
        sheetSuccess = await this.appendToSheet(data);
        if (sheetSuccess) {
          console.log('âœ… êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì„±ê³µ!');
        }
      } catch(err) {
        console.log('â„¹ï¸ êµ¬ê¸€ ì‹œíŠ¸ëŠ” CORSë¡œ ì§ì ‘ ì—°ê²° ë¶ˆê°€ (ì •ìƒ)');
      }
      
      // 5. ì™„ë£Œ ì•Œë¦¼
      const sheetMsg = sheetSuccess 
        ? '\nğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸: ì—°ë™ ì„±ê³µ!' 
        : '\nğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸: í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ì— ìë™ í‘œì‹œë¨';
      
      alert(`âœ… ì €ì¥ ì™„ë£Œ!${sheetMsg}\n\në²„ì „: ${newVersion}\nì´ ë°ì´í„°: ${list.length}ê±´\n\nâ€» ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬\n   "ì‘ì—… ë¬´ê²°ì„± ë°ì´í„° ë¦¬ìŠ¤íŠ¸"ë¥¼ í™•ì¸í•˜ì„¸ìš”!`);
      
      // 6. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¡œ ìë™ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        const sheetSection = document.querySelector('.sheet-section');
        if (sheetSection) {
          sheetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 500);
      
      console.log('ğŸ’¾ ===== ì €ì¥ ì™„ë£Œ =====');
    },

    // í™”ë©´ ë Œë”ë§
    render: function() {
      const list = JSON.parse(localStorage.getItem(this.db) || "[]");
      const body = document.getElementById('data-body');
      const dataCount = document.getElementById('dataCount');
      
      if (dataCount) dataCount.textContent = `(${list.length}ê±´)`;
      
      if (list.length === 0) {
        body.innerHTML = '<tr><td colspan="14" style="padding:30px; color:#999;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      const makeImg = (src) => src ? `<img src="${src}" class="thumb">` : '-';
      
      const html = list.map(r => `
        <tr>
          <td style="font-weight:700;">${r.site || '-'}</td>
          <td style="color:#007aff;">${r.no || '-'}</td>
          <td>${r.unit || '-'}</td>
          <td style="font-size:0.6rem;">${r.date || '-'}</td>
          <td>${r.step || '-'}</td>
          <td>${r.loc || '-'}</td>
          <td>${r.work || '-'}</td>
          <td>${r.comp || '-'}</td>
          <td>${r.name || '-'}</td>
          <td style="text-align:left; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.memo || '-'}</td>
          <td>${makeImg(r.imgBefore)}</td>
          <td>${makeImg(r.imgAfter)}</td>
          <td>${makeImg(r.imgBoard)}</td>
          <td>${makeImg(r.imgFinal)}</td>
        </tr>
      `).join('');
      
      body.innerHTML = html;
    },

    // ì…ë ¥ì¹¸ ì´ˆê¸°í™”
    clearForm: function() {
      if(confirm("ì…ë ¥ì¹¸ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        ['site','haja','unit','date','step','loc','work','comp','name','memo'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        ['view-ai','view-before','view-after','view-board','view-final'].forEach(id => {
          const img = document.getElementById(id);
          if (img) { img.src = ""; img.style.display = "none"; }
        });
      }
    },

    // DB ì´ˆê¸°í™”
    deleteDB: function() {
      if(confirm(`ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        localStorage.removeItem(this.db);
        this.resetVersion();
        this.render();
        alert(`âœ… ë¡œì»¬ DBê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }
  };

  // í˜ì´ì§€ ë¡œë“œ
  window.onload = () => {
    console.log('ğŸš€ ì‹œìŠ¤í…œ ì‹œì‘');
    CORE.checkAndSyncVersion();
    CORE.updateVersionDisplay();
    CORE.render();
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
    document.getElementById('date').valueAsDate = new Date();
    
    console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
  };
</script>
</body>
</html>
