<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI v6.1</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{
      --navy:#0c1929;--navy-light:#162d4a;--navy-mid:#1e3a5f;
      --gold:#c8a45e;--gold-light:#dbb978;--gold-dim:#8a7340;--gold-pale:#f5edd8;
      --cream:#faf7f0;--white:#fefcf9;
      --red:#c0392b;--red-light:#fdf0ee;
      --green:#1a8a5c;--green-light:#eef8f3;
      --blue:#2c6fbb;--blue-light:#eef4fb;
      --text:#1a1a1a;--text-sub:#555;--text-dim:#888;--text-muted:#bbb;
      --border:#e0dbd0;--border-light:#eee9df;
      --shadow:0 2px 12px rgba(12,25,41,.08);--shadow-lg:0 8px 32px rgba(12,25,41,.12);
      --r:8px;--r-sm:5px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body,html{height:100vh;overflow:hidden;background:#e8e3d8}
    body{font-family:'Noto Sans KR','Outfit',sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:520px;margin:0 auto;height:100%;display:flex;flex-direction:column;background:var(--cream);box-shadow:var(--shadow-lg)}

    header{background:var(--navy);color:var(--cream);text-align:center;padding:11px 16px;position:relative;flex-shrink:0}
    header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
    header h1{font-family:'Outfit';font-size:1.1rem;font-weight:800;letter-spacing:2.5px;text-transform:uppercase}
    header .ver{font-family:'JetBrains Mono';font-size:.55rem;color:var(--gold);letter-spacing:3px;margin-top:1px}

    .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:10px}
    .content::-webkit-scrollbar{width:3px}
    .content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

    .sec{padding:12px 16px;border-bottom:1px solid var(--border-light)}
    .sec-head{display:flex;align-items:center;gap:7px;margin-bottom:10px}
    .sec-num{width:22px;height:22px;border-radius:50%;background:var(--navy);color:var(--gold);font-family:'Outfit';font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .sec-title{font-size:.8rem;font-weight:800;color:var(--navy)}
    .sec-sub{font-size:.58rem;color:var(--text-dim);margin-left:4px}

    /* UPLOAD */
    .upload-area{border:2px dashed var(--border);border-radius:var(--r);padding:16px;text-align:center;cursor:pointer;background:var(--white);transition:all .2s}
    .upload-area:active{background:var(--gold-pale);border-color:var(--gold)}
    .upload-area.loaded{border-style:solid;border-color:var(--green);background:var(--green-light)}
    .upload-icon{font-size:24px;margin-bottom:3px}
    .upload-text{font-size:.72rem;color:var(--text-sub);font-weight:600}
    .upload-hint{font-size:.58rem;color:var(--text-dim);margin-top:2px}
    .loaded-info{display:none;font-size:.7rem;font-weight:700;color:var(--green)}
    .upload-area.loaded .loaded-info{display:block}
    .upload-area.loaded .upload-icon,.upload-area.loaded .upload-text,.upload-area.loaded .upload-hint{display:none}

    /* FORM */
    .form-grid{display:flex;flex-direction:column;gap:6px}
    .form-row{display:grid;gap:6px}
    .form-row.c2{grid-template-columns:1fr 1fr}
    .form-row.c3{grid-template-columns:1fr 1fr 1fr}
    .form-row.c2-1{grid-template-columns:2fr 1fr}

    .field label{display:block;font-size:.52rem;font-weight:700;color:var(--gold-dim);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}
    .field input,.field select,.field textarea{
      width:100%;padding:9px 10px;border:1.5px solid var(--border);border-radius:var(--r-sm);
      font-size:.8rem;font-family:'Noto Sans KR';font-weight:600;background:var(--white);
      color:var(--text);outline:none;transition:border-color .2s;appearance:none;-webkit-appearance:none;
    }
    .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--navy)}
    .field input::placeholder,.field textarea::placeholder{color:var(--text-muted);font-weight:400}
    .field textarea{height:55px;resize:none;line-height:1.4;font-size:.75rem}

    /* ìë™ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    .field.auto input,.field.auto textarea{background:#eef4fb;border-color:#b8d4f0;color:var(--blue)}
    .field.auto label{color:var(--blue)}
    .field.auto label::after{content:' (ìë™)';font-weight:400;color:var(--text-muted)}

    .select-wrap{position:relative}
    .select-wrap::after{content:'â–¼';position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:.5rem;color:var(--text-dim);pointer-events:none}
    .select-wrap select{padding-right:24px;cursor:pointer}

    /* MATCH INFO */
    .match-info{
      padding:6px 10px;border-radius:var(--r-sm);font-size:.6rem;font-weight:600;
      margin-bottom:6px;display:none;
    }
    .match-info.found{display:block;background:var(--green-light);color:var(--green);border:1px solid #b8e6d0}
    .match-info.notfound{display:block;background:var(--red-light);color:var(--red);border:1px solid #f0c8c4}

    /* PHOTOS */
    .photo-section{margin-top:6px}
    .photo-section-label{font-size:.6rem;font-weight:700;color:var(--navy);margin-bottom:4px}
    .photo-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
    .photo-slot{border:2px dashed var(--border);border-radius:var(--r-sm);aspect-ratio:3/4;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;position:relative;overflow:hidden;background:var(--cream);transition:all .15s}
    .photo-slot:active{background:var(--gold-pale);border-color:var(--gold)}
    .photo-slot.filled{border-style:solid;border-color:var(--green)}
    .photo-slot .ps-icon{font-size:18px}
    .photo-slot .ps-label{font-size:.52rem;font-weight:700;color:var(--text-dim);margin-top:2px;text-align:center}
    .photo-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;z-index:5}
    .photo-slot.filled .ps-icon,.photo-slot.filled .ps-label{display:none}
    .photo-slot.filled img{display:block}
    .photo-del{display:none;position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:var(--red);color:white;border:none;font-size:9px;font-weight:900;cursor:pointer;z-index:10;align-items:center;justify-content:center}
    .photo-slot.filled .photo-del{display:flex}

    /* BUTTONS */
    .btn-del-row{padding:9px;border:1.5px solid var(--red);border-radius:var(--r-sm);background:var(--red-light);color:var(--red);font-size:.7rem;font-weight:800;cursor:pointer;font-family:'Noto Sans KR';transition:all .15s;width:100%}
    .btn-del-row:active{background:var(--red);color:white}
    .btn-save-entry{width:100%;padding:11px;margin-top:8px;border:none;border-radius:var(--r-sm);background:var(--navy);color:var(--gold);font-size:.82rem;font-weight:800;cursor:pointer;font-family:'Noto Sans KR';letter-spacing:.5px;transition:all .15s}
    .btn-save-entry:active{transform:scale(.97)}
    .btn{padding:9px 14px;border:none;border-radius:var(--r-sm);font-family:'Noto Sans KR';font-weight:800;font-size:.72rem;cursor:pointer;transition:all .15s}
    .btn:active{transform:scale(.97)}
    .btn-outline{background:transparent;color:var(--text-dim);border:1.5px solid var(--border)}
    .btn-full{width:100%}

    /* LOG TABLE */
    .log-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .log-head h3{font-size:.8rem;font-weight:800;color:var(--navy);display:flex;align-items:center;gap:6px}
    .log-count{font-size:.6rem;font-weight:400;color:var(--text-dim)}
    .btn-log-clear{padding:5px 10px;border:none;border-radius:var(--r-sm);font-size:.6rem;font-weight:800;cursor:pointer;font-family:'Noto Sans KR';background:var(--red);color:white}

    .table-wrap{width:100%;overflow-x:auto;border:1px solid var(--border);border-radius:var(--r);background:var(--white);-webkit-overflow-scrolling:touch;max-height:500px;overflow-y:auto;box-shadow:var(--shadow)}
    .log-table{width:100%;border-collapse:collapse;font-size:.55rem;min-width:1050px}
    .log-table th{background:var(--navy);color:var(--gold);padding:8px 4px;border:1px solid var(--navy-light);font-weight:700;white-space:nowrap;position:sticky;top:0;z-index:10;font-size:.52rem;letter-spacing:.5px}
    .log-table td{padding:5px 4px;border:1px solid #eee;text-align:center;vertical-align:middle;font-size:.55rem}
    .log-table tbody tr:nth-child(even){background:var(--cream)}
    .log-table tbody tr:hover{background:var(--blue-light)}
    .log-table .thumb{width:42px;height:32px;object-fit:cover;border-radius:3px;border:1px solid var(--border);display:block;margin:0 auto}
    .log-table .order-num{font-weight:800;color:var(--navy);font-size:.62rem}
    .log-table .btn-del-log{padding:3px 6px;border:none;border-radius:3px;background:var(--red);color:white;font-size:.5rem;font-weight:800;cursor:pointer}
    .log-empty{text-align:center;padding:20px;color:var(--text-muted);font-size:.7rem}

    /* FOOTER */
    footer{display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--border);background:var(--white);padding-bottom:calc(10px + env(safe-area-inset-bottom));flex-shrink:0}
    footer button{flex:1;height:46px;border-radius:var(--r);border:none;font-weight:800;font-size:.85rem;cursor:pointer;font-family:'Noto Sans KR';letter-spacing:.5px;transition:all .15s}
    footer button:active{transform:scale(.97)}
    .btn-send{background:var(--navy);color:var(--gold)}
    .btn-new{background:var(--gold);color:var(--navy)}

    .toast{position:fixed;bottom:68px;left:50%;transform:translateX(-50%) translateY(20px);padding:9px 20px;border-radius:var(--r);font-size:.72rem;font-weight:700;z-index:10000;opacity:0;transition:all .3s;pointer-events:none;max-width:90%;text-align:center;white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{background:var(--green);color:white}
    .toast.error{background:var(--red);color:white}
    .toast.info{background:var(--navy);color:var(--gold)}

    #loader{position:fixed;inset:0;background:rgba(12,25,41,.92);z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center}
    .spinner{width:38px;height:38px;border:3px solid var(--navy-mid);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #loader p{margin-top:10px;font-weight:700;font-size:.8rem;color:var(--gold)}

    .hidden-inputs{position:absolute;width:0;height:0;overflow:hidden}
    @media(max-width:380px){.form-row.c3{grid-template-columns:1fr 1fr}.photo-row{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loaderText">ì²˜ë¦¬ ì¤‘...</p></div>
<div class="toast" id="toast"></div>

<div class="app">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R &amp; S AI</h1>
    <div class="ver">VER 6.1 Â· FIELD WORK SYSTEM</div>
  </header>

  <main class="content">

    <!-- â•â•â• â‘  í•˜ì ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° â•â•â• -->
    <div class="sec">
      <div class="sec-head">
        <span class="sec-num">1</span>
        <span class="sec-title">í•˜ì ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</span>
        <span class="sec-sub">ìœ í˜•Â·ì—…ì²´Â·ë‚´ìš© ìë™ì…ë ¥ìš©</span>
      </div>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“‚</div>
        <div class="upload-text">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (.xlsx .xls .csv)</div>
        <div class="upload-hint">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë‹¤ìš´ë°›ì€ íŒŒì¼ë„ ê°€ëŠ¥</div>
        <div class="loaded-info" id="loadedInfo">âœ… <span id="loadedFileName"></span> Â· <span id="loadedRowCount"></span>ê±´ ë¡œë“œ</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden onchange="App.loadFile(this)">
      <button class="btn btn-outline btn-full" onclick="App.loadSample()" style="margin-top:6px;font-size:.63rem;">ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <!-- â•â•â• â‘¡ í˜„ì¥ ì…ë ¥ â•â•â• -->
    <div class="sec">
      <div class="sec-head">
        <span class="sec-num">2</span>
        <span class="sec-title">í˜„ì¥ ì…ë ¥</span>
      </div>

      <div class="form-grid">
        <!-- í˜„ì¥ëª… (ê³ ì • ì…ë ¥) -->
        <div class="form-row c2-1">
          <div class="field">
            <label>í˜„ì¥ëª… <span id="siteLockLabel" style="font-size:.48rem;color:var(--green);font-weight:400;display:none;">ğŸ”’ ê³ ì •ë¨</span></label>
            <input type="text" id="fSite" placeholder="í˜„ì¥ëª… ì…ë ¥ (ì…ë ¥ í›„ ê³ ì •)" onblur="App.lockSite()">
          </div>
          <div style="display:flex;align-items:end;gap:4px">
            <button class="btn-del-row" onclick="App.unlockSite()" style="font-size:.6rem;padding:6px">âœï¸ í˜„ì¥ë³€ê²½</button>
          </div>
        </div>

        <!-- ë™ / í˜¸ (ìˆ˜ë™) -->
        <div class="form-row c2">
          <div class="field"><label>ë™</label><input type="text" id="fDong" placeholder="101" inputmode="numeric" oninput="App.tryAutoFill()"></div>
          <div class="field"><label>í˜¸</label><input type="text" id="fHo" placeholder="101" inputmode="numeric" oninput="App.tryAutoFill()"></div>
        </div>

        <!-- ìœ„ì¹˜ / ê³µì¢… (ìë™ì…ë ¥) -->
        <div class="form-row c2">
          <div class="field auto">
            <label>ìœ„ì¹˜</label>
            <div class="select-wrap">
              <select id="fLoc" onchange="App.onLocChange()">
                <option value="">ì„ íƒ</option>
                <option value="ê±°ì‹¤">ê±°ì‹¤</option>
                <option value="ë°œì½”ë‹ˆ1">ë°œì½”ë‹ˆ1</option>
                <option value="ì•ˆë°©">ì•ˆë°©</option>
                <option value="ì¹¨ì‹¤1">ì¹¨ì‹¤1</option>
                <option value="ì¹¨ì‹¤2">ì¹¨ì‹¤2</option>
                <option value="ì¹¨ì‹¤3">ì¹¨ì‹¤3</option>
                <option value="ì•ŒíŒŒë£¸">ì•ŒíŒŒë£¸</option>
                <option value="ë‹¤ìš©ë„">ë‹¤ìš©ë„</option>
                <option value="ë°œì½”ë‹ˆ2">ë°œì½”ë‹ˆ2</option>
              </select>
            </div>
          </div>
          <div class="field auto"><label>ê³µì¢…</label><input type="text" id="fWork" placeholder="ìë™ì…ë ¥ë¨"></div>
        </div>

        <!-- ìë™ ë§¤ì¹­ ì•ˆë‚´ -->
        <div class="match-info" id="matchInfo"></div>

        <!-- ìœ í˜• / ì‹œê³µì—…ì²´ (ìë™ì…ë ¥) -->
        <div class="form-row c2">
          <div class="field auto"><label>ìœ í˜•</label><input type="text" id="fType" placeholder="ìë™ì…ë ¥ë¨"></div>
          <div class="field auto"><label>ì‹œê³µì—…ì²´</label><input type="text" id="fComp" placeholder="ìë™ì…ë ¥ë¨"></div>
        </div>

        <!-- í•˜ìë‚´ìš© (ìë™ì…ë ¥) -->
        <div class="field auto">
          <label>í•˜ìë‚´ìš©</label>
          <textarea id="fMemo" placeholder="í•˜ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ìë™ì…ë ¥ë¨"></textarea>
        </div>

        <!-- ì‚¬ì§„ 3ì¥ -->
        <div class="photo-section">
          <div class="photo-section-label">ğŸ“¸ ì‚¬ì§„ ì…ë ¥ (í„°ì¹˜í•˜ì—¬ ì´¬ì˜/ê°¤ëŸ¬ë¦¬)</div>
          <div class="photo-row">
            <div class="photo-slot" onclick="App.takePhoto('before')">
              <span class="ps-icon">ğŸ“·</span><span class="ps-label">ìˆ˜ë¦¬ ì „</span>
              <img id="imgBefore"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('before')">âœ•</button>
            </div>
            <div class="photo-slot" onclick="App.takePhoto('after')">
              <span class="ps-icon">ğŸ“·</span><span class="ps-label">ìˆ˜ë¦¬ í›„</span>
              <img id="imgAfter"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('after')">âœ•</button>
            </div>
            <div class="photo-slot" onclick="App.takePhoto('confirm')">
              <span class="ps-icon">ğŸ“‹</span><span class="ps-label">ì™„ë£Œí™•ì¸ì„œ</span>
              <img id="imgConfirm"><button class="photo-del" onclick="event.stopPropagation();App.delPhoto('confirm')">âœ•</button>
            </div>
          </div>
        </div>

        <!-- ì™„ë£Œì¼ + ì €ì¥ -->
        <div class="form-row c2">
          <div class="field"><label>ì™„ë£Œì¼</label><input type="date" id="fDate"></div>
          <div style="display:flex;align-items:end"><button class="btn-save-entry" onclick="App.save()">ğŸ’¾ ì €ì¥</button></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• â‘¢ ì €ì¥ ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ â•â•â• -->
    <div class="sec" id="secLog">
      <div class="log-head">
        <h3><span class="sec-num" style="background:var(--green)">3</span> ì €ì¥ ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ <span class="log-count" id="logCount">(0ê±´)</span></h3>
        <button class="btn-log-clear" onclick="App.clearLog()">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
      </div>
      <div class="table-wrap">
        <table class="log-table">
          <thead><tr>
            <th>No</th><th>í˜„ì¥ëª…</th><th>ë™</th><th>í˜¸</th><th>ìœ„ì¹˜</th><th>ê³µì¢…</th>
            <th>ìœ í˜•</th><th>ì‹œê³µì—…ì²´</th><th>í•˜ìë‚´ìš©</th>
            <th>ìˆ˜ë¦¬ì „</th><th>ìˆ˜ë¦¬í›„</th><th>í™•ì¸ì„œ</th><th>ì™„ë£Œì¼</th><th>ì‚­ì œ</th>
          </tr></thead>
          <tbody id="logBody"><tr><td colspan="14" class="log-empty">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

  </main>

  <footer>
    <button class="btn-send" onclick="App.exportExcel()">ğŸ“¤ íŒŒì¼ì „ì†¡</button>
    <button class="btn-new" onclick="App.newEntry()">ğŸ”„ ìƒˆë¡œì…ë ¥</button>
  </footer>
</div>

<div class="hidden-inputs">
  <input type="file" id="fCapture" accept="image/*" capture="environment" onchange="App.onPhoto(this)">
</div>

<script>
var STORAGE = { LOG:'METRO_V62_LOG', SOURCE:'METRO_V62_SRC' };
var VALID_LOCATIONS = ['ê±°ì‹¤','ë°œì½”ë‹ˆ1','ì•ˆë°©','ì¹¨ì‹¤1','ì¹¨ì‹¤2','ì¹¨ì‹¤3','ì•ŒíŒŒë£¸','ë‹¤ìš©ë„','ë°œì½”ë‹ˆ2'];

var App = {
  sourceData: [],   // ë¶ˆëŸ¬ì˜¨ í•˜ì ë¦¬ìŠ¤íŠ¸ ì›ë³¸
  colMap: {},       // ì»¬ëŸ¼ ë§¤í•‘
  savedLog: [],     // ì €ì¥ ì™„ë£Œ ë¦¬ìŠ¤íŠ¸
  photos: {before:'',after:'',confirm:''},
  pendingType: '',
  matchedIdx: -1,   // í˜„ì¬ ë§¤ì¹­ëœ ì›ë³¸ í–‰ ì¸ë±ìŠ¤
  currentMatches: [], // ë™/í˜¸ ë§¤ì¹­ ê²°ê³¼ (ìœ„ì¹˜ë³„ êµ¬ë¶„ìš©)
  siteLocked: false,

  init: function() {
    this.loadSource();
    this.loadLog();
    this.renderLog();
    document.getElementById('fDate').valueAsDate = new Date();
    // í˜„ì¥ëª… ë³µì›
    var savedSite = localStorage.getItem('METRO_SITE') || '';
    if (savedSite) {
      document.getElementById('fSite').value = savedSite;
      this.lockSite();
    }
  },

  // â•â•â• í˜„ì¥ëª… ê³ ì •/í•´ì œ â•â•â•
  lockSite: function() {
    var v = document.getElementById('fSite').value.trim();
    if (!v) return;
    this.siteLocked = true;
    document.getElementById('fSite').readOnly = true;
    document.getElementById('fSite').style.background = '#e8f5e9';
    document.getElementById('fSite').style.borderColor = '#4caf50';
    document.getElementById('siteLockLabel').style.display = 'inline';
    localStorage.setItem('METRO_SITE', v);
  },

  unlockSite: function() {
    this.siteLocked = false;
    document.getElementById('fSite').readOnly = false;
    document.getElementById('fSite').style.background = '';
    document.getElementById('fSite').style.borderColor = '';
    document.getElementById('siteLockLabel').style.display = 'none';
    document.getElementById('fSite').focus();
    this.toast('í˜„ì¥ëª… ìˆ˜ì • ê°€ëŠ¥', 'info');
  },

  toast: function(msg,type,ms) {
    type=type||'info';ms=ms||2500;
    var el=document.getElementById('toast');
    el.textContent=msg;el.className='toast '+type+' show';
    clearTimeout(el._t);el._t=setTimeout(function(){el.classList.remove('show');},ms);
  },

  // â•â•â• íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° â•â•â•
  loadFile: function(input) {
    var file = input.files && input.files[0];
    if (!file) return;
    var self = this;
    document.getElementById('loaderText').textContent = 'íŒŒì¼ ì½ëŠ” ì¤‘...';
    document.getElementById('loader').style.display = 'flex';

    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = new Uint8Array(e.target.result);
        var wb = XLSX.read(data, {type:'array'});
        var ws = wb.Sheets[wb.SheetNames[0]];
        var json = XLSX.utils.sheet_to_json(ws, {defval:''});
        if (!json.length) throw new Error('ë¹ˆ íŒŒì¼');

        self.sourceData = [];
        for (var i=0; i<json.length; i++) { json[i]._idx=i; self.sourceData.push(json[i]); }
        self.detectCols(json[0]);
        self.saveSource();

        document.getElementById('uploadArea').classList.add('loaded');
        document.getElementById('loadedFileName').textContent = file.name;
        document.getElementById('loadedRowCount').textContent = json.length;
        self.toast('âœ… '+json.length+'ê±´ ë¡œë“œ! ë™/í˜¸/ìœ„ì¹˜ ì…ë ¥ ì‹œ ìë™ë§¤ì¹­ë©ë‹ˆë‹¤','success',4000);
      } catch(err) { self.toast('âŒ íŒŒì¼ ì˜¤ë¥˜: '+err.message,'error',4000); }
      document.getElementById('loader').style.display = 'none';
    };
    reader.readAsArrayBuffer(file);
  },

  detectCols: function(row) {
    var keys = Object.keys(row);
    var used = {}; // ì´ë¯¸ ë§¤í•‘ëœ ì»¬ëŸ¼ì€ ì¤‘ë³µ ì‚¬ìš© ë°©ì§€

    function find() {
      var kws = Array.prototype.slice.call(arguments);
      // 1ì°¨: ì •í™•íˆ ì¼ì¹˜
      for (var i = 0; i < keys.length; i++) {
        if (used[keys[i]]) continue;
        var k = keys[i].replace(/\s/g, '');
        for (var j = 0; j < kws.length; j++) {
          if (k === kws[j]) { used[keys[i]] = true; return keys[i]; }
        }
      }
      // 2ì°¨: í¬í•¨ ì¼ì¹˜
      for (var i2 = 0; i2 < keys.length; i2++) {
        if (used[keys[i2]]) continue;
        var k2 = keys[i2].replace(/\s/g, '');
        for (var j2 = 0; j2 < kws.length; j2++) {
          if (k2.indexOf(kws[j2]) >= 0) { used[keys[i2]] = true; return keys[i2]; }
        }
      }
      return '';
    }

    // ë§¤í•‘ ìˆœì„œ ì¤‘ìš”! ë™/í˜¸ë¥¼ ë¨¼ì € ì°¾ê³ , ê·¸ ë‹¤ìŒ ë™í˜¸(í•©ì³ì§„ ê²ƒ)
    this.colMap = {
      dong: find('ë™','dong','Dong'),
      ho: find('í˜¸','í˜¸ìˆ˜','ho','Ho'),
      unit: find('ë™í˜¸','ë™/í˜¸','ì„¸ëŒ€','unit'),
      site: find('í˜„ì¥ëª…','í˜„ì¥','site'),
      no: find('í•˜ìNo','í•˜ìë²ˆí˜¸','No','NO','ë²ˆí˜¸'),
      loc: find('ìœ„ì¹˜','ì‹¤ëª…','location'),
      work: find('ê³µì¢…','ê³µì‚¬','work'),
      type: find('ìœ í˜•','í•˜ììœ í˜•','type','Type'),
      step: find('ì ‘ìˆ˜ë‹¨ê³„','ë‹¨ê³„','step'),
      comp: find('ì—…ì²´ëª…','ì—…ì²´','ì‹œê³µì—…ì²´','ì‹œê³µ','company'),
      name: find('í™•ì¸ì','ë‹´ë‹¹ì','name'),
      memo: find('í•˜ìë‚´ìš©','ë‚´ìš©','ë¹„ê³ ','ìƒì„¸','memo'),
      date: find('ì ‘ìˆ˜ì¼','ë‚ ì§œ','ì™„ë£Œì¼','date')
    };

    console.log('ğŸ“‹ ì»¬ëŸ¼ í‚¤:', keys);
    console.log('ğŸ“‹ ì»¬ëŸ¼ ë§¤í•‘:', JSON.stringify(this.colMap));
  },

  gv: function(row,f) { var c=this.colMap[f]; return c ? String(row[c]||'').trim() : ''; },

  parseDH: function(row) {
    var d=this.gv(row,'dong'),h=this.gv(row,'ho');
    if(!d&&!h){var u=this.gv(row,'unit');var m=u.match(/(\d+)\s*ë™?\s*[-\/]?\s*(\d+)\s*í˜¸?/);if(m){d=m[1];h=m[2];}}
    return {dong:d.replace(/[^0-9]/g,''), ho:h.replace(/[^0-9]/g,'')};
  },

  // â•â•â• ë™/í˜¸ ì…ë ¥ ì‹œ ìë™ ë§¤ì¹­ â†’ ìœ„ì¹˜, ê³µì¢…, ìœ í˜•, ì‹œê³µì—…ì²´, í•˜ìë‚´ìš© ì±„ì›€ â•â•â•
  tryAutoFill: function() {
    var qD = document.getElementById('fDong').value.trim();
    var qH = document.getElementById('fHo').value.trim();
    var info = document.getElementById('matchInfo');

    if (!this.sourceData.length) {
      info.className = 'match-info'; info.style.display = 'none'; return;
    }
    if (!qD) {
      info.className = 'match-info'; info.style.display = 'none'; this.matchedIdx = -1; return;
    }

    // ë™+í˜¸ë¡œ ë§¤ì¹­ (ìœ„ì¹˜ëŠ” ìë™ì…ë ¥ ëŒ€ìƒì´ë¯€ë¡œ í•„í„°ì—ì„œ ì œì™¸)
    var matches = [];
    for (var i = 0; i < this.sourceData.length; i++) {
      var row = this.sourceData[i];
      var dh = this.parseDH(row);
      var dongMatch = dh.dong === qD;
      if (!dongMatch) continue;
      if (qH) { if (dh.ho !== qH) continue; }
      matches.push(row);
    }

    console.log('ğŸ” ê²€ìƒ‰:', {ë™:qD, í˜¸:qH}, 'â†’', matches.length + 'ê±´');

    if (matches.length > 0) {
      var match = matches[0];
      this.matchedIdx = match._idx;
      this.currentMatches = matches; // ì—¬ëŸ¬ ê±´ì¼ ë•Œ ì°¸ì¡°ìš©

      // â˜… ìœ„ì¹˜ ìë™ ì„ íƒ (select optionì— ìˆëŠ” ê°’ì´ë©´)
      var locVal = this.gv(match, 'loc') || '';
      var locSelect = document.getElementById('fLoc');
      var locFound = false;
      for (var o = 0; o < locSelect.options.length; o++) {
        if (locSelect.options[o].value === locVal) { locSelect.value = locVal; locFound = true; break; }
      }
      if (!locFound) locSelect.value = '';

      // â˜… ê³µì¢… ìë™ì…ë ¥
      document.getElementById('fWork').value = this.gv(match, 'work') || '';

      // ìœ í˜•, ì‹œê³µì—…ì²´, í•˜ìë‚´ìš© ìë™ì…ë ¥
      document.getElementById('fType').value = this.gv(match, 'type') || this.gv(match, 'step') || '';
      document.getElementById('fComp').value = this.gv(match, 'comp') || '';
      document.getElementById('fMemo').value = this.gv(match, 'memo') || '';

      // í˜„ì¥ëª… ë¹„ì–´ìˆìœ¼ë©´ ì±„ìš°ê¸°
      if (!document.getElementById('fSite').value.trim()) {
        var siteVal = this.gv(match, 'site') || '';
        if (siteVal) { document.getElementById('fSite').value = siteVal; this.lockSite(); }
      }

      var detail = (this.gv(match,'dong')||'?') + 'ë™ ' + (this.gv(match,'ho')||'?') + 'í˜¸ ' + locVal;
      info.textContent = 'âœ… ë§¤ì¹­! (' + matches.length + 'ê±´) ' + detail + ' â†’ ìœ„ì¹˜Â·ê³µì¢…Â·ìœ í˜•Â·ì—…ì²´Â·ë‚´ìš© ìë™ì…ë ¥';
      info.className = 'match-info found';

      // ë§¤ì¹­ ê±´ì´ ì—¬ëŸ¬ ê°œë©´ ì•Œë¦¼
      if (matches.length > 1) {
        info.textContent += ' (ë™ì¼ ë™í˜¸ ' + matches.length + 'ê±´ â€” ìœ„ì¹˜ ì„ íƒìœ¼ë¡œ êµ¬ë¶„)';
      }
    } else {
      this.matchedIdx = -1;
      this.currentMatches = [];
      document.getElementById('fLoc').value = '';
      document.getElementById('fWork').value = '';
      document.getElementById('fType').value = '';
      document.getElementById('fComp').value = '';
      document.getElementById('fMemo').value = '';

      var hint = '';
      if (this.sourceData.length > 0) {
        var samples = [];
        for (var s = 0; s < Math.min(3, this.sourceData.length); s++) {
          var sdh = this.parseDH(this.sourceData[s]);
          samples.push(sdh.dong + 'ë™' + sdh.ho + 'í˜¸');
        }
        hint = ' (ì˜ˆ: ' + samples.join(', ') + ')';
      }
      info.textContent = 'âŒ ë§¤ì¹­ ì—†ìŒ (ë™:' + qD + (qH ? ' í˜¸:' + qH : '') + ')' + hint;
      info.className = 'match-info notfound';
    }
  },

  // ìœ„ì¹˜ ì„ íƒ ë³€ê²½ ì‹œ â†’ ë™ì¼ ë™í˜¸ ë‚´ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ í•­ëª©ìœ¼ë¡œ ì¬ë§¤ì¹­
  onLocChange: function() {
    var qL = document.getElementById('fLoc').value;
    if (!this.currentMatches || !this.currentMatches.length || !qL) return;

    for (var i = 0; i < this.currentMatches.length; i++) {
      var row = this.currentMatches[i];
      if (this.gv(row, 'loc') === qL) {
        this.matchedIdx = row._idx;
        document.getElementById('fWork').value = this.gv(row, 'work') || '';
        document.getElementById('fType').value = this.gv(row, 'type') || this.gv(row, 'step') || '';
        document.getElementById('fComp').value = this.gv(row, 'comp') || '';
        document.getElementById('fMemo').value = this.gv(row, 'memo') || '';

        var info = document.getElementById('matchInfo');
        info.textContent = 'âœ… ìœ„ì¹˜ ë§¤ì¹­! ' + this.gv(row,'dong') + 'ë™ ' + this.gv(row,'ho') + 'í˜¸ ' + qL + ' â†’ ìë™ì…ë ¥ ê°±ì‹ ';
        info.className = 'match-info found';
        return;
      }
    }
  },

  // â•â•â• ì‚¬ì§„ â•â•â•
  takePhoto: function(type) {
    this.pendingType = type;
    var fc = document.getElementById('fCapture');
    fc.value = ''; fc.click();
  },

  onPhoto: function(input) {
    var file = input.files && input.files[0];
    if (!file || !this.pendingType) return;
    var type = this.pendingType;
    var self = this;
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var maxW=1200; var scale=img.width>maxW?maxW/img.width:1;
        var cvs=document.createElement('canvas'); cvs.width=img.width*scale; cvs.height=img.height*scale;
        cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
        var b64=cvs.toDataURL('image/jpeg',0.8);
        self.photos[type]=b64;
        self.updateSlot(type,b64);
        self.toast('âœ… ì‚¬ì§„ ì €ì¥','success',1500);
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  },

  delPhoto: function(type) { this.photos[type]=''; this.updateSlot(type,''); },

  updateSlot: function(type,src) {
    var id = type==='before'?'imgBefore':type==='after'?'imgAfter':'imgConfirm';
    var el=document.getElementById(id); var slot=el.closest('.photo-slot');
    if(src){el.src=src;el.style.display='block';slot.classList.add('filled');}
    else{el.src='';el.style.display='none';slot.classList.remove('filled');}
  },

  // â•â•â• í¼ ì´ˆê¸°í™” â•â•â•
  clearForm: function() {
    // í˜„ì¥ëª…ì€ ê³ ì • ìƒíƒœë©´ ìœ ì§€
    var ids = this.siteLocked ? ['fDong','fHo','fWork','fType','fComp','fMemo'] : ['fSite','fDong','fHo','fWork','fType','fComp','fMemo'];
    for(var i=0;i<ids.length;i++) document.getElementById(ids[i]).value='';
    document.getElementById('fLoc').value='';
    document.getElementById('fDate').valueAsDate=new Date();
    this.photos={before:'',after:'',confirm:''};
    var t=['before','after','confirm'];
    for(var j=0;j<t.length;j++) this.updateSlot(t[j],'');
    document.getElementById('matchInfo').className='match-info';
    document.getElementById('matchInfo').style.display='none';
    this.matchedIdx=-1;
    this.currentMatches=[];
    this.toast(this.siteLocked ? 'ì…ë ¥ì¹¸ ì´ˆê¸°í™” (í˜„ì¥ëª… ìœ ì§€)' : 'ì „ì²´ ì´ˆê¸°í™”','info');
  },

  // â•â•â• ì €ì¥ â•â•â•
  save: function() {
    var site=document.getElementById('fSite').value.trim();
    var dong=document.getElementById('fDong').value.trim();
    var ho=document.getElementById('fHo').value.trim();
    if(!site){this.toast('í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
    if(!dong){this.toast('ë™ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
    if(!ho){this.toast('í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}

    var entry = {
      no: this.savedLog.length+1,
      site: site,
      dong: dong,
      ho: ho,
      loc: document.getElementById('fLoc').value,
      work: document.getElementById('fWork').value.trim(),
      type: document.getElementById('fType').value.trim(),
      comp: document.getElementById('fComp').value.trim(),
      memo: document.getElementById('fMemo').value.trim(),
      before: this.photos.before||'',
      after: this.photos.after||'',
      confirm: this.photos.confirm||'',
      date: document.getElementById('fDate').value,
      savedAt: new Date().toLocaleString('ko-KR'),
      sourceIdx: this.matchedIdx // ì›ë³¸ ì¸ë±ìŠ¤ ì°¸ì¡°
    };

    this.savedLog.push(entry);
    this.saveLog();
    this.renderLog();
    this.toast('âœ… ì €ì¥ ì™„ë£Œ! (#'+entry.no+')','success');

    setTimeout(function(){document.getElementById('secLog').scrollIntoView({behavior:'smooth',block:'start'});},400);
  },

  // â•â•â• ìƒˆë¡œì…ë ¥ â•â•â•
  newEntry: function() {
    var keepSite=document.getElementById('fSite').value;
    var ids=['fDong','fHo','fWork','fType','fComp','fMemo'];
    for(var i=0;i<ids.length;i++) document.getElementById(ids[i]).value='';
    document.getElementById('fLoc').value='';
    document.getElementById('fDate').valueAsDate=new Date();
    this.photos={before:'',after:'',confirm:''};
    var t=['before','after','confirm'];
    for(var j=0;j<t.length;j++) this.updateSlot(t[j],'');
    document.getElementById('matchInfo').className='match-info';
    document.getElementById('matchInfo').style.display='none';
    this.matchedIdx=-1;
    this.currentMatches=[];
    document.querySelector('.content').scrollTo({top:0,behavior:'smooth'});
    document.getElementById('fDong').focus();
    this.toast('ìƒˆ ì‘ì—… ì…ë ¥ (í˜„ì¥ëª… ìœ ì§€)','info');
  },

  // â•â•â• ë¡œê·¸ ë Œë”ë§ â•â•â•
  renderLog: function() {
    var c=this.savedLog.length;
    document.getElementById('logCount').textContent='('+c+'ê±´)';
    if(!c){document.getElementById('logBody').innerHTML='<tr><td colspan="14" class="log-empty">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}

    var html='';
    for(var i=0;i<c;i++){
      var it=this.savedLog[i];
      html+='<tr>'
        +'<td class="order-num">'+it.no+'</td>'
        +'<td>'+(it.site||'-')+'</td>'
        +'<td>'+(it.dong||'-')+'</td>'
        +'<td>'+(it.ho||'-')+'</td>'
        +'<td>'+(it.loc||'-')+'</td>'
        +'<td>'+(it.work||'-')+'</td>'
        +'<td>'+(it.type||'-')+'</td>'
        +'<td>'+(it.comp||'-')+'</td>'
        +'<td style="text-align:left;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(it.memo||'-')+'</td>'
        +'<td>'+(it.before?'<img src="'+it.before+'" class="thumb">':'-')+'</td>'
        +'<td>'+(it.after?'<img src="'+it.after+'" class="thumb">':'-')+'</td>'
        +'<td>'+(it.confirm?'<img src="'+it.confirm+'" class="thumb">':'-')+'</td>'
        +'<td style="font-size:.5rem;">'+(it.date||'-')+'</td>'
        +'<td><button class="btn-del-log" onclick="App.deleteItem('+i+')">ì‚­ì œ</button></td>'
        +'</tr>';
    }
    document.getElementById('logBody').innerHTML=html;
  },

  deleteItem: function(idx) {
    if(!confirm('#'+this.savedLog[idx].no+' ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
    this.savedLog.splice(idx,1);
    for(var i=0;i<this.savedLog.length;i++) this.savedLog[i].no=i+1;
    this.saveLog();this.renderLog();this.toast('ì‚­ì œ ì™„ë£Œ','info');
  },

  clearLog: function() {
    if(!this.savedLog.length){this.toast('ì‚­ì œí•  í•­ëª© ì—†ìŒ','error');return;}
    if(!confirm('ì „ì²´ '+this.savedLog.length+'ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
    this.savedLog=[];this.saveLog();this.renderLog();this.toast('ì „ì²´ ì‚­ì œ ì™„ë£Œ','info');
  },

  // â•â•â• ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (ì‚¬ì§„ ì…€ ì‚½ì…) â•â•â•
  exportExcel: function() {
    if(!this.savedLog.length){this.toast('ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤','error');return;}
    var self=this;
    document.getElementById('loaderText').textContent='ì—‘ì…€ ìƒì„± ì¤‘... (ì‚¬ì§„ ì‚½ì…)';
    document.getElementById('loader').style.display='flex';

    setTimeout(function(){
      try{
        var wb=new ExcelJS.Workbook();
        wb.creator='(ì£¼)ë©”íŠ¸ë¡œ R & S AI'; wb.created=new Date();
        var ws=wb.addWorksheet('ì‘ì—…ì™„ë£Œ ë¦¬ìŠ¤íŠ¸',{views:[{state:'frozen',ySplit:1}]});

        var headers=['No','í˜„ì¥ëª…','ë™','í˜¸','ìœ„ì¹˜','ê³µì¢…','ìœ í˜•','ì‹œê³µì—…ì²´','í•˜ìë‚´ìš©','ìˆ˜ë¦¬ì „','ìˆ˜ë¦¬í›„','ì™„ë£Œí™•ì¸ì„œ','ì™„ë£Œì¼'];
        ws.addRow(headers);

        var hr=ws.getRow(1); hr.height=28;
        hr.eachCell(function(cell){
          cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0C1929'}};
          cell.font={color:{argb:'FFC8A45E'},bold:true,size:10};
          cell.alignment={horizontal:'center',vertical:'middle',wrapText:true};
          cell.border={top:{style:'thin',color:{argb:'FF2A2A2A'}},bottom:{style:'thin',color:{argb:'FF2A2A2A'}},left:{style:'thin',color:{argb:'FF2A2A2A'}},right:{style:'thin',color:{argb:'FF2A2A2A'}}};
        });

        ws.columns=[{width:5},{width:14},{width:6},{width:6},{width:9},{width:12},{width:10},{width:12},{width:25},{width:18},{width:18},{width:18},{width:12}];

        for(var i=0;i<self.savedLog.length;i++){
          var it=self.savedLog[i]; var rn=i+2;
          ws.addRow([it.no,it.site||'',it.dong||'',it.ho||'',it.loc||'',it.work||'',it.type||'',it.comp||'',it.memo||'','','','',it.date||'']);
          ws.getRow(rn).height=120;

          var dr=ws.getRow(rn);
          dr.eachCell(function(cell){
            cell.alignment={horizontal:'center',vertical:'middle',wrapText:true};cell.font={size:9};
            cell.border={top:{style:'thin',color:{argb:'FFDDDDDD'}},bottom:{style:'thin',color:{argb:'FFDDDDDD'}},left:{style:'thin',color:{argb:'FFDDDDDD'}},right:{style:'thin',color:{argb:'FFDDDDDD'}}};
          });
          if(i%2===1) dr.eachCell(function(cell){cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF8F5ED'}};});
          dr.getCell(9).alignment={horizontal:'left',vertical:'middle',wrapText:true};

          var pm=[{key:'before',col:9},{key:'after',col:10},{key:'confirm',col:11}];
          for(var p=0;p<pm.length;p++){
            var pd=it[pm[p].key];
            if(pd&&pd.indexOf('data:image')===0){
              try{
                var b64=pd.split(',')[1];var ext=pd.indexOf('png')>=0?'png':'jpeg';
                var imgId=wb.addImage({base64:b64,extension:ext});
                ws.addImage(imgId,{tl:{col:pm[p].col,row:rn-1},br:{col:pm[p].col+1,row:rn},editAs:'oneCell'});
              }catch(ie){dr.getCell(pm[p].col+1).value='(ì‹¤íŒ¨)';}
            }else{dr.getCell(pm[p].col+1).value='-';dr.getCell(pm[p].col+1).font={size:9,color:{argb:'FF999999'}};}
          }
        }

        wb.xlsx.writeBuffer().then(function(buf){
          var blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
          var fn='ë©”íŠ¸ë¡œ_ì‘ì—…ì™„ë£Œ_'+new Date().toISOString().slice(0,10)+'.xlsx';
          if(typeof saveAs!=='undefined')saveAs(blob,fn);
          else{var u=URL.createObjectURL(blob);var a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
          document.getElementById('loader').style.display='none';
          self.toast('âœ… ì‚¬ì§„ í¬í•¨ ì—‘ì…€ ì „ì†¡ ì™„ë£Œ! ('+self.savedLog.length+'ê±´)','success',4000);
        }).catch(function(err){document.getElementById('loader').style.display='none';self.toast('âŒ '+err.message,'error',4000);});
      }catch(e){document.getElementById('loader').style.display='none';self.toast('âŒ '+e.message,'error',4000);}
    },100);
  },

  // â•â•â• Storage â•â•â•
  saveLog: function(){
    try{localStorage.setItem(STORAGE.LOG,JSON.stringify(this.savedLog));}
    catch(e){
      try{
        var slim=[];
        for(var i=0;i<this.savedLog.length;i++){
          var c={};var keys=Object.keys(this.savedLog[i]);
          for(var j=0;j<keys.length;j++){var k=keys[j];c[k]=(k==='before'||k==='after'||k==='confirm')?(this.savedLog[i][k]?'(ì‚¬ì§„)':''):this.savedLog[i][k];}
          slim.push(c);
        }
        localStorage.setItem(STORAGE.LOG,JSON.stringify(slim));
        this.toast('âš ï¸ ìš©ëŸ‰ ì´ˆê³¼ â†’ ì‚¬ì§„ ë°ì´í„° ì¶•ì†Œ ì €ì¥','error',4000);
      }catch(e2){this.toast('âŒ ì €ì¥ ì‹¤íŒ¨','error',4000);}
    }
  },
  loadLog: function(){try{this.savedLog=JSON.parse(localStorage.getItem(STORAGE.LOG)||'[]');}catch(e){this.savedLog=[];}},

  saveSource: function(){
    try{
      var slim=[];
      for(var i=0;i<this.sourceData.length;i++){var c={};var keys=Object.keys(this.sourceData[i]);for(var j=0;j<keys.length;j++)c[keys[j]]=this.sourceData[i][keys[j]];slim.push(c);}
      localStorage.setItem(STORAGE.SOURCE,JSON.stringify({data:slim}));
    }catch(e){}
  },
  loadSource: function(){
    try{
      var s=JSON.parse(localStorage.getItem(STORAGE.SOURCE)||'null');
      if(s&&s.data&&s.data.length){
        this.sourceData=[];
        for(var i=0;i<s.data.length;i++){s.data[i]._idx=i;this.sourceData.push(s.data[i]);}
        // í•­ìƒ ì»¬ëŸ¼ ì¬ê°ì§€ (ì´ì „ ë§¤í•‘ ì‹ ë¢°í•˜ì§€ ì•ŠìŒ)
        this.detectCols(s.data[0]);
        document.getElementById('uploadArea').classList.add('loaded');
        document.getElementById('loadedFileName').textContent='ì´ì „ ë°ì´í„°';
        document.getElementById('loadedRowCount').textContent=this.sourceData.length;
      }
    }catch(e){ console.warn('ì†ŒìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', e); }
  },

  // â•â•â• ìƒ˜í”Œ â•â•â•
  loadSample: function(){
    var sample=[];
    var works=['PLì°½í˜¸ê³µì‚¬','ë„ë°°ê³µì‚¬','íƒ€ì¼ê³µì‚¬','ë°”ë‹¥ê³µì‚¬','ì„¤ë¹„ê³µì‚¬'];
    var types=['ê· ì—´','ëˆ„ìˆ˜','ë“¤ëœ¸','íŒŒì†','ë³€ìƒ‰','ê²°ë¡œ'];
    var comps=['ì§„í¥ê±´ì—…(ì£¼)','ëŒ€ë¦¼ì‚°ì—…','í˜„ëŒ€ê±´ì„¤','ì‚¼ì„±ë¬¼ì‚°'];
    var memos=['ì°½ë¬¸ í‹ˆìƒˆ ë³´ìˆ˜','ë²½ì§€ ë“¤ëœ¸ ìˆ˜ë¦¬','íƒ€ì¼ ê¹¨ì§ êµì²´','ë°”ë‹¥ ê¸í˜ ë³´ìˆ˜','ë°°ìˆ˜ ë¶ˆëŸ‰ ìˆ˜ë¦¬','ë„ë°° ê³°íŒ¡ì´','ë¬¸ì§ ê²½ì²© êµì²´','ì‹¤ë¦¬ì½˜ ì¬ì‹œê³µ'];

    for(var d=101;d<=103;d++){
      for(var h=101;h<=106;h++){
        var cnt=1+Math.floor(Math.random()*2);
        for(var c=0;c<cnt;c++){
          sample.push({
            'í˜„ì¥ëª…':'ì›ì£¼í˜ì‹ C4BL','í•˜ìNo':'H'+String(sample.length+1).padStart(4,'0'),
            'ë™':String(d),'í˜¸':String(h),
            'ìœ„ì¹˜':VALID_LOCATIONS[Math.floor(Math.random()*VALID_LOCATIONS.length)],
            'ê³µì¢…':works[Math.floor(Math.random()*works.length)],
            'ìœ í˜•':types[Math.floor(Math.random()*types.length)],
            'ì‹œê³µì—…ì²´':comps[Math.floor(Math.random()*comps.length)],
            'í•˜ìë‚´ìš©':memos[Math.floor(Math.random()*memos.length)],
            'ì ‘ìˆ˜ì¼':'2025-02-09'
          });
        }
      }
    }
    this.sourceData=[];for(var i=0;i<sample.length;i++){sample[i]._idx=i;this.sourceData.push(sample[i]);}
    this.detectCols(sample[0]);this.saveSource();
    document.getElementById('uploadArea').classList.add('loaded');
    document.getElementById('loadedFileName').textContent='ìƒ˜í”Œ';
    document.getElementById('loadedRowCount').textContent=sample.length;
    this.toast('âœ… ìƒ˜í”Œ '+sample.length+'ê±´ ë¡œë“œ! ë™/í˜¸ ì…ë ¥ ì‹œ ìë™ë§¤ì¹­','success',4000);
  }
};

window.onload=function(){App.init();};
</script>
</body>
</html>
