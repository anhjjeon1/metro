<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>(ì£¼)ë©”íŠ¸ë¡œ R & S AI - ì‘ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    /* [ë¬´ê²°ì„± ìœ ì§€] ê¸°ì¡´ 1,384ë¼ì¸ì˜ ëª¨ë“  ë””ìì¸ ì‹œìŠ¤í…œ ë³µì› */
    :root {
      --primary: #007aff; --success: #34c759; --danger: #ff3b30; --warning: #ff9500;
      --dark: #1c1c1e; --light: #f2f2f7; --border: #c6c6c8;
      --gradient-blue: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    body, html { background: var(--light); font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif; height: 100vh; overflow: hidden; }
    .app-container { max-width: 500px; margin: 0 auto; background: #fff; height: 100%; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    header { background: var(--gradient-blue); color: #fff; text-align: center; padding: 15px 0; border-bottom: 3px solid var(--primary); }
    header h1 { font-size: 1.2rem; font-weight: 900; }
    .content { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
    .config-section { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--primary); }
    .drop-zone { width: 100%; aspect-ratio: 4/3; border: 2.5px dashed var(--border); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; margin-bottom: 12px; background: #fff; }
    .preview-img { width: 100%; height: 100%; object-fit: contain; position: absolute; background: #000; display: none; z-index: 10; }
    .data-table { width: 100%; border-collapse: collapse; border: 2px solid #222; margin-bottom: 12px; }
    .data-table td { border: 1px solid #333; padding: 6px; position: relative; height: 48px; vertical-align: middle; }
    .data-table label { position: absolute; top: 3px; left: 6px; font-size: 0.6rem; font-weight: 900; color: var(--primary); }
    .data-table input { width: 100%; border: none; font-size: 0.85rem; font-weight: 700; outline: none; padding-top: 12px; }
    .memo-td { height: 100px !important; vertical-align: top !important; padding-top: 22px !important; }
    #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
    .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: rot 0.8s linear infinite; }
    @keyframes rot { 100% { transform: rotate(360deg); } }
    footer { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #eee; background: #fff; }
    footer button { flex: 1; height: 55px; border-radius: 12px; border: none; color: #fff; font-weight: 900; font-size: 0.95rem; cursor: pointer; }
    .btn-save { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-refresh { background: #3498db; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:900;">AI ë¬´ê²°ì„± ë¶„ì„ ë° ì „ì†¡ ì¤‘...</p></div>

<div class="app-container">
  <header>
    <h1>(ì£¼)ë©”íŠ¸ë¡œ R & S AI</h1>
    <span style="font-size:0.65rem; color:#64ffda; font-weight:700;">VER 3.5 FINAL - ULTRA SYNC</span>
  </header>

  <main class="content">
    <div class="drop-zone" onclick="document.getElementById('f-ai').click()">
      <p style="font-weight:900; color:#666;">ğŸ“¸ 1. ì™„ë£Œí™•ì¸ì„œ ì •ë°€ ë¶„ì„ ê°€ë™</p>
      <img id="view-ai" class="preview-img">
    </div>
    <input type="file" id="f-ai" accept="image/*" capture="camera" style="display:none" onchange="CORE.analyze(this)">

    <table class="data-table">
      <tr>
        <td colspan="4"><label>í˜„ì¥ëª…</label><input type="text" id="site"></td>
        <td colspan="2"><label>í•˜ìNo</label><input type="text" id="haja"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ë™ / í˜¸ìˆ˜</label><input type="text" id="unit"></td>
        <td colspan="3"><label>ì ‘ìˆ˜ì¼</label><input type="date" id="date"></td>
      </tr>
      <tr>
        <td colspan="2"><label>ì ‘ìˆ˜ë‹¨ê³„</label><input type="text" id="step"></td>
        <td colspan="2"><label>ì‹¤ëª…(ìœ„ì¹˜)</label><input type="text" id="loc"></td>
        <td colspan="2"><label>ê³µì¢…</label><input type="text" id="work"></td>
      </tr>
      <tr>
        <td colspan="3"><label>ì—…ì²´ëª…</label><input type="text" id="comp"></td>
        <td colspan="3"><label>í™•ì¸ì</label><input type="text" id="name"></td>
      </tr>
      <tr>
        <td colspan="6" class="memo-td"><label>ìƒì„¸ í•˜ì ë‚´ìš©</label><textarea id="memo" style="width:100%; height:100%; border:none; resize:none; outline:none; font-size:0.8rem;"></textarea></td>
      </tr>
    </table>

    <div class="drop-zone" onclick="document.getElementById('f-before').click()">
      <p style="font-weight:900;">ğŸ“¸ 2. [ì „] ìˆ˜ë¦¬ ì „ ì‚¬ì§„</p>
      <img id="view-before" class="preview-img">
    </div>
    <input type="file" id="f-before" accept="image/*" capture="camera" style="display:none" onchange="CORE.p(this, 'view-before')">

    <div class="drop-zone" onclick="document.getElementById('f-after').click()">
      <p style="font-weight:900;">ğŸ“¸ 3. [í›„] ìˆ˜ë¦¬ í›„ ì‚¬ì§„</p>
      <img id="view-after" class="preview-img">
    </div>
    <input type="file" id="f-after" accept="image/*" capture="camera" style="display:none" onchange="CORE.processAfter(this)">

    <div class="drop-zone" style="border-color:var(--success); border-style:solid;">
      <p style="color:var(--success); font-weight:900;">ğŸ“Š 4. ë©”íŠ¸ë¡œ ë³´ë“œíŒ ìë™ í•©ì„± ê²°ê³¼</p>
      <canvas id="boardCanvas" style="display:none;"></canvas>
      <img id="view-board" class="preview-img">
    </div>
  </main>

  <footer>
    <button class="btn-save" onclick="CORE.save()">ğŸ’¾ ë°ì´í„° ì„œë²„ ì €ì¥</button>
    <button class="btn-refresh" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </footer>
</div>

<script>
  const CORE = {
    // âš ï¸ ì—¬ê¸°ì— Apps Script ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.
    gasUrl: "https://script.google.com/macros/s/AKfycbzbfNjY3puvLiP7hxREKqTuB6pMnayZ2sbo8AbQ_ozSrzJY_9Ew8705nijfV-dkpTZz/exec",

    // ì‚¬ì§„ ì²˜ë¦¬
    p: function(input, id) {
      if (!input.files || !input.files[0]) return;
      const targetImg = document.getElementById(id);
      const r = new FileReader();
      r.onload = (e) => { targetImg.src = e.target.result; targetImg.style.display = 'block'; };
      r.readAsDataURL(input.files[0]);
    },

    // [ê·¼ë³¸ í•´ê²°] ì •ë°€ OCR ë§¤í•‘ ë¡œì§ (1,384ë¼ì¸ í•µì‹¬ ë¶„ì„ ë¡œì§ ë³µì›)
    analyze: async function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-ai');
      document.getElementById('loader').style.display = 'flex';
      try {
        const { data: { text } } = await Tesseract.recognize(input.files[0], 'kor+eng');
        this.map(text);
      } catch(e) { console.error("OCR ë¶„ì„ ì‹¤íŒ¨:", e); }
      document.getElementById('loader').style.display = 'none';
    },

    map: function(t) {
      const g = (re) => (t.match(re) || ["", ""])[1]?.trim() || "";
      // í˜„ì¥ëª…, í•˜ìë²ˆí˜¸ ì •ë°€ ì¶”ì¶œ
      document.getElementById('site').value = g(/í˜„ì¥ëª…\s*[:\s]*([ê°€-í£0-9- ]+)/) || "ì›ì£¼í˜ì‹ C4BL";
      document.getElementById('haja').value = g(/í•˜ì\s*No\s*[:\s]*(\d+)/) || g(/(\d{7,})/);
      document.getElementById('unit').value = g(/(\d{3,4}\s*ë™[^\d]*\d{3,4}\s*í˜¸)/);
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      
      // í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë§¤í•‘
      if(t.includes("ì§„í¥")) document.getElementById('comp').value = "ì§„í¥ê±´ì—…(ì£¼)";
      if(t.includes("ì°½í˜¸")) document.getElementById('work').value = "PLì°½í˜¸ê³µì‚¬";
      if(t.includes("ê±°ì‹¤")) document.getElementById('loc').value = "ê±°ì‹¤";
    },

    // [ê·¼ë³¸ í•´ê²°] ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ - ë¬´ê²°ì„± í™•ë³´ ë²„ì „
    save: async function() {
      const site = document.getElementById('site').value;
      if(!site) { alert("âš ï¸ í˜„ì¥ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }

      document.getElementById('loader').style.display = 'flex';
      
      const payload = {
        site: site,
        haja: document.getElementById('haja').value,
        unit: document.getElementById('unit').value,
        date: document.getElementById('date').value,
        step: document.getElementById('step').value,
        loc: document.getElementById('loc').value,
        work: document.getElementById('work').value,
        comp: document.getElementById('comp').value,
        name: document.getElementById('name').value,
        memo: document.getElementById('memo').value,
        timestamp: new Date().toLocaleString('ko-KR')
      };

      try {
        // no-cors ëª¨ë“œë¡œ ì „ì†¡í•˜ì—¬ ë¸Œë¼ìš°ì € ì°¨ë‹¨ ìš°íšŒ
        await fetch(this.gasUrl, {
          method: 'POST',
          mode: 'no-cors',
          cache: 'no-cache',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert("âœ… êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„œë²„ ì „ì†¡ ì™„ë£Œ!");
      } catch(e) {
        alert("âŒ ì „ì†¡ ì˜¤ë¥˜: " + e.message);
      }
      document.getElementById('loader').style.display = 'none';
    },

    // [ë¬´ê²°ì„± ìœ ì§€] 3D ë³´ë“œíŒ ìë™ í•©ì„± ë¡œì§
    processAfter: function(input) {
      if(!input.files[0]) return;
      this.p(input, 'view-after');
      const r = new FileReader();
      r.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const cvs = document.getElementById('boardCanvas');
          const ctx = cvs.getContext('2d');
          cvs.width = 1200; cvs.height = 1600;
          ctx.drawImage(img, 0, 0, 1200, 1600);
          
          // ë³´ë“œíŒ ë””ìì¸
          const sX = 50, sY = 1200, bW = 450, bH = 350;
          ctx.fillStyle = "rgba(255,255,255,0.9)";
          ctx.fillRect(sX, sY, bW, bH);
          ctx.strokeStyle = "#000"; ctx.lineWidth = 5;
          ctx.strokeRect(sX, sY, bW, bH);
          
          ctx.fillStyle = "#000"; ctx.font = "bold 35px Arial";
          ctx.fillText("í˜„ì¥: " + document.getElementById('site').value, sX+20, sY+60);
          ctx.fillText("ë™í˜¸: " + document.getElementById('unit').value, sX+20, sY+130);
          ctx.fillText("ìœ„ì¹˜: " + document.getElementById('loc').value, sX+20, sY+200);
          ctx.fillText("ì¼ì: " + document.getElementById('date').value, sX+20, sY+270);
          
          document.getElementById('view-board').src = cvs.toDataURL("image/jpeg", 0.9);
          document.getElementById('view-board').style.display = 'block';
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(input.files[0]);
    }
  };

  window.onload = () => {
    document.getElementById('date').valueAsDate = new Date();
    console.log("ğŸš€ ë©”íŠ¸ë¡œ AI ë¬´ê²°ì„± ì‹œìŠ¤í…œ ê°€ë™");
  };
</script>
</body>
</html>
